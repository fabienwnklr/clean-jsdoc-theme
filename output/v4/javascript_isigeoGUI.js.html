<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="Author" content="Ankit Kumar"><meta name="Description" content="A beautifully crafted theme for jsdoc"><script src="typedef.js"></script><title>javascript/isigeoGUI.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/index.html",locationPathname="",baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)+"index.html"</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body class="light" data-theme="light"><div class="sidebar-container"><div class="sidebar" id="sidebar"><a href="/" class="sidebar-title sidebar-title-anchor">clean-jsdoc-theme</a><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="9OcM_8dCDCqRPRKceeuUD"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-tutoIsigeoLog.html">Utilisation de la fonction isigeoGUI.log</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="lgGw9PfTWgCPVIBbhW-RU"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#activeLayer">activeLayer</a></div><div class="sidebar-section-children"><a href="global.html#addForm">addForm</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#addLayer">addLayer</a></div><div class="sidebar-section-children"><a href="global.html#addLinked">addLinked</a></div><div class="sidebar-section-children"><a href="global.html#changeApp">changeApp</a></div><div class="sidebar-section-children"><a href="global.html#changeMap">changeMap</a></div><div class="sidebar-section-children"><a href="global.html#exportCSVSelection">exportCSVSelection</a></div><div class="sidebar-section-children"><a href="global.html#exportKml">exportKml</a></div><div class="sidebar-section-children"><a href="global.html#exportPng">exportPng</a></div><div class="sidebar-section-children"><a href="global.html#getStrate">getStrate</a></div><div class="sidebar-section-children"><a href="global.html#integrateDXF">integrateDXF</a></div><div class="sidebar-section-children"><a href="global.html#isigeoGUI">isigeoGUI</a></div><div class="sidebar-section-children"><a href="global.html#launchExportSIG">launchExportSIG</a></div><div class="sidebar-section-children"><a href="global.html#launchPHP">launchPHP</a></div><div class="sidebar-section-children"><a href="global.html#launchSQL">launchSQL</a></div><div class="sidebar-section-children"><a href="global.html#log">log</a></div><div class="sidebar-section-children"><a href="global.html#mergeFic">mergeFic</a></div><div class="sidebar-section-children"><a href="global.html#modalAlert">modalAlert</a></div><div class="sidebar-section-children"><a href="global.html#openAccordion">openAccordion</a></div><div class="sidebar-section-children"><a href="global.html#openForm">openForm</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#openIframeDialog">openIframeDialog</a></div><div class="sidebar-section-children"><a href="global.html#openLegend">openLegend</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#openPanel">openPanel</a></div><div class="sidebar-section-children"><a href="global.html#openTB">openTB</a></div><div class="sidebar-section-children"><a href="global.html#printMap">printMap</a></div><div class="sidebar-section-children"><a href="global.html#removeLayer">removeLayer</a></div><div class="sidebar-section-children"><a href="global.html#saveMapAsImg">saveMapAsImg</a></div><div class="sidebar-section-children"><a href="global.html#search">search</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#setToolBar">setToolBar</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">javascript_isigeoGUI.js</h1></header><article><pre class="prettyprint source lang-js"><code>/** Import des types
 * @type {import('../types/isigeo.d')}
 * @type {import('../types/layoutManager.d')}
 * */

/**
 * @licence
 * Copyright(c)  Géomatika, 2002-2022
 * Isigeo v6
 * Contact, infos : fx gamoy, fx.gamoy@geomatika.fr
 * -------------------------------------------------
 * This script is developed by geomatika.fr.
 * Visit us at http://www.geomatika.fr/
 *
 */

/**
 * public/privé
 * privé : les methodes non disponibles dans IsigeoGUI (attention pas de gestion de retrocomptabilité par ex)
 * public : disponible dans isigeoGUI

 * interne/externe:
 * interne : appelable depuis un shortcut
 * externe : appelable après l'inclusion de isigeoAPI.js (public)
 */

var isigeoGUI = (function () {
	//Active le mode strict du compilateur JS du navigateur si compatible (permet de remonter plus d'avertissements très utiles sur le code JS)
	'use strict';

	/* URL du fichier php pour les requêtes XHR */
	var file = 'lib/xhr_isigeo.php';

	var _isigeoGUI = {
		/* URL du fichier php pour les requête XHR */
		file: 'lib/xhr_isigeo.php',
	};

	/**
	 * Attribut &amp; Méthode Public
	 */
	return {
		/* Contient le numéro de version IsiGéo majeur (6 ou 4)*/
		version: '6',
		/* Contient l'URL du domaine si l'on souhaite la surcoucher (utilisé pour le checkSession) */
		domainUrl: '',
		/* Contient le username de l'utilisateur connecté (utilisé pour la reconnexion via iframe si perte de session) */
		user: null,
		/* Contient l'URL vers la console d'administration */
		adminURL: '',
		/* Contient les références des requêtes XHR lancées via la fonction launchSQL */
		launchRequest: [],
		/* Contient le nombre d'objets à afficher par page (utilisé pour l'inforap, DATA,..) */
		nbpp: 15,
		/* Contient le nombre par défaut d'objets à afficher par page */
		defaultNbpp: 15,
		/* Contient la liste des objets décrivant la sélection en cours */
		objSelection: null,
		/* Contient la liste des tables qui sont igorées de la sélection */
		tablesIgnored: [],
		/* Booleen indiquant si la sélection en cours contient de nouveaux objets */
		selectionHasNewValues: true,
		/* Contient le $_SESSION du PHP */
		session: null,
		/* Contient l'URL absolu compléte du domaine IsiGéo (avec alias) */
		root: '',
		/* Contient le format du device actuellement utilisé (smartphone / desktop) */
		hardwareFormat: null,
		/* Booléen indiquant si l'utilisateur est sur un device de type "iPhone" */
		isIPhone: false,
		/* Booléen indiquant si l'utilisateur est connecté à internet ou non */
		offline: null,
		/* Booléen indiquant si IsiGéo est activé (actif une fois que tous les chargements sont finis) */
		enabled: false, 
		/* Contient l'objet de l'onglet en cours de chargement */
		tab: null, 
		/* Contient le nom de l'onglet en cours de chargement (deprecated) */
		currentTabName: null,
		/* Contient l'indice de l'onglet en cours de chargement (deprecated) */
		currentTab: 0, 
		/* Contient le nom du mcd courant */
		mcd: null,
		/* Contient la commande inline paramétrée pour lancer un locate au chargement */
		inlineLocate: null,
		/* Contient le nom du domaine courant */
		domain: null,
		/* Contient la référence de l'objet du sidebar */
		accordionSlidebar: null,
		/* Contient l'objet modal bootstrap utilisé pour les modal de chargement */
		modalWaiting: null,
		/* Contient l'objet modal bootstrap utilisé pour la modal "Profil utilisateur" */
		modalUserProfil: null,
		/* Contient l'objet modal bootstrap utilisé pour la modal "A propos" */
		modalAbout: null,
		modalExportKML: null,
		/* Booléen indiquant si le calcul d'itinéraire est activé */
		routingEnabled: false,
		/* Contient la valeur du sous-titre utilisé pour un résultat Nominatim (deprecated) */
		localiseSubtitle: false,
		/* Contient la liste des paramètres additionnels utilisé pour l'initialisation d'isigeoGUI' */
		paramInit: null,
		/* Booléen indiquant si le device est tactile (utilisé pour la conversion d'event "onclick" en "ontouchend") */
		tactil: false,
		/* Contient le status de l'utilisateur (UTIL / EXPERT / WEB / ADMIN) */
		nature: null,
		/* Contient le status de l'utilisateur (UTIL / EXPERT / WEB / ADMIN) => DOUBLON */
		statut: 'UTIL',
		/* Contient la liste des options du layout paramètrees pour l'utilisateur (utilisé ensuite dans layoutManager.js) */
		layoutOptions: null,
		/* Contient la référence de l'event drag and drop d'un objet inforap dans l'Agenda (pour associer un objet à une intervention) */
		draggableEvent: null,
		/* Contient la référence de toutes les requetes XHR executées par isigeoGUI.js */
		activeRequest: [],
		/* Contient la liste de tous les thèmes disponibles */
		themesAvailable: [],
		/* Contient l'HTML de la ZL d'internationalisation (liste des langues disponibles pour traduire IsiGéo) */
		i18nZL: '',
		/* ?? */
		legend: '',
		/* Contient l'abréviation de la langue actuellement utilisée (ex : fr_FR, en_EN) */
		lang: '',
		/* ID HTML par défaut utilisé pour la création d'un spinner via la fonction isigeoGUI.spinner */
		idSpinner: 'spinner',
		/* Nombre de résultats total de l'inforap courant (utilisé pour isigeoGUI.getInforapContent) */
		nbResult: 0,
		/* Booléen indiquant si la page vient d'être rechargée ou non */
		pageWasRefreshed: false,
		/* Contient la list des tables disponibles sous DATA (utilisé ici si onglet ouvert non ouvert depuis le debut de la session et accès via le requeteur) */
		dataList: null,
		/* Contient l'URL redirigeant vers la matrice cadastrale */
		matcadURL: null,
		/* Option de dépanne utilisé côté metier, permet de définir une commande JS au niveau du mcd qui s'éxécute en boucle jusqu'au changement de carte ou déconnexion */
		refreshInterval: null,
		/* Constantes de LOG utilisées pour définir le niveau d'erreur */
		ERROR: 1,
		WARNING: 2,
		NOTICE: 3,
		INFO: 4,
		/* Contient la liste des tailles d'écritures disponibles pour agrandir le texte d'IsiGéo (sélectionnable via la modal "Profil utilisateur") */
		fontSizeArray: ['80%', '90%', '100%', '110%', '125%', '150%'],
		/* Contient l'index de la taille d'écriture courante */
		currentIndexFont: 2,

		js_files : {},

		bindPostMessage: function () {
			var handleMessage = function (evt) {
				// Dans le cas d'une fonction envoyé en postMessage via l'API en mode iframe.
				if (window.top != window.self &amp;&amp; evt.data === 'isready' &amp;&amp; layoutManager.isIsiGeoReady) {
					window.parent.postMessage('ok', '*');
					return;
				}
				// Dans le cas d'une fonction envoyé en postMessage via l'API en mode windowReference.
				else if (window.opener != null &amp;&amp; window.open != window.self &amp;&amp; evt.data == 'isready' &amp;&amp; layoutManager.isIsiGeoReady) {
					window.opener.postMessage('ok', '*');
					return;
				}
				var testOrder = eval(evt.data);
			};
			//IE
			if (window.attachEvent) {
				window.attachEvent('onmessage', handleMessage);
			}
			//IE
			if (document.attachEvent) {
				document.attachEvent('onmessage', handleMessage);
			}
			//firefox
			if (window.addEventListener) {
				window.addEventListener('message', handleMessage, false);
			}
		},

		/**
		 * Exporte la carte en format PNG
		 *
		 * @example isigeoGUI.exportPng();
		 */
		exportPng: function () {
			Viewer.exportPng();
		},

		/**
		 * Fonction permettant d'enregistrer une seleciton multiple dans une fiche
		 *
		 * @param {String!} layer Nom de la table
		 * @param {Srting!} field Nom du champ
		 * @param {(String|Number)!} id Id du champ
		 * @param {Object?} options Options
		 *
		 * @example
		 * isigeoGUI.selectObjects('luminaire', 'id_lum', '1', {
		 *     multi_links: [{ table: 'support' }]
		 * });
		 * @ignore
		 */
		selectObjects: function (layer, field, id, options) {
			const { id: idTable } = isigeoSession.getDefTable(layer);
			// masque la fiche:
			MapCMD.setState('QUERY_SEL');
			layoutManager.dialog.hide();
			//  bascule sur la carte
			if (!layoutManager.isModuleVisible('viewer')) {
				layoutManager.openPanel('viewer');
			}
			var values = [];
			var prefixeSelector = '';
			try {
				if (layoutManager.getAffichage(layer) == 'panel') {
					prefixeSelector = '#form';
				} else {
					var idSelector = id;

					if (typeof document.forms.main.idpere != 'undefined' &amp;&amp; document.forms.main.idpere.value != null &amp;&amp; document.forms.main.idpere.value != '') {
						idSelector = document.forms.main.idpere.value;
					}
					if ($jq('.inforap-title').length > 1) {
						prefixeSelector = '#container_' + idTable + '_' + id;
					} else {
						prefixeSelector = '#' + idTable + '_' + idSelector;
					}
				}
				values = $jq.parseJSON($jq(prefixeSelector + ' input[name=' + field + ']').attr('data'));
			} catch (e) {}
			MapCMD.enableSelectionAdding(null, true);
			Viewer.setTextOverlayViewer('Chargement du module sélection en cours...');
			Viewer.showOverlayViewer();
			//  active le mode selection multiple
			MouseQuery.selectObjects(
				layer,
				id,
				values,
				options,
				function (oldValues) {
					// confirmer
					// reinitialise le module de seleciton multiple
					MouseQuery.selectObject = false;
					MapCMD.disableSelectionAdding();
					var countValues = 0;
					var values = [];
					if (isigeoGUI.objSelection == null) {
						for (var i = 0; i &lt; oldValues.length; i++) {
							oldValues[i].ids = [];
						}
						values = oldValues;
						$jq(prefixeSelector + ' #' + field + '_counter').text(0);
					} else {
						var keys = Object.keys(isigeoGUI.objSelection);
						for (let i = 0; i &lt; oldValues.length; i++) {
							values[i] = {};
							//Permet de faire transiter le nom des tables de liaison, qu'on perd pendant le traitement pour l'affichage des données
							values[i].table = oldValues[i].table;
							values[i].table_liee = oldValues[i].table_liee;
							values[i].ids = [];
							if (
								typeof isigeoGUI.objSelection[oldValues[i].table_liee] != 'undefined' &amp;&amp;
								typeof isigeoGUI.objSelection[oldValues[i].table_liee].values != 'undefined'
							) {
								for (var j = 0; j &lt; isigeoGUI.objSelection[oldValues[i].table_liee].values.length; j++) {
									values[i].ids.push(isigeoGUI.objSelection[oldValues[i].table_liee].values[j].id);
									countValues++;
								}
							}
						}
						$jq(prefixeSelector + ' #' + field + '_counter').text(countValues);
					}
					$jq('#container-multilink-obj-count').remove();
					Viewer.clearSelection();
					// Ouvre la fiche d'origine en modif
					layoutManager.dialog.show();
					// sauvegarde les données selectionnées
					Query.saveMultiObjects(layer, id, field, values);
					// maj la fiche
					$jq(prefixeSelector + ' input[name=' + field + ']').attr('data', JSON.stringify(values));
					layoutManager.closeAdvancedFooter();
					isigeoGUI.resetSelectionMarkers();
					isigeoGUI.objSelection = null;
					MapCMD.setState('QUERY');
				},
				function () {
					// annuler
					MouseQuery.selectObject = false;
					MapCMD.disableSelectionAdding();
					$jq('#container-multilink-obj-count').remove();
					Viewer.clearSelection();
					layoutManager.dialog.show();
					layoutManager.closeAdvancedFooter();
					isigeoGUI.objSelection = null;
					MapCMD.setState('QUERY');
				}
			);
		},

		//Appel vers la fonction (dans layoutManager.js) ouvrant la carte secondaire
		openPanelCarteSecondaire: function () {
			layoutManager.openPanelCarteSecondaire();
		},

		/**
		 * Localise le/les objet(s)
		 *
		 * @param {String!} layer Nom de la table
		 * @param {String!} field Nom du champ
		 * @param {(String|Number)!} id identifiant du champ
		 *
		 * @example isigeoGUI.locateObject('support', 'id', '1');
		 * @ignore
		 **/
		locateObjects: function (layer, field, id) {
			const { id: idTable } = isigeoSession.getDefTable(layer);
			// masque la fiche:
			//layoutManager.dialog.hide();
			//  bascule sur la carte
			if (!layoutManager.isModuleVisible('viewer')) {
				layoutManager.openPanel('viewer');
			}
			var prefixeSelector = '';
			if (layoutManager.getAffichage(layer) == 'panel') {
				prefixeSelector = '#form';
			} else {
				var idSelector = id;

				if (typeof document.forms.main.idpere != 'undefined' &amp;&amp; document.forms.main.idpere.value != null &amp;&amp; document.forms.main.idpere.value != '') {
					idSelector = document.forms.main.idpere.value;
				}
				if ($jq('.inforap-title').length > 1) {
					prefixeSelector = '#container_' + idTable + '_' + id;
				} else {
					prefixeSelector = '#' + idTable + '_' + idSelector;
				}
			}
			var values = [];
			try {
				values = $jq.parseJSON($jq(prefixeSelector + ' input[name=' + field + '__locate]').attr('data'));
			} catch (e) {}

			// create options layers
			var optionsLayers = [];
			for (var i = 0; i &lt; values.length; i++) {
				// Si la table n'est pas dans l'objet deftable ou qu'elle n'a pas d'ids lié on génère pas l'objet
				if (typeof isigeoSession.defTables[values[i].table] == 'undefined' || values[i].ids.length === 0) continue;

				optionsLayers[i] = {};
				optionsLayers[i].type = 'sql';
				optionsLayers[i].layername = values[i].table;
				optionsLayers[i].localisation = 'surbrillance';
				optionsLayers[i].majextent = 'Y';
				optionsLayers[i].where = isigeoSession.defTables[values[i].table].idunique + ' in (';
				for (var j = 0; j &lt; values[i].ids.length; j++) {
					if (j > 0) optionsLayers[i].where += ',';
					optionsLayers[i].where += values[i].ids[j];
				}
				optionsLayers[i].where += ')';
			}
			Viewer.locateMap(optionsLayers, null);
		},

		/**
		 * recupere les inforaps pour une liste des de table et d'id passé en parametre
		 *
		 * @param {Object} values Objet de valeurs
		 * @param {String|Number} id identifiant inique
		 * @param {Function} cb Callback
		 *
		 * @ignore
		 */
		getMultiInforap: function (values, id, cb) {
			var param = 'cmd=getMulti&amp;multiLink=true&amp;PrevStateKey=' + document.forms.main.PrevStateKey.value + '&amp;values=' + JSON.stringify(values) + '&amp;idunique=' + id;
			//On fait l'ajax
			var ar_getMultiInforap = $jq.ajax({
				method: 'POST',
				url: file,
				data: param,
				async: true,
				success: function (res) {
					var part = checkAjaxStatus('~', res, this);

					if (!part) {
						return false;
					}

					var ret = [];
					ret = $jq.parseJSON(res);
					if (typeof cb == 'function') {
						cb(ret);
					}
				},
			});
		},

		initButton: function (param, callback) {
			//Vue qu'on a pas encore les outils carto par default on met QUERY
			MouseQuery.cmd = 'QUERY';
			MouseQuery.allowClickQuery = true;
		},

		showApplications: function () {
			var content = '&lt;div class="container-fluid mt-0">';
			if (isigeoGUI.applicationsMCD.length == 0) {
				content += isigeoGUI.getInforapContentEmpty();
			} else {
				content += '&lt;div class="row">';
			}
			for (var i = 0; i &lt; isigeoGUI.applicationsMCD.length; i++) {
				var btnSm = isigeoGUI.hardwareFormat === 'smartphone' ? 'btn-sm' : '';
				content += `
				&lt;div class="col p-1">
				&lt;button type="button" onclick="Query.dialogChoice.destroy(true,function(){isigeoGUI.changeApp('${isigeoGUI.applicationsMCD[i].mcd}','${isigeoGUI.applicationsMCD[i].domain}')});" 
					class="btn btn-sm btn-light w-100 h-100 border shadow d-flex flex-column align-items-center ${btnSm}">
						&lt;img src="${isigeoGUI.applicationsMCD[i].icon}" class="mt-auto ico-lg">
						&lt;p class="mb-0 mt-auto">
							${isigeoGUI.applicationsMCD[i].title}
						&lt;/p>
				&lt;/button>
				&lt;/div>`;
			}

			content += '&lt;/div>&lt;/div>';

			content += '&lt;/div>';
			var contentFooter = '&lt;div class="w-100">&lt;/div>';
			contentFooter += '&lt;button type="button" onClick="Query.dialogChoice.destroy();" class="btn btn-light text-primary">';
			contentFooter += 'Fermer';
			contentFooter += '&lt;/button>';

			Query.dialogChoice = new IsiModal({
				id: 'select-object',
				content: content,
				title: 'Applications',
				footer: contentFooter,
				notClose: true,
				verticalCenter: true,
			});
		},

		resetSelectionMarkers: function (lastResult) {
			if (typeof Localise != 'undefined') {
				Localise.isMarkerNumeroActive = false;
			}
			MouseQuery.markersMap = [];
			if (MouseQuery.layerSelectionMarker != null) {
				MouseQuery.layerSelectionMarker.getSource().clear();
			}
		},

		manageTablesIgnored: function (data) {
			for (var i = 0; i &lt; isigeoGUI.tablesIgnored.length; i++) {
				var table = isigeoGUI.tablesIgnored[i];
				if (typeof data[table] != 'undefined' &amp;&amp; data[table]) {
					delete data[table];
				}
			}
			return data;
		},

		manageSelectionContent: function (options) {
			if (typeof options == 'undefined') {
				options = {};
			}
			var hidePanelSidebar = function () {
				//$jq('#selection').hide();
				$jq('.ol-btn-vider-selection').hide();
				/*if (layoutManager.activeSidebar != null &amp;&amp; layoutManager.activeSidebar.url == "selection.php") {
					layoutManager.accordionSlidebar.slidebars.close();
				}
				isigeoGUI.objSelection = null;
				isigeoGUI.resetSelectionMarkers();
				layoutManager.myAccordion['selection_div'].savedHTML = null;*/
			};

			if (typeof options.showIcons != 'undefined') {
				if (options.showIcons &amp;&amp; isigeoGUI.objSelection != null) {
					var content = typeof options.addContent != 'undefined' &amp;&amp; options.addContent ? options.addContent : '';
					/*if(content == ''){
						hidePanelSidebar();
					}*/
					//$jq('#selection').show();
					$jq('.ol-btn-vider-selection').show();

					/*	if (layoutManager.activeSidebar === null || layoutManager.activeSidebar.url !== "selection.php") {
							layoutManager.myAccordion['selection_div'].contentToAdd = {target : '#selection_container', content : content};
							layoutManager.myAccordion['selection_div'].savedHTML = null;
							if(typeof options.showSidebar == "undefined" || options.showSidebar){
								layoutManager.showSidebarElement('selection_div');
							}
	
						}
						else{
							$jq('#selection_container').html(content);
						}*/
				} else {
					hidePanelSidebar();
				}
			}
		},

		/**
		 * Fonction qui permet de merger les objets
		 *
		 * @param {Object} oldJson
		 * @param {Object} newJson
		 *
		 * @returns {Object}
		 *
		 * @ignore
		 */
		mergeSelectionJson: function (oldJson, newJson) {
			var saveOldJson = oldJson;
			var keysOldJson = Object.keys(oldJson);
			var keysNewJson = Object.keys(newJson);
			var hasValues = false;
			var objRet = {};
			var hasNewValues = false;
			for (var i = 0; i &lt; keysNewJson.length; i++) {
				//Si on a des objets de la table en cours dans notre ancien JSON, on va verifier que les objets sélectionnés ne sont pas déjà dans la selection
				if (typeof oldJson[keysNewJson[i]] != 'undefined') {
					//Recupération de tous les ID deja selectionné pour la table
					var arrayOldId = [];
					var arrayNewId = [];

					for (let j = 0; j &lt; oldJson[keysNewJson[i]].values.length; j++) {
						arrayOldId.push(oldJson[keysNewJson[i]].values[j].id);
					}

					//Si ID du nouvel objet pas sélectionné, on l'ajoute dans notre json
					for (let j = 0; j &lt; newJson[keysNewJson[i]].values.length; j++) {
						arrayNewId.push(newJson[keysNewJson[i]].values[j].id);

						var indexValue = $jq.inArray(newJson[keysNewJson[i]].values[j].id, arrayOldId);
						if (indexValue == -1) {
							oldJson[keysNewJson[i]].values[oldJson[keysNewJson[i]].values.length] = newJson[keysNewJson[i]].values[j];
							if (typeof newJson[keysNewJson[i]].values[j].idMarker != 'undefined' &amp;&amp; newJson[keysNewJson[i]].values[j].idMarker != null) {
								const marker = MouseQuery.markersMap[newJson[keysNewJson[i]].values[j].idMarker];
								if (marker &amp;&amp; marker.values) {
									marker.values.push(newJson[keysNewJson[i]].values[j]);
								}
							}
							hasNewValues = true;
						} else {
							/*if (oldJson[keysNewJson[i]].values[indexValue] &amp;&amp; typeof oldJson[keysNewJson[i]].values[indexValue].id != 'undefined') {
								$jq('#inforap_table #container_inforap_' + keysNewJson[i] + '_' + oldJson[keysNewJson[i]].values[indexValue].id).remove();
								var nbObjLayer = parseInt($jq('#nb_result_' + keysNewJson[i]).text());
								if (nbObjLayer &lt;= 0) {
									$jq('#' + keysNewJson[i]).remove();
									$jq('#tooltip_' + keysNewJson[i]).remove();
									$jq('#container_result_' + keysNewJson[i]).remove();
								} else {
									$jq('#nb_result_' + keysNewJson[i]).text(nbObjLayer - 1);
								}
							}
							if (
								typeof oldJson[keysNewJson[i]].values != 'undefined' &amp;&amp;
								typeof oldJson[keysNewJson[i]].values[indexValue] != 'undefined' &amp;&amp;
								typeof oldJson[keysNewJson[i]].values[indexValue].idMarker != 'undefined' &amp;&amp;
								typeof MouseQuery.markersMap[oldJson[keysNewJson[i]].values[indexValue].idMarker] != 'undefined'
							) {
								var indexMarker = MouseQuery.markersMap[oldJson[keysNewJson[i]].values[indexValue].idMarker].values.findIndex(
									obj => obj.id === oldJson[keysNewJson[i]].values[indexValue].id
								);
								MouseQuery.markersMap[oldJson[keysNewJson[i]].values[indexValue].idMarker].values.splice(indexMarker, 1);
								MouseQuery.checkMarkerHasObj(oldJson[keysNewJson[i]].values[indexValue].idMarker);
							}
							oldJson[keysNewJson[i]].values.splice(indexValue, 1);*/

							if (
								typeof Viewer != 'undefined' &amp;&amp;
								typeof Viewer.locateOnAddSelection[keysNewJson[i]] != 'undefined' &amp;&amp;
								Viewer.locateOnAddSelection[keysNewJson[i]]
							) {
								Viewer.locateSelectionTable(
									keysNewJson[i],
									{
										centerOnLocate: false,
									},
									oldJson
								);
							}
						}
					}

					const arrayAllId = [...arrayOldId, ...arrayNewId];

					if ($jq(`#print_all_${keysNewJson[i]}`).length > 0) {
						const fnSplited = $jq(`#print_all_${keysNewJson[i]}`).attr('onclick').split("'");
						fnSplited[11] = arrayAllId.toString();
						const fnWithNewId = fnSplited.join("'");

						$jq(`#print_all_${keysNewJson[i]}`).attr('onclick', fnWithNewId);
					} else if (typeof newJson[keysNewJson[i]].printAllDocs !== 'undefined' &amp;&amp; newJson[keysNewJson[i]].printAllDocs !== '') {
						const el = $jq(newJson[keysNewJson[i]].printAllDocs);
						const fnSplited = el.attr('onclick').split("'");
						fnSplited[11] = arrayAllId.toString();
						const fnWithNewId = fnSplited.join("'");

						el.attr('onclick', fnWithNewId);

						oldJson[keysNewJson[i]].printAllDocs = el[0].outerHTML;
					}
				}
				//Si on a aucun objet de la table en cours dans notre ancien json, on ajoute toute l'entrée du nouveau JSON de cette table sans se poser de question
				else {
					oldJson[keysNewJson[i]] = newJson[keysNewJson[i]];
					for (var j = 0; j &lt; oldJson[keysNewJson[i]].values.length; j++) {
						try {
							MouseQuery.markersMap[oldJson[keysNewJson[i]].values[j].idMarker].values.push(oldJson[keysNewJson[i]].values[j]);
						} catch (e) {}
					}
					hasNewValues = true;
				}

				if (oldJson[keysNewJson[i]].values.length > 0) {
					hasValues = true;
				} else {
					delete oldJson[keysNewJson[i]];
				}
			}

			if (hasValues) {
				objRet.objSelection = oldJson;
			} else {
				objRet.objSelection = saveOldJson;
			}

			objRet.hasNewValues = hasNewValues;
			isigeoGUI.selectionHasNewValues = hasNewValues;
			return objRet;
		},

		/**
		 * Ouvre la fenêtre "à propos"
		 * @ignore
		 */
		about: function () {
			var param = {
				cmd: 'aboutGeomatika',
			};

			$jq.ajax({
				url: file,
				type: 'POST',
				data: param,
				dataType: 'html',
				success: function (res, textStatus, jqXHR) {
					var part = checkAjaxStatus('~', res, this);
					if (!part) {
						return false;
					}

					isigeoGUI.modalAbout = new IsiModal({
						id: 'about-dialog',
						title: "A propos de l'application",
						content: res,
						closeBtn: true,
						verticalCenter: true,
						callback: () => delete isigeoGUI.modalAbout,
					});

					$jq('#IsiModal-about-dialog .modal-dialog').addClass('container-fluid');
					$jq('#IsiModal-about-dialog .modal-title').addClass('small');
				},
			});
		},

		/**
		 * Affiche les valeurs des clé du json qui correspondent avec le nom des id du DOM du html ciblé
		 *
		 * @param  {object} jsonData objet js d'un json contenant des données à afficher
		 * @ignore
		 */
		jsonToForm: function (jsonData) {
			//Key des arrays contenue dans le json
			for (var key in jsonData) {
				//Données contenue dans l'array que l'on pointe
				var keyContent = jsonData[key];
				if (jsonData.hasOwnProperty(key)) {
					if (keyContent.typechamps == 'CHAR') {
						$jq('#' + keyContent.name).append(keyContent.value);
					} else if (keyContent.typechamps == 'FIC') {
						$jq('#' + keyContent.name).attr('src', keyContent.value);
					} else {
						alert("Une erreur c'est produit lors du chargement de vos données.");
					}
				} else {
					alert("Une erreur c'est produit lors du chargement de vos données.");
				}
			}
		},

		/**
		 * Ouvre la fenêtre profil utilisateur
		 * @ignore
		 */
		userProfil: function () {
			if ($jq('#window_userprofil').length &lt;= 0) {
				var param = {
					cmd: 'getUserProfil',
				};
				var cordova = null;
				if (typeof cordova !== undefined &amp;&amp; cordova !== null) {
					//On simule qu'on récupère le json depuis une BDD locale, comme pour l'appli mobile
					var jsonUserProfil = [
						{
							name: 'avatar',
							typechamps: 'FIC',
							value: 'http://isigeo42.geomatika.fr/releves/demo/isigeo_demo/153.jpg',
						},
						{
							name: 'username',
							typechamps: 'CHAR',
							value: 'Cordova_User',
						},
						{
							name: 'courriel',
							typechamps: 'CHAR',
							value: 'maximehelias@hotmail.fr',
						},
						{
							name: 'tel',
							typechamps: 'CHAR',
							value: '+33682672720',
						},
						{
							name: 'commentaire',
							typechamps: 'CHAR',
							value: 'Compte démo 42',
						},
					];

					if (typeof jsonUserProfil.status !== "undefined" &amp;&amp; jsonUserProfil.status == false) {
						var userPage = `
						&lt;div class="container-fluid">
							&lt;div class="row">
								&lt;div class="col-md-12">
									&lt;p>Impossible de récupérer l\'utilisateur.&lt;br/>&lt;/p>
								&lt;/div>
							&lt;/div>
						&lt;/div>
						`;
						document.open();
						document.write(userPage);
						document.close();
					} else {
						$jq.get('view/userProfil', function (data) {
							var part = checkAjaxStatus('~', data, this);

							if (!part) {
								return false;
							}
							//L'affichage ne doit pas se faire dans une fenêtre boostrap avec Cordova
							document.open();
							document.write(data);
							document.close();
							isigeoGUI.jsonToForm(jsonUserProfil);
						});
					}
				} else {
					$jq.ajax({
						url: file, // adresse à laquelle la requete est envoyée
						type: 'POST', // type de requete pour récuperer mes données
						data: param, // les données que nous souhaitons renvoyer
						success: function (res, textStatus, jqXHR) {
							var part = checkAjaxStatus('~', res, this);
							if (!part) {
								return false;
							}
							var jsonUserProfil = JSON.parse(res);

							//	Si on ne recupère pas le user
							if (jsonUserProfil.status !== false) {
								$jq.get('view/userProfil.html', function (data) {
									var part = checkAjaxStatus('~', data, this);

									if (!part) {
										return false;
									}
									//Si on autorise l'edition de cette fiche, on ajoute un bouton "Editer mon profil"

									/*if(jsonToto[0].value == "modif"){
										userPage+='&lt;button id="mode" type="button" style="margin:5px;" class="btn btn-secondary add-padding" onclick="Query.mode = \'DIALOG\';">&lt;span class="glyphicon glyphicon-edit">&lt;/span> Editer mon profil&lt;/button>';
									}*/
									isigeoGUI.modalUserProfil = new IsiModal({
										id: 'window_userProfil',
										title: 'Profil utilisateur',
										content: data,
										closeBtn: true,
										verticalCenter: true,
										callback: () => delete isigeoGUI.modalUserProfil,
									});

									//	On créer les champs un à un pour toutes les infos à afficher
									let html = '&lt;ul class="list-group">';
									for (var key in jsonUserProfil) {
										var keyContent = jsonUserProfil[key];
										if (keyContent.typechamps == 'FIC') {
											html = `
											&lt;div class="text-center">
												&lt;img id="${keyContent.name}" src="" class="img-thumbnail add-margin" alt="" style="height: 135px;width:135px;padding:5px;"/>
											&lt;/div>`;
											var cheminImg = keyContent.value;
											var extension = cheminImg.substring(cheminImg.length - 4);
											if (extension != '.jpg' &amp;&amp; extension != '.png') {
												keyContent.value = 'images/anonymous2.png';
											}

											$jq('#avatarContainer').prepend(html);
										} else if (keyContent.typechamps == 'CHAR') {
											html = `
											&lt;li class="list-group-item list-group-item-light d-flex align-items-center white-space-nowrap">
												&lt;span class="${keyContent.glyphicon}">&lt;/span>
												&lt;span class="mx-2">${keyContent.libelle} : &lt;/span>
												&lt;span id="${keyContent.name}">&lt;/span>
											&lt;/li>`;
											if (parseInt(key) === jsonUserProfil.length - 1) {
												html += '&lt;/ul>';
											}
											$jq('#IsiModal-window_userProfil #container').append(html);
										} else {
											alert("Une erreur c'est produit lors du chargement de vos données.");
										}
									}

									// On remplie les champs du profil utilisateur
									isigeoGUI.jsonToForm(jsonUserProfil);

									// Si on à l'objet en storage c'est qu'on est en dark mode
									if (localStorage.getItem('isigeo-theme') !== null &amp;&amp; localStorage.getItem('isDarkMode') === 'true') {
										$jq('#darkOrLight').attr('checked', true);
									}

									$jq('#font-app').val(isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont]);
									$jq('#IsiModal-window_userProfil .btn-decrement').on('click', function (event) {
										if (typeof isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont - 1] == 'undefined') {
											return;
										}
										$jq('html').css('font-size', isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont - 1]);
										$jq('#font-app').val(isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont - 1]);
										isigeoGUI.currentIndexFont--;
									});
									$jq('#IsiModal-window_userProfil .btn-increment').on('click', function (event) {
										if (typeof isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont + 1] == 'undefined') {
											return;
										}
										$jq('html').css('font-size', isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont + 1]);
										$jq('#font-app').val(isigeoGUI.fontSizeArray[isigeoGUI.currentIndexFont + 1]);
										isigeoGUI.currentIndexFont++;
									});
								});
							} else {
								isigeoGUI.modalUserProfil = new IsiModal({
									id: 'window_userProfil',
									title: 'Profil utilisateur',
									content:
										'&lt;div class="container-fluid">&lt;div class="row">&lt;div class="col-md-12">&lt;p>Impossible de récupérer l\'utilisateur.&lt;br/>&lt;/p>&lt;/div>&lt;/div>&lt;/div>',
									closeBtn: true,
									verticalCenter: true,
									callback: () => delete isigeoGUI.modalUserProfil,
								});
							}
						},
						error: function () {
							alert(
								"Une erreur est survenue lors du chargement de vos données. Vérifiez votre connection internet puis relancez l'opération ou contactez votre administrateur en cas d'échecs successifs."
							);
						},
					});
				}
			}
		},

		/**
		 * Fonction generique d'export CSV
		 *
		 * @param {string} table Table à exporter
		 * @param {Event} event Evenement (click, etc)
		 *
		 * @ignore
		 */
		exportCSV: function (table, event) {
			if (event &amp;&amp; event instanceof Event) {
				event.stopPropagation();
				event.preventDefault();
			}

			const url = `csv.php?layerref=${table}&amp;session=ficCSV&amp;format=csv&amp;colToExclude=${DataGUI.colToExclude}`;
			document.location.href = url;
		},

		/**
		 * Export au format CSV la selection
		 *
		 * @param {String!} table Nom de la table
		 * @param {String=} whereSQL Clause SQL WHERE
		 * @param {Number=} limit limite de la requête
		 * @param {Boolean=} [exportPublipostage=false] limite de la requête
		 *
		 * @example
		 * isigeoGUI.exportCSVSelection('support', 'id_support = 1', 10);
		 */
		exportCSVSelection(table, whereSQL, limit, exportPublipostage = false) {
			const format = exportPublipostage ? 'publi' : 'csv';
			const { responseText } = $jq.ajax({
				url: 'csv.php',
				type: 'POST',
				async: false,
				data: {
					layerref: table,
					session: 'ficCSV',
					isSelection: true,
					format,
					whereSQL,
					limit,
					exportPublipostage,
					getUrlFile: true,
				},
			});

			if ($jq('#isiToast-_exportCSV_' + table).length !== 0) {
				$jq('#isiToast-_exportCSV_' + table).toast('hide');
			}

			window.open(responseText);
			// var url = 'csv.php?layerref=' + table + '&amp;session=ficCSV&amp;isSelection=true&amp;format=' + format + '&amp;whereSQL=' + whereSQL + '&amp;limit=' + limit;
			// window.open(url);
		},

		/**
		 * Va RAZ un certain nombre de variable pour créer un nouvel environnement propre
		 * @ignore
		 */
		resetSession: function () {},

		/**
		 * Function pour insérer le script CKEDITOR dans le DOM
		 * @ignore
		 */
		initCKEDITOR: function () {
			if (typeof CKEDITOR === 'undefined') {
				// On init un path pour le plugin car sinon il le génère lui même (et mal dans certains cas)
				const ckPath = '/extras/ckeditor/';
				const scriptElement = document.createElement('script');
				const version = document.location.pathname.startsWith('//') ? document.location.pathname.split('/')[2] : document.location.pathname.split('/')[1];

				let url = `${location.protocol}//${location.host}`;

				if (version.search('.php') != -1) {
					scriptElement.src = '/extras/ckeditor/ckeditor.js';
				} else {
					url += `/${version}`;
					scriptElement.src = isigeoGUI.isApps ? `${url}/extras/ckeditor/ckeditor.js` : `/${version}/extras/ckeditor/ckeditor.js`;
				}
				url += ckPath;
				window.CKEDITOR_BASEPATH = url;
				document.body.appendChild(scriptElement);
			}
		},

		/**
		 * Ajoute un objet en base et ouvre le formulaire correspondant.
		 * @externe Appelable depuis Isigeo_API
		 *
		 * @param {String!} tableId Nom ou identitiant de la table
		 * @param {AddFormOpts=} [options={}] Objet d'options
		 *
		 * @example
		 * isigeoGUI.addForm('support', {
		 *     values: {
		 *       "monChamp": "maValeur"
		 *     },
		 *     gps: true,
		 *     activeLayer: false,
		 *     forceAlpha: true,
		 *     accordionDraw: 'hide',
		 *     hideForm: false,
		 *     hideDialog: false,
		 *     callbackSave: () => console.log('test'),
		 *     notif: { text: 'Hey', type: 'success', duration: 1000}
		 *     addLinked: { linkedField: 'dpv_dispo_numdossier', getLastLinkedField: true, getFilsLastLinkedField: true }
		 * })
		 *
		 */
		addForm(tableId, options) {
			const objDefTable = Object.values(isigeoSession.defTables).find(table => table.id == tableId || table.nom === tableId) || isigeoSession.getDefTable(tableId);
			const libelleTable = objDefTable.libelle;
			const affichage = layoutManager.getAffichage(objDefTable.nom);
			const nature = objDefTable.nature;

			const afterJSFormLoaded = function () {
				var layerName = '';
				if (typeof tableId == 'number') {
					// Recupere le nom de la table a partir de son identifiant unique
					$jq.ajax({
						url: file,
						type: 'POST',
						data: 'cmd=getLayerName&amp;tableId=' + tableId,
						async: false,
						success: function (serverResponse) {
							var part = checkAjaxStatus('~', serverResponse, this);

							if (!part) {
								return false;
							}

							if (serverResponse.split('~')[0] != '') {
								layoutManager.modalAlert("l'identifiant de la couche est invalide.");
								return;
							}
							layerName = serverResponse.split('~')[1];
							if (typeof Postgis != 'undefined') {
								Postgis.setTable(layerName);
							}
						},
					});
				} else if (typeof tableId == 'string') {
					layerName = tableId;
					if (typeof Postgis != 'undefined') {
						Postgis.setTable(layerName);
					}
				} else {
					layoutManager.modalAlert("Erreur: Vous devez renseigner l'identifiant ou le nom d'une couche dans la fonction addForm");
					return;
				}

				if (layerName == '') {
					layoutManager.modalAlert("Erreur: Vous devez renseigner l'identifiant d'une couche dans la fonction addForm");
					return;
				}

				if (options.addLinked &amp;&amp; typeof options.addLinked === 'object') {
					const { linkedField, getLastLinkedField, getFilsLastLinkedField } = options.addLinked;
					add_linked(layerName, linkedField, getLastLinkedField, getFilsLastLinkedField);
					return;
				}

				var afterCheckGPS = function (layerName, options) {
					var getObjectInfosCallback = function (serverResponse, options) {
						if (serverResponse.split('~')[1]) {
							var result = $jq.parseJSON(serverResponse.split('~')[1]);

							if (typeof options.notif == 'object') {
								if (typeof options.notif.text != 'undefined' &amp;&amp; options.notif.text != '' &amp;&amp; options.notif.text != null) {
									var type = 'standard';
									var duration = 2500;
									if (typeof options.notif.type != 'undefined') {
										type = options.notif.type;
									}
									if (typeof options.notif.duration != 'undefined') {
										duration = options.notif.duration;
									}
									alertify.log(options.notif.text, type, duration);
								}
							} else if (typeof options.notif == 'string') {
								alertify.log(options.notif);
							}

							if (typeof options.notif == 'undefined' &amp;&amp; nature == 'GEO' &amp;&amp; options.forceAlpha == false) {
								var libelleGeom = '';
								switch (result.geometryType) {
									case 'POINT':
									case 'MULTIPOINT':
										libelleGeom = 'un point';
										break;

									case 'LINESTRING':
									case 'MULTILINESTRING':
										libelleGeom = 'une ligne';
										break;

									case 'POLYGON':
									case 'MULTIPOLYGON':
										libelleGeom = 'un poylgone';
										break;

									default:
										break;
								}
								alertify.log('Table : ' + libelleTable + '&lt;br> Vous pouvez désormais saisir ' + libelleGeom + ' sur la carte');
							}

							if (options.gps == 'insert') {
								options.values[result.columnGeo] = result.valueGPS;
								if (Gps.rms != null &amp;&amp; Gps.rms != 0 &amp;&amp; result.rms) {
									options.values.isigeo_rms = Gps.rms;
								} else if (Gps.hdop != null &amp;&amp; Gps.hdop != 0 &amp;&amp; result.hdop) {
									options.values.isigeo_hdop = Gps.hdop;
								} else if (Gps.altitude != null &amp;&amp; Gps.altitude != 0 &amp;&amp; result.altitude) {
									options.values.isigeo_altitude = Gps.altitude;
								}
							}

							var launchAdd = function (serverResponse, options) {
								if(layoutManager.isFormDep()){
									$jq('#spinner').hide();
								}
								if (options.gps == 'insert') {
									options.forceAlpha = true;
								}

								if (
									(!options.forceAlpha || options.forceAlpha == null || typeof options.forceAlpha == 'undefined') &amp;&amp;
									nature === 'GEO' &amp;&amp;
									result.geometryType &amp;&amp;
									result.geometryType.length > 0
								) {
									var state = '',
										exit = false;

									switch (result.geometryType) {
										case 'POINT':
										case 'MULTIPOINT':
											state = 'DRAW_POINT';
											break;

										case 'LINESTRING':
											state = 'DRAW_LINESTRING';
											break;

										case 'MULTILINESTRING':
											state = 'DRAW_LINESTRING';
											break;

										case 'POLYGON':
											state = 'DRAW_POLYGON';
											break;

										case 'MULTIPOLYGON':
											state = 'DRAW_POLYGON';
											break;

										default:
											Query.addAlpha(layerName, null, null, null, options.values, options.hideForm, libelleTable, affichage, options.callbackSave);
											exit = true;
											break;
									}

									if (!exit) {
										layoutManager.hideSidebarMobile();

										var afterCheckJSLoaded = function (layerName, options, result, state) {
											Viewer.loadMapTabForData(function () {
												var callbackSetState = function () {
													var checkLayer = Dessin.getLayerIndexByName(layerName);
													if (checkLayer === false) {
														//alertify.log('Vous ne disposez pas des droits pour ajouter un objet sur la couche ' + layerName,'error');
														layoutManager.modalAlert('Vous ne disposez pas des droits pour ajouter un objet sur la couche ' + layerName);
														return;
													}
													Dessin.layerChange(checkLayer);
													Dessin.defaultVals = options.values;
													Dessin.hideFiche = options.hideForm;
													Dessin.affichage = affichage;
													Dessin.libelleTable = libelleTable;

													if (options.activeLayer) {
														try {
															Viewer.activeLayer([
																{
																	name: layerName,
																	status: 'ON',
																},
															]);
														} catch (e) {}
													}
												};
												if (options.accordionDraw == 'hide') {
													Dessin.switchAccordion = false;
												} else {
													Dessin.switchAccordion = true;
													// Ici on renseigne le layer pour init les outils sur la bonne couche
													Dessin.lastSelectedLayer[state.split('_')[1]] = layerName;
												}
												MapCMD.setState(state, callbackSetState);
											});
										};

										if (typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' || !layoutManager.isJSGroupLoaded.viewer) {
											layoutManager.loadJSFile('viewer',function () {
												afterCheckJSLoaded(layerName, options, result, state);
											});
										} else {
											afterCheckJSLoaded(layerName, options, result, state);
										}
									}
								} else {
									layoutManager.hideSidebarMobile();
									Query.addAlpha(layerName, null, null, null, options.values, options.hideForm, libelleTable, affichage, options.callbackSave);
								}
							};

							//On vérifie que le serveur a au moins retourné la nature du layer (preuve que le layer existe)
							if (!nature || nature === '') {
								layoutManager.modalAlert('Couche introuvable');
							}

							// Chargement layout manager viewer ?
							//if(isigeoGUI.getCurrentTab()!='MAP' &amp;&amp; nature == 'GEO' &amp;&amp; (typeof options.forceAlpha == "undefined" || !options.forceAlpha)){
							//On change d'onglet pour la carte
							/*	isigeoGUI.setTabByName('MAP');
							
								setTimeout(function(){
									//On attends que la carte se charge et on declenche la creation de l'objet
									launchAdd(serverResponse,options);
								},2500);
							*/
							//}
							//else{
							launchAdd(serverResponse, options);
							//}
						}
					};

					var triggerObjectCreation = function (options) {
						let sridMap = null;

						if (options.gps == 'insert') {
							sridMap = Viewer.map.getView().getProjection().getCode().substring(5);
						}

						var lon,
							lat = null;
						if (typeof Gps != 'undefined') {
							lon = Gps.lon;
							lat = Gps.lat;
						}

						var params = 'cmd=addObject&amp;layerName=' + layerName + '&amp;gps=' + options.gps + '&amp;xGPS=' + lon + '&amp;yGPS=' + lat + '&amp;sridMap=' + sridMap;

						//On va faire une requete au serveur pour avoir toutes les informations necessaires à propos de cet objet.
						var getObjectInfos = $jq.ajax({
							url: file,
							type: 'POST',
							data: params,
							success: function (serverResponse) {
								var part = checkAjaxStatus('~', serverResponse, this);

								if (!part) {
									return false;
								}

								getObjectInfosCallback(serverResponse, options);
							},
						});
					};

					triggerObjectCreation(options);
				};

				if (options.gps == 'insert') {
					//Callback de la récupération de la position GPS
					var GPSresult = function (ret) {
						if (ret != false) {
							ret = '';
							//Suppression de l'alertify 'Calcul de la position en cours';
							$jq($jq('.alertify-logs > div')[$jq('.alertify-logs > div').length - 1]).remove();
							ret += 'Votre position actuelle: &lt;br>';
							ret += 'Latitude : ' + Gps.lat + '&lt;br>';
							ret += 'Longitude: ' + Gps.lon + '&lt;br>';
							ret += 'Precision : ' + (Gps.rms > 0 ? Math.round(Gps.rms * 100) / 100 : '--') + ' m &lt;br>';
							alertify.log(ret, 'success');
							if (typeof Viewer != 'undefined') {
								var ajaxScale = $jq.ajax({
									url: file,
									type: 'POST',
									data: 'cmd=getZoomScale&amp;layer=' + layerName,
									async: false,
								});

								var res = ajaxScale.responseText;

								var part = checkAjaxStatus('~', res);

								if (!part) {
									return false;
								}

								var scale = 1000;
								if (res.split('~')[1] &amp;&amp; res.split('~')[1] != '') {
									scale = res.split('~')[1];
								}
								//Initialisation du layer indiquant notre position
								Gps.initLayers();
								//Refresh de la carte pour afficher le layer
								Gps.refresh(null);
								//Clignotement de notre point indiquant notre position
								Gps.clignoTimer = setInterval(Gps.cligno, 500);
								//Centrage de la carte sur notre position
								Gps.centerMap(scale);
							}

							//Callback ajoutant l'objet + ouverture de la fiche
							afterCheckGPS(layerName, options);
						}
					};
					Gps.livetracking = navigator.geolocation;
					alertify.log('Calcul de la position en cours', 'success');
					Gps.getCoord(GPSresult);
				} else {
					afterCheckGPS(layerName, options);
				}
			};

			if (typeof Dessin != 'undefined' &amp;&amp; Dessin.defaultVals != null) {
				Dessin.defaultVals = null;
			}

			// envoyer depuis isigeo_api avec json.stringify
			if (typeof options == 'string') {
				try {
					options = JSON.parse(options);
				} catch (e) {
					options = {};
				}
			}
			if (typeof options == 'undefined' || options == null) {
				options = {};
			}

			// if (typeof layoutManager.windowManager !== 'undefined' &amp;&amp; options.hideDialog !== false) {
			// 	layoutManager.windowManager.minimizeAll();
			// }

			if (
				typeof Dessin != 'undefined' &amp;&amp;
				Dessin.mode != null &amp;&amp;
				MapCMD.current.cmd != null &amp;&amp;
				MapCMD.current.cmd != '' &amp;&amp;
				typeof MapCMD.current.cmd != 'undefined'
			) {
				Dessin.clear(MapCMD.current.cmd);
			}

			//PARAMETRE "hideDrawAccordion" => **DEPRECATED**
			if (typeof options.hideDrawAccordion != 'undefined') {
				options.accordionDraw = options.hideDrawAccordion;
			}

			if (typeof options.accordionDraw == 'undefined') {
				options.accordionDraw = false; // Par defaut, on montre les outils de dessins
			}

			if (typeof options.callbackSave == 'undefined') {
				options.callbackSave = null;
			}
			if (typeof options.gps == 'undefined' || (typeof options.gps != 'undefined' &amp;&amp; options.gps == false)) {
				options.gps = 'none';
			} else if (options.gps == true) {
				options.gps = 'insert';
			}

			if (
				(typeof options.defaultVals == 'undefined' || options.defaultVals == null || options.defaultVals == '') &amp;&amp;
				(typeof options.values == 'undefined' || options.values == null || options.values == '')
			) {
				options.values = {};
			} else if (typeof options.defaultVals != 'undefined' &amp;&amp; options.defaultVals != null &amp;&amp; options.defaultVals != '') {
				options.values = options.defaultVals;
			}

			if (typeof options.values != 'object') {
				try {
					options.values = JSON.parse(options.values);
				} catch (e) {
					console.log(e);
				}
			}

			if (typeof options.forceAlpha == 'undefined') {
				options.forceAlpha = objDefTable.nature === 'GEO' ? false : true;
			}
			if (typeof options.forceAlpha == 'string') {
				if (options.forceAlpha === 'true' || options.forceAlpha === 'false' || options.forceAlpha === 'ALPHA') {
					if (options.forceAlpha == 'true') {
						options.forceAlpha = true;
					} else if (options.forceAlpha == 'ALPHA') {
						options.forceAlpha = 'ALPHA';
					} else {
						options.forceAlpha = false;
					}
				} else {
					layoutManager.modalAlert("Erreur: vous devez indiquer true ou false dans l'option forceAlpha de la fonction addForm");
					return;
				}
			} else {
				if (typeof options.forceAlpha != 'boolean' &amp;&amp; options.forceAlpha != null) {
					options.forceAlpha = false;
				}
			}
			// Si on insere un objet, on force l'alpha
			// GeoJSON -> Projection d'entrée EPSG:4326
			/* Exemple : {
				"type": "Feature",
				"geometry": {
					"type": "Point",
					"coordinates": [
					-1.470620,
					43.494843
					]
				},
				"properties": {
					"name": "IsiGeo"
				}
				}
			*/
			if (typeof options.geojson != 'undefined' &amp;&amp; options.geojson != null &amp;&amp; options.geojson != '') {
				options.forceAlpha = true;
				var readGeoJson = new ol.format.GeoJSON().readFeature(options.geojson, {
					dataProjection: 'EPSG:4326',
					featureProjection: Viewer.map.getView().getProjection().getCode(),
				});
				if (typeof readGeoJson != null) {
					var coordsJson = readGeoJson.getGeometry().getCoordinates();
					if (typeof coordsJson != null &amp;&amp; coordsJson.length > 0) {
						options.values.isigeo_geomColumn = coordsJson[0] + ' ' + coordsJson[1];
					}
				}
			}

			if (typeof options.activeLayer === 'undefined') {
				options.activeLayer = true;
			}
			//Chargement des fichiers JS Form si ni viewer ou data de chargé (car ils contiennent deja les fichiers form)
			if (
				typeof layoutManager.isJSGroupLoaded.data == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.form == 'undefined'
			) {
				if (
					typeof isigeoGUI.layers == 'object' &amp;&amp;
					Object.keys(isigeoGUI.layers).length > 0 &amp;&amp;
					typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' &amp;&amp;
					typeof layoutManager.isJSGroupLoaded.data == 'undefined'
				) {
					layoutManager.loadJSFile('form', afterJSFormLoaded);
				} else {
					layoutManager.loadJSFile('form_consult', afterJSFormLoaded);
				}
			} else {
				afterJSFormLoaded();
			}
		},

		/**
		 * Ajoute dans la base une fiche du layer selectionné liée à la fiche actuellement ouverte en consult par le champ selectionné
		 *
		 * @param {String} layerref Le nom de la couche
		 * @param {String} linkedField Le nom du champs lié
		 * @param {Boolean} getLastLinkedField Permet de définir si l'on souhaite recuperer le dernier élément lié
		 * @param {Boolean} getFilsLastLinkedField Permet de récupérer également les fils du dernier élément lié
		 *
		 * @example isigeoGUI.addLinked('ctrl_dpv', 'dpv_dispo_numdossier', true, true);
		 */
		addLinked(layerref, linkedField, getLastLinkedField, getFilsLinkedField) {
			add_linked(layerref, linkedField, getLastLinkedField, getFilsLinkedField);
			return;
		},

		/**
		 * Permet d'ouvrir une fiche
		 * @externe Appelable depuis Isigeo_API
		 *
		 * @param {string!} table  Nom de la table
		 * @param {Number!} id id du formulaire
		 * @param {OpenFormOpts=} [options={}]  Objet d'options
		 * @param {Event=} e Evenement JS
		 *
		 * @example
		 * isigeoGUI.openForm('support', 12, {
		 *   affichage: 'small',
		 *   edit: true,
		 *   valid: true,
		 *   forceValid: false,
		 *   closeLastForm: false,
		 *   hideDialog: false,
		 *   callbackSave: () => console.log('test'),
		 *   focusWindow: true,
		 *   useLastDialog: false,
		 *   back: false,
		 *   notif: { text: 'Hey', type: 'success', duration: 1000}
		 * })
		 */
		openForm: function (table, id, options, e) {
			if (typeof e != 'undefined') {
				// Gestion d'une ouverture de lightview depuis l'onglet données
				if (
					e.target &amp;&amp; e.target.classList.contains('lightview') ||
					e.target.parentElement &amp;&amp; e.target.parentElement.classList.contains('lightview')
				) {
					return;
				} else {
					e.preventDefault();
					e.stopPropagation();
				}
			}

			if (typeof table === 'undefined') {
				layoutManager.modalAlert("Erreur: Vous devez renseigner l'identifiant ou le nom d'une couche dans la fonction addForm");
				return;
			}
			if (typeof id === 'undefined') {
				layoutManager.modalAlert("Erreur: Vous devez renseigner l'identifiant unique du formulaire dans la fonction addForm");
				return;
			}

			if (typeof options == 'string') {
				try {
					options = JSON.parse(options);
				} catch (err) {
					console.error(`Erreur de parsing -> ${err}`);
					options = {};
				}
			}

			if (typeof options == 'undefined') {
				options = {};
			}

			// On passe un pipe || table dans le cas ou on l'objet n'existerais pas ou n'aurait pas de prop "id"
			const idTable = isigeoSession.getDefTable(table).id || table;
			const iduniqueForm = options.idpere ? options.idpere : id;
			const idForm = `${idTable}_${iduniqueForm}`;

			const afterJSFormLoaded = function () {
				const afterLastDialogClosed = function () {
					if(layoutManager.isFormDep()){
						$jq('#spinner').hide();
					}
					if (options.affichage === 'panel') {
						const btnForm = `
								&lt;button id="btn-form" class="btn btn-outline-secondary ml-1">
									&lt;span class="icon icon-view-form ico-h3">&lt;/span>
									&lt;span id="title-form" class="d-none d-md-inline">&amp;nbsp;Formulaire&lt;/span>
								&lt;/button>
							`;
						if ($jq('#btn-form').length === 0) $jq('#navbar-header .dropdown').before(btnForm);

						$jq('#btn-form')
							.off('click')
							.on('click', () => {
								isigeoGUI.openForm(table, id, options, e);
							});

						if (!layoutManager.isModuleVisible('form') &amp;&amp; $jq('#container_' + idForm).length !== 1) {
							layoutManager.openPanel('form');
						} else if ($jq('#container_' + idForm).length === 1) {
							layoutManager.openPanel('form');
							return;
						} else {
							if (!Query.formModif[idForm] || Query.formModif[idForm].dataForm === $jq('#form #fiche_metier').serialize()) {
								Query.startLoader('#form_content');
								$jq('#form').data('table', table);
								$jq('#form').data('idunique', id);
							} else {
								const ignore = () => {
									delete Query.formModif[idForm];
									delete Query.editor[idForm];

									return isigeoGUI.openForm(table, id, options);
								};
								layoutManager.dialogConfirm('', { onAccept: Query.onDeniedUpdateObj, onDenied: ignore });
								return;
							}
						}
					}

					Query.mode = 'DIALOG';

					if (typeof options.notif == 'object') {
						if (typeof options.notif.text != 'undefined' &amp;&amp; options.notif.text != '' &amp;&amp; options.notif.text != null) {
							var type = 'standard';
							var duration = 2500;
							if (typeof options.notif.type != 'undefined') {
								type = options.notif.type;
							}
							if (typeof options.notif.duration != 'undefined') {
								duration = options.notif.duration;
							}
							alertify.log(options.notif.text, type, duration);
						}
					} else if (typeof options.notif == 'string') {
						alertify.log(options.notif);
					}

					try {
						switch (options.edit) {
							//Appel Query.open
							case false:
							case 'false':
								Query.open(table, id, options);

								break;

							//Appel Query.modif
							case true:
							case 'true':
								Query.modif(table, id, options.valid, options.forceValid, false, false, options);

								break;
						}
					} catch (e) {
						layoutManager.manageCatchError(e, 'isigeoGUI.openForm');
						console.error(e);
					}
				};

				// Recupere le nom de la table à partir de l'identifiant unique
				if (typeof table == 'number') {
					table = isigeoSession.getDeftableWhere('id', table)[0].nom
				}

				// PARAMETRE "modif" => **DEPRECATED**
				if (typeof options.modif != 'undefined') {
					options.edit = options.modif;
				}
				if (typeof options.edit == 'undefined') {
					options.edit = false;
				}
				if (typeof options.valid == 'undefined') {
					options.valid = 'Y';
				}
				if (typeof options.forceValid == 'undefined') {
					options.forceValid = false;
				}
				if (typeof options.closeLastForm == 'undefined') {
					options.closeLastForm = false;
				}
				if (typeof options.callbackSave == 'undefined') {
					options.callbackSave = null;
				}
				if (typeof options.focusWindow == 'undefined') {
					options.focusWindow = true;
				}

				if (typeof options.affichage === 'undefined') {
					options.affichage = layoutManager.getAffichage(table);
				}

				if (typeof options.useLastDialog != 'undefined' &amp;&amp; options.useLastDialog &amp;&amp; typeof layoutManager.dialog != 'undefined' &amp;&amp; layoutManager.dialog.id != '') {
					options.id = layoutManager.dialog.id;
				} else {
					options.id = idForm;
				}

				options.table = table;
				options.idunique = id;

				if (options.closeLastForm) {
					layoutManager.dialog.close(afterLastDialogClosed);
				} else {
					afterLastDialogClosed(table);
				}
			};
			if (
				typeof layoutManager.isJSGroupLoaded.data == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.form == 'undefined'
			) {
				layoutManager.loadJSFile('form', afterJSFormLoaded);
			} else {
				afterJSFormLoaded();
			}
		},

		/**
		 *
		 * @param {Object|String} data Données à afficher
		 * @param {OpenOtherFormOpts=} options Objet d'option pour la dialogue
		 *
		 * @ignore
		 */
		openOtherForm(data, options) {
			var afterJSFormLoaded = function () {
				if (typeof options == 'string') {
					try {
						options = JSON.parse(options);
					} catch (e) {
						options = {};
					}
				}

				if (typeof data == 'string') {
					try {
						data = JSON.parse(data);
					} catch (e) {
						data = {};
					}
				}

				options.beforeClose = function (dialogue) {
					dialogue.close();
				};

				//Initialisation de la window
				layoutManager.initWindow(options);

				//Création du body de la fiche
				var content = '';
				var keys = Object.keys(data);
				var srid = '2154';
				const JSONGeometry = JSON.stringify(data.geometry).replace(/"/g, '&amp;quot;');

				content += `
				&lt;div id="container">
					&lt;div id="accordion_fiche">
						&lt;div class="container-fluid">
							&lt;div class="row">
								&lt;div class="p-0 col text-right m-2">
									&lt;button class="btn btn-light border btn-isigeo-nav m-0 rounded-0 p-1" type="button"
									onclick="Localise.locateGeoJSON('${JSONGeometry}',0,true,'${srid}');" title="Localiser sur la carte">
										&lt;span class="icon ico-h2 icon-search text-primary">&lt;/span>
									&lt;/button>
								&lt;/div>
							&lt;/div>
						&lt;/div>
						&lt;div id="ongletcontent" class="container-fluid">
							&lt;div class="row small panel-data-group row-stripped">
							${keys
								.map((val, i) => {
									if (typeof data[val] == 'object') {
										data[val] = JSON.stringify(data[val]);
									}

									const allDataGrid = val + data[val];

									let leftGridClass = 'classcommentaire font-weight-bold col title-data text-left p-0 mr-2 align-items-center';
									let rightGridClass = 'col-auto text-right p-0';

									if (typeof data[val] == 'string' &amp;&amp; (data[val].length > 40 || val.length > 40 || allDataGrid.length > 50)) {
										leftGridClass = 'classcommentaire font-weight-bold align-self-start mb-2';
										rightGridClass = 'w-100';
									}
									if (i > 1) {
										return `
									&lt;div class="align-items-center grid align-items-center col-6 text-left py-2">
										&lt;div class="${leftGridClass}">
											&lt;span class="d-table-cell">
												${val}
											&lt;/span>
										&lt;/div>
										&lt;div class="${rightGridClass}">
											&lt;span>
												${data[val]}
											&lt;/span>
										&lt;/div>
									&lt;/div>`;
									}
								})
								.join('')}
							&lt;/div>
						&lt;/div>
					&lt;/div>
				&lt;/div>`;

				layoutManager.dialog.setBodyContent(content);
			};
			if (
				typeof layoutManager.isJSGroupLoaded.isigeo_form_consult == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.form == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' &amp;&amp;
				typeof layoutManager.isJSGroupLoaded.data == 'undefined'
			) {
				if (
					typeof isigeoGUI.layers == 'object' &amp;&amp;
					Object.keys(isigeoGUI.layers).length > 0 &amp;&amp;
					typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' &amp;&amp;
					typeof layoutManager.isJSGroupLoaded.data == 'undefined'
				) {
					layoutManager.loadJSFile('form',afterJSFormLoaded);
				} else {
					layoutManager.loadJSFile('form_consult', afterJSFormLoaded);
				}
			} else {
				afterJSFormLoaded();
			}
		},

		/**
		 * Fonction générique pour le lancement des traitements spécifiques ou autre PHP
		 * @param {String!} cmdAjax Commande du traitement (Juste pour reperer l'ajax dans le tableau, mettre un seul 1 mot)
		 * @param {String!} path Chemin du fichier PHP avec les param de la requete
		 * @param {String=} [message_title='Etes-vous sur de vouloir faire cette action ?'] Message de l'alert confirmation, si a false pour de dialog confirm
		 * @param {String=} [message_execute='Veuillez patientez&lt;br/>Votre action est en cours'] Message envoyé lors du lancement de l'ajax
		 * @param {String=} [message_wait="L'action est déjà en cours"] Message si ajax déjà en cours
		 * @param {Bool=} disableFormCheck Désactivation de la validation de formulaire (serialize)
		 * @param {Bool=} disableAlertifyError Désactivation des alertify d'erreur lorsque le retour PHP ne renvoie rien
		 * @param {String=} message_details - message complémentaire
		 *
		 * @example isigeoGUI.launchPHP('mail', '/specifique/geomatika/envoie_mail.php', false, 'Envoie en cours...', 'Mail envoyé !', false, false);
		 */
		launchPHP: function (cmdAjax, path, message_title, message_execute, message_wait, disableFormCheck, disableAlertifyError, message_details) {
			//On split le path pour avoir le chemin d'un côté et les params de l'autre
			path = path.split('?');

			//Sécurité au cas ou il y ai d'autre ? apres le premier
			var data = '';
			for (var i = 1; i &lt; path.length; i++) {
				data += path[i];
			}

			//On créer un JSON
			var params = JSON.stringify({
				path: path[0],
				type: 'POST',
				data: data,
			});

			//Et on excute la fonction qui va faire le traitement
			isigeoGUI.launch('PHP', cmdAjax, message_title, message_execute, message_wait, params, disableFormCheck, disableAlertifyError, message_details);
		},

		/**
		 * Fonction générique pour le lancement des traitements spécifiques ou autre SQL
		 * @param {String!} cmdAjax Commande du traitement (Juste pour reperer l'ajax dans le tableau, mettre un seul 1 mot)
		 * @param {String} base Nom de la base de données ciblée
		 * @param {String} fonction Fonction à executer
		 * @param {String=} [message_title='Etes-vous sur de vouloir faire cette action ?'] Message de l'alert confirmation, si a false pour de dialog confirm
		 * @param {String=} [message_execute='Veuillez patientez&lt;br/>Votre action est en cours'] Message envoyé lors du lancement de l'ajax
		 * @param {String=} [message_wait="L'action est déjà en cours"] Message si ajax déjà en cours
		 * @param {Bool=} disableFormCheck Désactivation de la validation de formulaire (serialize)
		 * @param {Bool=} disableAlertifyError Désactivation des alertify d'erreur lorsque le retour PHP ne renvoie rien
		 * @param {String=} message_details - message complémentaire
		 *
		 * @example isigeoGUI.launchSQL('test', 'demo_ep_64102', 'isigeo_test_maxime(\\'Maxime\\', \\'Test\\')', 'Ajax en cours..', 'Ajax déjà en cours.', false, false, 'Message complémentaire...');
		 */
		launchSQL: function (cmdAjax, base, fonction, message_title, message_execute, message_wait, disableFormCheck, disableAlertifyError, message_details) {
			//Nos param a envoyer
			var data = 'cmd=launchSQL&amp;base=' + base + '&amp;function=' + fonction;

			//On créer un JSON
			var params = JSON.stringify({
				path: 'lib/xhr_isigeo.php',
				type: 'POST',
				data: data,
			});

			//Et on excute la fonction qui va faire le traitement
			isigeoGUI.launch('SQL', cmdAjax, message_title, message_execute, message_wait, params, disableFormCheck, disableAlertifyError, message_details);
		},

		/**
		 * Fonction générique pour le lancement des traitements spécifiques ou autre PHP
		 * @param {String=} type PHP ou SQL
		 * @param {String!} cmdAjax Commande du traitement (Juste pour reperer l'ajax dans le tableau, mettre un seul 1 mot)
		 * @param {String=} message_title Message de l'alert confirmation, si a false pour de dialog confirm
		 * @param {String=} message_execute Message envoyé lors du lancement de l'ajax
		 * @param {String=} message_wait Message si ajax déjà en cours
		 * @param {Bool=} disableFormCheck Désactivation de la validation de formulaire (serialize)
		 * @param {Bool=} disableAlertifyError Désactivation des alertify d'erreur lorsque le retour PHP ne renvoie rien
		 * @param {String=} message_details - message complémentaire
		 *
		 * @ignore
		 */
		launch: function (type, cmdAjax, message_title, message_execute, message_wait, params, disableFormCheck, disableAlertifyError, message_details) {
			//Variable qui va nous autoriser a lancer l'ajax
			var launchRequest = true;

			//On redéfini certaine variable si non assigné
			if (typeof message_title === 'undefined') {
				message_title = 'Etes-vous sur de vouloir faire cette action ?';
			}

			if (typeof message_wait === 'undefined') {
				message_wait = "L'action est déjà en cours";
			}

			if (typeof message_execute === 'undefined') {
				message_execute = 'Veuillez patientez&lt;br/>Votre action est en cours';
			}

			//Fonction executant le traitement avec l'ajax
			// - Lancer automatiquement si le traitement n'est pas deja en cours et qu'une fiche en modifie n'est pas en cours de modificaiton
			// - Si la fiche est en cours de modification, le serialize fait par queryGUI.dialogStatus() nous permettera de savoir si des modifications on été faite et ainsi demande a l'utilisateur s'il veux enregistrer avant
			var launchRequestFunction = function () {
				//On recup les params
				var param = $jq.parseJSON(params);

				if (typeof param.type === 'undefined' &amp;&amp; param.type === '') {
					param.type = 'POST';
				}

				//Function launchAjax pour lancer l'ajax
				var launchAjax = function () {
					//On fait notre ajax et stock pour ne pas la relancer
					isigeoGUI.launchRequest[cmdAjax] = $jq.ajax({
						//Chemin du fichier traitement en permiere parti
						url: param.path,

						type: param.type,

						//Onglet courant &amp; donnée a envoyer en deuxième parti
						data: 'tab=' + isigeoGUI.getCurrentTab() + '&amp;' + param.data,

						//Async
						async: true,

						beforeSend: function () {
							if (message_execute !== false || message_execute === '') {
								alertify.log(message_execute, 'standard', 0);
							}
						},

						success: function (reponse, status) {
							alertify.clearLogs();

							var part = checkAjaxStatus('~', reponse, this);

							if (!part) {
								return false;
							}
							//On peut détruire notre ajax
							delete isigeoGUI.launchRequest[cmdAjax];

							//On gérer notre retour
							part = reponse.split('^');
							var typeNotif;
							var duree;

							//Si on a une erreur inconnu
							if (part[0] != '' &amp;&amp; (typeof disableAlertifyError == 'undefined' || (typeof disableAlertifyError != 'undefined' &amp;&amp; !disableAlertifyError))) {
								alertify.log(part[0], 'error', 0);
								return;
							}

							//La parti 3 est le message a afficher, donc si pas de message pas la peine de recup le code erreur et le time pour l'alertify
							if (typeof part[3] !== 'undefined' &amp;&amp; part[3] !== '') {
								//On va recupere l'état du traitement selon le numéro pour définir notre niveau d'alert
								switch (part[1]) {
									case '0':
										typeNotif = 'error';
										duree = 0;
										break;

									case '1':
										typeNotif = 'success';
										duree = 15000;
										break;

									case '2':
										typeNotif = 'standard';
										duree = 15000;
										break;

									default:
										typeNotif = 'standard';
										duree = 15000;
								}

								//Si on a défini la durée
								if (typeof part[2] !== 'undefined' &amp;&amp; !isNaN(part[2])) {
									duree = parseInt(part[2]);
								}

								//On enlever nos ancienne alertify
								$jq('.alertify-log').click();

								//Et on affiche comment c'est passé notre traitement
								alertify.log(part[3], typeNotif, duree);
							}
							//Pas de message, mais on indique quand meme que le traitement est terminé
							else {
								if (typeof disableAlertifyError == 'undefined' || (typeof disableAlertifyError != 'undefined' &amp;&amp; !disableAlertifyError)) {
									//On enlever nos ancienne alertify
									$jq('.alertify-log').click();
								}
							}

							//En part[4], on retourne une fonction javascript.
							if (typeof part[4] !== 'undefined') {
								$jq.globalEval(part[4]);
							}
						},

						error: function (resultat, statut, erreur) {
							//On peut détruire notre ajax
							delete isigeoGUI.launchRequest[cmdAjax];
							if (typeof disableAlertifyError == 'undefined' || (typeof disableAlertifyError != 'undefined' &amp;&amp; !disableAlertifyError)) {
								//On enlever nos ancienne alertify
								$jq('.alertify-log').click();

								//Et on affiche comment c'est passé notre traitement
								alertify.log('Traitement échoué', 'error', 10000);
							}
						},
					});
				};

				//Si notre variable message_title est a false on ne veux pas de confirmation mais si on a un text on affiche le message de confirme.3
				//Par défault, nous avons un message, il faut forcer l'état false sans la confirm
				if (message_title !== false || message_title === '') {
					layoutManager.dialogConfirm(message_title, {
						onAccept: launchAjax,
						onDenied: () => layoutManager.confirmDialog.hide(),
						labelAccept: 'Confirmer',
						detailsMsg: message_details,
					});
				} else {
					launchAjax();
				}
			};

			//Si l'ajax n'est pas déjà en cours
			if (isigeoGUI.launchRequest[cmdAjax] &amp;&amp; isigeoGUI.launchRequest[cmdAjax] !== null) {
				$jq('.alertify-log').click();
				alertify.log(message_wait, 'standard', 0);

				//On a pas besoin de verif la suite vue qu'on a deja le traitement en cous
				return;
			}

			//Ici, on est dans le cas d'une fiche ouverte en modif donc on va check grace au serialize si on a une modif a sauvegarder ou non avant le traitement
			if (!objEmpty(Query.formModif) &amp;&amp; (typeof disableFormCheck == 'undefined' || !disableFormCheck)) {
				//Cette variable servira à détecter si un champs CK a été modifié quand on bouclera sur les CKEDITOR
				var ckFieldsModified = false;

				//Vérification pour le cas particulier des champs CK
				if (!objEmpty(Query.editor) &amp;&amp; Query.editor.length > 0) {
					for (var i = Query.editor.length - 1; i >= 0; i--) {
						//Ckeditor.checkDirty() retourne true si des modifs ont eu lieu dans le CK
						if (Query.editor[i].checkDirty()) {
							//Modif detecté dans ckeditor
							ckFieldsModified = true;

							break;
						}
					}
				}

				//On recupere l'état actuel du formulaire, c'est à dire à sa fermeture
				var formState = Query.formStatus(Query.layerref);

				//En modification, on va comparer l'état du formulaire actuel avec celui qu'on à enregistré à sa fermeture
				if (
					(formState.dataForm !== '' &amp;&amp; typeof Query.formModif.dataForm !== 'undefined' &amp;&amp; formState.dataForm != Query.formModif.dataForm) ||
					ckFieldsModified ||
					formState.dirtySignature
				) {
					if (layoutManager.dialog) {
						if (Query.valid) {
							//Gestion de la validation du formulaire
							var validform = $jq('#fiche_metier').validate();

							if (!validform.form()) {
								if (validform.numberOfInvalids() == 1) {
									alertify.log(validform.numberOfInvalids() + ' champ invalide');
								} else if (validform.numberOfInvalids() > 1) {
									alertify.log(validform.numberOfInvalids() + ' champs invalides');
								}

								return;
							}
						}
					}

					//S'il accepte, on enregistrer la fiche, puis lancer notre traitement
					var accept = function () {
						Query.onAcceptUpdateObj();
						launchRequestFunction();
					};

					//S'il refuse, pas d'enregistrement et le traitement va se lancer
					var refuse = function () {
						//Va nous permette de reouvrir notre fiche
						Query.onCancelUpdateObj();

						//Et lance le traitement
						launchRequestFunction();
					};

					//S'il annul, bah il ne se passe rien

					//Et la, on va lui demander ce qu'il souhaite faire
					layoutManager.dialogConfirm('Voulez vous enregistrer les modifications apportées avant le lancement du traitement ?', {
						onAccept: accept,
						onDenied: refuse,
						libelleForm: 'Message de confirmation',
					});
					//Et on va stop le script, car le reste sera executé selon le choix de l'util
					return;
				}
			}

			//Si on a franchi tous les tests avec succès on peut lancer l'ajax
			launchRequestFunction();
		},

		/**
		 * function deporté qui appelle tableau_bordGUI.launchExportSIG (cas de shortcut notamment)
		 *
		 * @param {Number!} id identifiant unique
		 * @param {ExportSIGOpts=} options Objet d'options pour l'export SIG
		 *
		 * @example
		 *
		 * isigeoGUI.launchExportSIG('44', {
		 *   cmd: 'construct',
		 *   exportStatus: 'extranet',
		 *   outsideTabBord: true
		 *   destination : {layer : 'support', id : '45',  field : 'fichier', filename : 'mon_fichier.csv'}
		 * })
		 */
		 launchExportSIG: function (id, options) {
			 if (typeof options !== 'object') {
				 options = {
					 cmd: 'construct',
					 exportStatus: 'extranet',
					 outsideTabBord: true,
				 };
			 }
 
			 var format = typeof options.format == 'undefined' ? null : options.format;
			 var filtre = typeof options.filtre == 'undefined' ? null : options.filtre;
			 var destination = typeof options.destination == 'undefined' ? null : options.destination;
 
			 // Gestion des paramètre par défaut : 
 
 
			 if (typeof tableau_bordGUI === 'undefined') {
				 $jq.ajax({
					 type: 'GET',
					 url: 'plugins/tableau_bord/javascript/tableau_bordGUI.js',
					 success: function (res) {
						 var part = checkAjaxStatus('~', res, this);
 
						 if (!part) {
							 return false;
						 }
 
						 tableau_bordGUI.launchExportSIG(options.cmd, options.exportStatus, id,format, filtre, destination);
					 },
					 error: function (error) {
						 console.log(error);
					 },
					 dataType: 'script',
					 cache: false,
				 });
			 } else {
				 tableau_bordGUI.launchExportSIG(options.cmd, options.exportStatus, id,format, filtre, destination);
			 }
		 },

		/**
		 * Permet d'ajouter un layer
		 * @param  {String!}  name Nom du layer
		 * @param  {object=}  options Objet d'options
		 * @param  {string=}  options.dbname Nom de la base de données
		 * @param  {string=}  options.type Type de la couche (line, point, polygon)
		 * @param  {string=}  options.url Url GEOJson
		 * @param  {string=}  options.format format du layer
		 * @param  {string=}  options.srid code de projection (auto par défaut)
		 * @param  {string=}  options.zoomToExtent zoom sur la carte (true par défaut)
		 *
		 * @example
		 * isigeoGUI.addLayer('test', {url: 'http://localhost/test.geojson', format: 'geojson'})
		 * // ou ajout d'une couche existante
		 * isigeoGUI.addLayer('troncons')
		 */
		addLayer: function (name, options) {
			var content;

			// On vérifie s'il y a un type pour les dxf sinon on les met tous
			if (
				typeof options != 'undefined' &amp;&amp;
				typeof options.format != 'undefined' &amp;&amp;
				options.format == 'ogr' &amp;&amp;
				(typeof options.type == 'undefined' || options.type == '')
			) {
				options.type = 'point/line/polygon';
			}
			
			if(typeof options.zoomToExtent == 'undefined' || options.zoomToExtent != false){
				options.zoomToExtent = true;
			}

			// Envoyer une ajax
			// demande ajouter la couche table_name
			var param = 'cmd=addLayer&amp;layername=' + name + '&amp;options=' + JSON.stringify(options);
			if (typeof options === 'object' &amp;&amp; typeof options.url !== 'undefined' &amp;&amp; options.format == 'geojson') {
				Localise.locateGeoJSON(options.url, 'images/markers/target.svg', true);
				return;
			}
			$jq.ajax({
				url: 'lib/xhr_viewer.php', // adresse à laquelle la requete est envoyée
				type: 'POST', // type de requete pour récuperer ma donnée
				data: param, // les données dont nous souhaitons renvoyer
				dataType: 'html', // type html
				success: function (res, textStatus, jqXHR) {
					var part = checkAjaxStatus('~', res, jqXHR);

					if (!part) {
						return false;
					}

					if (res) {
						let layers;
						let classes;
						let alreadyAdded;
						//Ajout de la nouvelle couche dans isigeoGUI.layers
						var ret = JSON.parse(res);
						if (ret.layerType == 'other') {
							if (typeof ret.name === 'object' &amp;&amp; Object.keys(ret.name).length > 1) {
								for (var i = 0; i &lt; Object.keys(ret.name).length; i++) {
									//Check si le layer est déjà ajouté dans Viewer.layers
									alreadyAdded = false;
									$jq(Viewer.layers.includes(ret.name[i]) ? (alreadyAdded = true) : (alreadyAdded = false));
									if (!alreadyAdded) {
										layers = 'LAYERS=' + Viewer.layers + ',' + ret.name[i];
										classes = 'CLASSES=' + Viewer.classes + ';0';

										Viewer.setLayerState(layers, classes);
									}
								}
							} else {
								alreadyAdded = false;
								//Check si le layer est déjà ajouté dans Viewer.layers
								$jq(Viewer.layers.includes(ret.name) ? (alreadyAdded = true) : (alreadyAdded = false));
								if (!alreadyAdded) {
									layers = 'LAYERS=' + Viewer.layers + ',' + ret.name;
									classes = 'CLASSES=' + Viewer.classes + ';0';

									Viewer.setLayerState(layers, classes);
								}
							}

							// Maj l'extent sur l'emprise de la couche
							if (typeof ret.extent != 'undefined' &amp;&amp; ret.extent != false &amp;&amp; ret.extent != null) {
								var extent = ret.extent;
								if (
									typeof extent.xmax != 'undefined' &amp;&amp;
									typeof extent.ymax != 'undefined' &amp;&amp;
									typeof extent.xmin != 'undefined' &amp;&amp;
									typeof extent.ymin != 'undefined'
								) {
									extent = [parseFloat(extent.xmin), parseFloat(extent.ymin), parseFloat(extent.xmax), parseFloat(extent.ymax)];
									if (
										extent[0] &lt; Viewer.maxExtent[0] ||
										extent[1] &lt; Viewer.maxExtent[1] ||
										extent[2] > Viewer.maxExtent[2] ||
										extent[3] > Viewer.maxExtent[3]
									) {
										extent = Viewer.maxExtent;
									}
									try {
										if(options.zoomToExtent == true) {
											Viewer.map.getView().fit(extent, {
												nearest: true,
												padding: [200, 200, 200, 200],
											});
										}
									} catch (e) {}
								}
							}
						} else {
							var newLayer = {
								add_geo: ret.user_mod.add_geo,
								affichage: ret.affichage,
								angle: false,
								assoc: ret.user_mod.assoc,
								base: ret.base,
								constraint: ret.constraint,
								geoloc: ret.user_mod.geoloc,
								icon: null,
								libelle: ret.libelle,
								name: ret.name,
								suppr_geo: ret.user_mod.suppr_geo,
								type: ret.type,
							};

							layers = 'LAYERS=' + Viewer.layers + ',' + name;
							classes = 'CLASSES=' + Viewer.classes + ';0';

							Viewer.setLayerState(layers, classes);

							if (ret.type == 'POINT') {
								isigeoGUI.layers.POINT.push(newLayer);
							}

							if (ret.type == 'LINESTRING') {
								isigeoGUI.layers.LINESTRING.push(newLayer);
							}

							// Mise a jour de isigeoSession.defTables avec le layer ajouté
							isigeoSession.getDefTable(name);

							//Mis a jour du LayerTree si déjà chargé
							if ($jq('button[data-panel="layercontrol_div"]').hasClass('active')) {
								var childs = tree.root.childs;
								for (var c in childs) {
									if (childs[c].name == 'Couche Utilisateur') {
										tree.expandAll(true);
									} else {
										initBaseLayer();
										initTree();
										initcc();
									}
								}
							}
						}

						//On affiche un message d'info dans le footer
						content = 'La couche ' + name + ' a bien été ajoutée à la carte';
						layoutManager.openAdvancedFooter(content, {
							overrideFooter: true,
							duration: 4000,
							alert: 'infos',
						});

						if(!$jq('#viewer').is(':visible')) {
							layoutManager.openPanel('viewer');
						}
					} else {
						//On affiche un message d'info dans le footer
						content = 'La couche ' + name + " est déjà présente ou n'existe pas";
						layoutManager.openAdvancedFooter(content, {
							overrideFooter: true,
							duration: 4000,
							alert: 'warning',
						});
					}
				},
				error: function () {
					console.log("Echec d'ajout de couche");
				},
			});
		},

		/**
		 * Permet de supprimer un layer
		 * @param {String!} name Nom du layer
		 */
		removeLayer: function (name) {
			var param = 'cmd=removeLayer&amp;layerName=' + name;
			$jq.ajax({
				url: 'lib/xhr_viewer.php', // adresse à laquelle la requete est envoyée
				type: 'POST', // type de requete pour récuperer ma donnée
				data: param, // les données dont nous souhaitons renvoyer
				dataType: 'html', // type html
				success: function (res, textStatus, jqXHR) {
					// Récupération des classes et layers que l'on transforme en tableau
					var tabClasses = Viewer.classes.split(';');
					var tabLayers = Viewer.layers.split(',');
					// Récupération du name que l'on split pour obtenir sans .dxf
					var nomDXF = name.split('.')[0];
					// Supprime DXF des 3 types de couches
					if (tabLayers.indexOf(nomDXF + '_point') !== -1) {
						// Trouve la position dans la liste, le supprime ainsi que sa classe
						var posPoint = tabLayers.indexOf(nomDXF + '_point');
						tabLayers.splice(posPoint, 1);
						tabClasses.splice(posPoint, 1);
					}
					if (tabLayers.indexOf(nomDXF + '_line') !== -1) {
						var posLine = tabLayers.indexOf(nomDXF + '_line');
						tabLayers.splice(posLine, 1);
						tabClasses.splice(posLine, 1);
					}
					if (tabLayers.indexOf(nomDXF + '_polygon') !== -1) {
						var posPolygon = tabLayers.indexOf(nomDXF + '_polygon');
						tabLayers.splice(posPolygon, 1);
						tabClasses.splice(posPolygon, 1);
					}
					// Layers et classes que l'on retransforme en chaîne
					Viewer.classes = tabClasses.join(';');
					Viewer.layers = tabLayers.join(',');
					// Set les modifications
					Viewer.setLayerState('LAYERS=' + Viewer.layers, 'CLASSES=' + Viewer.classes);
					// Refresh la legend si ouverte
					if ($jq('.ol-get-legend').is(':visible')) {
						Legend.refresh();
					}
				},
				error: function () {
					console.log('Echec lors de la suppression de la couche ' + name);
				},
			});
		},

		/**
		 * Fonction permettant de supprimer une couche
		 * @param {String} table Nom de la table
		 * @param {Event=} event Evenement JS
		 *
		 * @ignore
		 */
		removeTableSelection: function (table, event) {
			if (event) {
				event.preventDefault();
				event.stopPropagation();
			}
			if (typeof isigeoGUI.objSelection[table] != 'undefined' &amp;&amp; typeof isigeoGUI.objSelection[table].values != 'undefined') {
				var objLayer = isigeoGUI.objSelection[table].values;
				var nbObj = objLayer.length;
				//isigeoGUI.tablesIgnored.push(table);
				for (var i = 0; i &lt; nbObj; i++) {
					Viewer.removeSelectionObj(table, objLayer[0].id, null);
				}
			}
		},

		/**
		 *
		 * @param {String!} layer  Nom de la table
		 * @param {Number!} id  ID de l'objet recherché
		 * @param {Boolean=} centerToObj  Option permettant de centrer la carte sur l'objet recherché
		 *
		 * @example isigeoGUI.locate('support', 1, true);
		 * @ignore
		 */
		locate(layer, id, centerToObj) {
			Viewer.locate(layer, id, centerToObj);
		},

		/**
		 * Récupère le contenu d'une inforap
		 * @param  {ObjDataInforap} data Objet contenant les données à afficher
		 * @param  {Boolean} isTooltip Si c'est à inserer dans un tooltip
		 * @param  {Boolean} isSelection
		 * @param  {Boolean} isMultiLink
		 * @param  {Boolean} draggable Si l'élément est draggable pour ajouter un event via drag &amp; drop sur fullCalendar
		 * @param  {Function} callbackModify
		 * @param  {Boolean} alertClosable Si aucun résultat : permet d'ajouter à l'alerte la possibilité de la fermer
		 * @return {ObjInforap} objet contenant le HTML et le nombre de résultat
		 *
		 * @ignore
		 */
		getInforapContent: function (data, isTooltip, isSelection, isMultiLink, draggable, callbackModify, alertClosable) {
			// Initialisation des variables
			let objRet = {};
			let html = '';
			let noResult = false;
			let tablesNames = Object.keys(data);
			isigeoGUI.nbResult = 0;
			if (typeof MouseQuery != 'undefined') {
				MouseQuery.nbResult = 0;
			}
			isigeoSession.data = data;

			if (typeof isTooltip == 'undefined') {
				isTooltip = true;
			}
			if (typeof isSelection == 'undefined') {
				isSelection = false;
			}
			if (typeof isMultiLink == 'undefined') {
				isMultiLink = false;
			}
			if (typeof draggable === 'undefined' || typeof draggable !== 'boolean') {
				draggable = false;
			}

			if (tablesNames.length > 0) {
				for (var i = 0; i &lt; tablesNames.length; i++) {
					// Si la table à son agenda, on permet que les elements soit draggable
					if (typeof Agenda !== 'undefined' &amp;&amp; typeof Agenda.objAgendas !== 'undefined') {
						const objAgenda = Agenda.objAgendas.find(elem => elem.table === tablesNames[i]);
						if (objAgenda !== undefined) {
							draggable = true;
						}
					}
					// On affiche le libelle de la table
					html += isigeoGUI.getInforapContentTable(data, tablesNames[i], isTooltip, isSelection, false, isMultiLink, draggable, callbackModify);
				}
			} else {
				// Si on a pas de résultat
				noResult = true;
				html += isigeoGUI.getInforapContentEmpty(alertClosable);
			}

			objRet.html = html;
			objRet.noResult = noResult;
			if (typeof MouseQuery != 'undefined') {
				objRet.nbResult = MouseQuery.nbResult;
			} else {
				objRet.nbResult = isigeoGUI.nbResult;
			}
			return objRet;
		},

		/**
		 *
		 * @param {ObjDataInforap} data
		 * @param {String} tableName
		 * @param {Boolean} isTooltip
		 * @param {Boolean} isSelection
		 * @param {Boolean} highlighted
		 * @param {Boolean} isMultiLink
		 * @param {Boolean} draggable
		 * @param {Function} callbackModify
		 * @returns {String} HTML
		 *
		 * @ignore
		 */
		getInforapContentTable: function (data, tableName, isTooltip, isSelection, highlighted, isMultiLink, draggable, callbackModify) {
			let haveRightAdd = true;
			var textSmall = '';
			var nbResult = 0;
			if (isigeoGUI.hardwareFormat === 'smartphone') {
				textSmall = 'small font-weight-bold';
			}
			if (typeof highlighted == 'undefined') {
				highlighted = false;
			}

			if (isMultiLink) {
				haveRightAdd = isigeoSession.haveRight(tableName, isigeoSession.CREATE);
			}
			// Gestion du cas ou la table n'est pas ajouté à l'init d'isigéo
			if (isigeoSession.defTables &amp;&amp; !isigeoSession.defTables[tableName]) isigeoSession.getDefTable(tableName);
			// Ajouter les éléments non chargés depuis la BD à l'objet isigeoSession.defTables
			isigeoGUI.addOtherToDeftables(tableName, data);
			// On récupère le libelle de la table en cours
			var tableLibelle = isigeoSession.defTables[tableName].libelle;
			// Nombre de résultats
			var resultat = data[tableName].values.length;
			// Récup des données deftables
			var deftable = isigeoSession.defTables[tableName];
			if (typeof data.error !== 'undefined') {
				var content = data.error;
				layoutManager.openAdvancedFooter(content, {
					overrideFooter: true,
					duration: 5000,
					alert: 'warning',
				});
				return false;
			}
			// Libelle de la table
			var ret = `&lt;div data-toggle="collapse" aria-expanded="true" id="${tableName}" data-target="#tooltip_${tableName}" class="table bg-primary text-light m-0 cursor-pointer border-top ${textSmall}">
				&lt;div class="d-flex align-items-center justify-content-start p-1">`;
			var btnRemoveTable = '';
			if (typeof isSelection != 'undefined' &amp;&amp; isSelection) {
				btnRemoveTable = `
				&lt;button class="btn-del-selection-table btn p-0 d-inline-flex text-light" onclick="isigeoGUI.removeTableSelection('${tableName}',event);" title="Supprimer la table de la sélection">
					&lt;i class="icon icon-shopping-delete ico-h2 mr-1">&lt;/i>
				&lt;/button>`;
			}
			ret += '&lt;p class="m-0 mr-auto">' + tableLibelle + '&lt;/p>';
			ret += btnRemoveTable;
			if (isMultiLink &amp;&amp; haveRightAdd) {
				ret += '&lt;i id="multilink-add-' + tableName + '" data-tablename="' + tableName + '" class="icon icon-plus mr-2">&lt;/i>';
			}
			ret += '&lt;span class="rotate-arrow right-down mr-1">&lt;i class="icon icon-chevron">&lt;/i>&lt;/span>';
			ret += '&lt;/div>';
			ret += '&lt;/div>';
			// On actualise le nombre de resultat
			isigeoGUI.nbResult += resultat;
			if (typeof MouseQuery != 'undefined') {
				MouseQuery.nbResult += resultat;
			}
			//if (resultat > 1) {
			ret += '&lt;div id="container_result_' + tableName + '" class="border-bottom ' + textSmall + '">';
			ret += '&lt;div id="result_' + tableName + ' "class="d-flex align-items-center justify-content-start p-1">';
			ret += '&lt;p class="m-0 mr-auto font-italic">Résultats : &lt;span id="nb_result_' + tableName + '">' + resultat + '&lt;/span>&lt;/p>';

			if (!isigeoGUI.isApps) {
				ret += '&lt;span>';

				if (typeof data[tableName].printAllDocs != 'undefined' &amp;&amp; data[tableName].printAllDocs !== '') {
					ret += data[tableName].printAllDocs;
				}
				if (typeof data[tableName].values[0] != 'undefined' &amp;&amp; typeof data[tableName].values[0].matcad != 'undefined' &amp;&amp; data[tableName].values[0].matcad) {
					// Affiche les btn export proprios CSV en publipostage pour la matcad
					// Export csv
					ret +=
						'&lt;button type="button" id="' +
						tableName +
						'_exportCSVproprio" class="btn p-0 text-primary d-inline-flex" title="Exporter la liste des propriétaires">';
					ret += '&lt;i class="icon icon-actions-document-export-proprio ico-h2">&lt;/i>';
					ret += '&lt;/button>';

					$jq(document)
						.off('click', `#${tableName}_exportCSVproprio`)
						.on('click', `#${tableName}_exportCSVproprio`, e => {
							e.preventDefault();
							e.stopImmediatePropagation();
							e.stopPropagation();
							isigeoGUI.exportCSVselectionTable(deftable.nom, data, true);
						});
				}

				// Affiche les btn export csv &amp; localise en version web
				// Export csv
				ret += '&lt;button type="button" id="' + tableName + '_exportCSV" class="btn p-0 text-primary d-inline-flex" title="Export CSV">';
				ret += '&lt;i class="icon icon-actions-document-export-csv ico-h2">&lt;/i>';
				ret += '&lt;/button>';

				$jq(document)
					.off('click', `#${tableName}_exportCSV`)
					.on('click', `#${tableName}_exportCSV`, e => {
						e.preventDefault();
						e.stopImmediatePropagation();
						e.stopPropagation();
						isigeoGUI.exportCSVselectionTable(deftable.nom, data);
					});

				if (deftable.nature != 'ALPHA') {
					var type_query = 'geosearch_';
					if (isTooltip) {
						type_query = 'geoquery_';
					}
					// Localise sur la carte
					ret += '&lt;button id="' + tableName + '_locate_on_map" type="button" class="btn p-0 text-primary d-inline-flex" title="Localiser tous les résultats">';
					ret += '&lt;i class="icon icon-search-location-marker-solid ico-h2">&lt;/i>';
					ret += '&lt;/button>';

					$jq(document)
						.off('click', `#${tableName}_locate_on_map`)
						.on('click', `#${tableName}_locate_on_map`, e => {
							e.preventDefault();
							e.stopImmediatePropagation();
							e.stopPropagation();
							if (typeof Viewer != 'undefined') {
								Viewer.locateSelectionTable(deftable.nom, {}, data);
							}
						});
				}
				//Ouvrir dans DATA
				if ($jq('#btn-data').length > 0 &amp;&amp; $jq('#btn-data').is(':visible')) {
					ret += `
					&lt;button type="button" id="${tableName}_open_in_data" class="btn p-0 text-primary d-inline-flex" title="Ouvrir dans l'onglet Données">
						&lt;i class="icon icon-view-form ico-h2">&lt;/i>
					&lt;/button>`;
					$jq(document)
						.off('click', `#${tableName}_open_in_data`)
						.on('click', `#${tableName}_open_in_data`, e => {
							e.preventDefault();
							e.stopImmediatePropagation();
							e.stopPropagation();
							isigeoGUI.openDataSelectionTable(deftable.nom, data);
						});
				}
				//Default Table
				if (isigeoSession.defTables[tableName].default != null &amp;&amp; isigeoSession.defTables[tableName].default != '') {
					const defaultParsed = $jq.parseJSON(isigeoSession.defTables[tableName].default);
					let hasClickDefault = false;

					for (let d = 0; d &lt; defaultParsed.length; d++) {
						if (typeof defaultParsed[d].type != 'undefined' &amp;&amp; defaultParsed[d].type == 'CLICK') {
							hasClickDefault = true;
						}
					}

					if (hasClickDefault &amp;&amp; !isMultiLink) {
						ret += `
						&lt;button id="exec-func-${tableName}" type="button" class="btn-exec-default btn p-0 text-primary d-inline-flex" title="Lancer la fonction de sélection">
							&lt;i class="icon icon-hammer ico-h2">&lt;/i>
						&lt;/button>`;

						$jq(document)
							.off('click', `#exec-func-${tableName}`)
							.on('click', `#exec-func-${tableName}`, e => {
								e.preventDefault();
								e.stopImmediatePropagation();
								e.stopPropagation();
								isigeoGUI.getPopoverDefaultFromSelection(deftable.nom, data);
							});
					}
				}
				ret += '&lt;/span>';
			}

			ret += '&lt;/div>';
			ret += '&lt;/div>';
			//}

			// Préparation du div ou on retrouve les enregistrements
			ret += '&lt;div id="tooltip_' + tableName + '" class="collapse show">';

			ret += '';
			for (var i = 0; i &lt; resultat; i++) {
				ret += isigeoGUI.getInforapContentLine(data[tableName].values[i], tableName, isSelection, highlighted, draggable, callbackModify, i, resultat);
			}
			ret += '&lt;/div>';

			return ret;
		},

		/**
		 * Cas ou on a pas de tables à afficher
		 * @param {Boolean} closable
		 * @returns {String} HTML
		 *
		 * @ignore
		 */
		getInforapContentEmpty: function (closable) {
			var ret = `
				&lt;div class="alert alert-warning bg-white text-center ${closable === true ? `alert-dismissible fade show` : ``}" role="alert">
					&lt;span class="icon icon-search">&lt;/span>
					&lt;p class="m-0">Aucun résultat trouvé&lt;/p>
					${closable === true ? `&lt;button type="button" class="close" data-dismiss="alert" aria-label="Close">&lt;span aria-hidden="true">&amp;times;&lt;/span>&lt;/button>` : ``}
				&lt;/div>`;
			return ret;
		},

		/**
		 *
		 * @param {Deftable} deftable Nom de la table
		 * @param {String} eventApply Nom de l'event
		 * @param {ValuesInforap} values
		 * @param {Boolean} isSelection
		 * @param {Boolean} openFiche Ouvrir la fiche ou non
		 * @param {Function} callbackModify
		 * @returns {String} HTML
		 *
		 * @ignore
		 */
		getBtnInforapLine: function (deftable, eventApply, values, isSelection, openFiche, callbackModify) {
			const speedAddBtn = this.getBtnSpeedAdd(deftable, eventApply, values);

			var ret = '&lt;span class="col-auto p-0">';
			// if(typeof data[keys[i]].icon != 'undefined' &amp;&amp; data[keys[i]].icon != ''){
			// 	ret  += '&lt;img class="position-relative" style="width:26px;" title="'+data[keys[i]].libelle+'" src="'+data[keys[i]].icon+'" alt="icon">';
			// }
			if (!openFiche) {
				// ret += `
				// &lt;button type="button" class="btn text-primary p-0 d-inline-flex" title="Supprimer l'objet" on${eventApply}="Query.confirmRemoval('${deftable.nature}', ${deftable.level}, '${deftable.nom}', ${values.id}, 'inforap')">
				// 	&lt;i class="icon icon-trash-alt ico-h2">&lt;/i>
				// &lt;/button>`;
			}
			if (typeof deftable.street_view != 'undefined' &amp;&amp; deftable.street_view == 'Y') {
				ret += `
				&lt;button type="button" class="btn text-warning p-0 d-inline-flex" title="StreetView"
				on${eventApply}="streetview.openStreetView(${values.y},${values.x},event);">
					&lt;span class="icon icon-male ico-h2">&lt;/span>
				&lt;/button>`;
			}
			if (typeof values.matcad != 'undefined' &amp;&amp; values.matcad === true) {
				ret += `
				&lt;button type="button" class="btn text-primary p-0 d-inline-flex" title="Consultez la matrice cadastrale"
				on${eventApply}="openfichecad('${deftable.nom}', '${values.id}', event)">
					&lt;img src="images/mat_cad.svg" style="width:24px;position:relative;top:-1px;">
				&lt;/button>`;
			}
			if (values.doc_onClick > 0) {
				var sessionId = isigeoSession.getSessionID();
				if (values.doc_onClick > 1) {
					ret += '&lt;button type="button" class="btn text-primary p-0 d-inline-flex" title="Générer le document" on' + eventApply + '="';
					ret += `getChoiceDoc('merge', 'consult', '${values.idDocs}', '${values.fieldocs}', '${deftable.nom}', '${values.id}', '${sessionId}', '', '					${values.labelFields}', true)">`;
					ret += '&lt;span class="icon icon-print ico-h2">&lt;/span>&lt;/button>';
				} else {
					ret += '&lt;button type="button" class="btn text-primary p-0 d-inline-flex" title="Générer le document" on' + eventApply + '=';
					ret += `"getPDF('merge', 'consult', '${values.idDocs}', '${values.fieldocs}', '${deftable.nom}', '${values.id}' , '${sessionId}' , '')">`;
					ret += '&lt;span class="icon icon-print ico-h2">&lt;/span>&lt;/button>';
				}
			}
			if (typeof deftable.nature != 'undefined' &amp;&amp; deftable.nature == 'GEO') {
				if (typeof values.geometry != 'undefined') {
					const JSONGeometry = JSON.stringify(values.geometry).replace(/"/g, '&amp;quot;');
					ret += `
					&lt;button type="button" class="btn-localise btn text-primary p-0 d-inline-flex" title="Localiser" on${eventApply}="Localise.locateGeoJSON('${JSONGeometry}', 0, true, ${deftable.srid}', event);layoutManager.hideSidebarMobile();">
							&lt;span class="icon icon-search ico-h2">&lt;/span>
					&lt;/button>`;
				} else {
					if (typeof values.hasGeometry != 'undefined' &amp;&amp; values.hasGeometry) {
						ret += `
						&lt;button type="button" class="btn-localise btn text-primary p-0 d-inline-flex" title="Localiser" on${eventApply}="envoishape('${deftable.nom}',0,'${values.id}', event);layoutManager.hideSidebarMobile();">
							&lt;span class="icon icon-search ico-h2">&lt;/span>
						&lt;/button>`;
					} else {
						if (isigeoSession.haveRight(deftable.nom, isigeoSession.GEOLOC)) {
							ret += `
							&lt;button type="button" class="btn-localise btn text-primary p-0 d-inline-flex" title="Géolocaliser cet objet sur la carte" on${eventApply}="Query.initGeoLoc('${values.id}','${deftable.nom}','', event);layoutManager.hideSidebarMobile();">
								&lt;span class="icon ico-h2 icon-map-marker-alt">&lt;/span>
							&lt;/button>`;
						} else {
							ret += `
							&lt;button type="button" class="btn-localise btn text-primary p-0 d-inline-flex" title="Objet non localisé" on${eventApply}="event.preventDefault();event.stopPropagation();">
								&lt;span class="icon icon-map-marker-alt ico-h2">&lt;/span>
							&lt;/button>`;
						}
					}
				}
			}
			if (typeof isSelection != 'undefined' &amp;&amp; isSelection) {
				ret += `&lt;button type="button" class="btn-del-selection btn text-danger p-0 d-inline-flex" title="Supprimer de la sélection" 
					on${eventApply}="event.stopPropagation();Viewer.removeSelectionObj('${deftable.nom}','${values.id}');layoutManager.hideSidebarMobile();">
						&lt;span class="icon icon-shopping-delete ico-h2">&lt;/span>
					&lt;/button>`;
			}
			// if (typeof values.affichage_rapide != "undefined" &amp;&amp; values.affichage_rapide) {
			// 	ret += '&lt;button type="button" data-toggle="collapse" aria-expanded="false" data-idunique="' + values.id + '" data-target="#inforap_' + deftable.nom + '_' + values.id + '" class="btn text-primary d-inline-flex p-0" title="Fiche détaillée de l\'objet" on' + eventApply + '="inforapGUI.displayInforapFields(this, event)">&lt;span class="rotate-arrow right-down d-inline-flex">&lt;i class="icon icon-chevron ico-h2">&lt;/i>&lt;/span>&lt;/button>';
			// }
			if (speedAddBtn) {
				ret += speedAddBtn;
			}
			if (openFiche) {
				let titleDialog = deftable.libelle;
				let modifiedLibelle = titleDialog + ' : ' + values.libelle;
				modifiedLibelle = modifiedLibelle.replace(/&lt;\/?[^>]+(>|$)/g, '');
				modifiedLibelle = modifiedLibelle.replace(/"/g, '&amp;quot;');
				modifiedLibelle = modifiedLibelle.replace(/'/g, '&amp;apos;');

				let affichage = layoutManager.getAffichage(deftable.nom);
				let fullTitle = modifiedLibelle;
				let dialogPosition = deftable.position ? deftable.position : affichage === 'small' ? 'right-bottom' : 'center';

				let options = {
					titleDialog,
					fullTitle,
					dialogPosition,
					affichage,
				};
				options = JSON.stringify(options);
				options = options.replace(/"/g, '&amp;quot;');
				options = options.replace(/'/g, '&amp;apos;');

				let stringifyValues = JSON.stringify(values);
				stringifyValues = stringifyValues.replace(/"/g, '&amp;quot;');
				stringifyValues = stringifyValues.replace(/'/g, '&amp;apos;');
				ret += `
				&lt;button type="button" data-values="${stringifyValues}" data-options="${options}" data-name="${deftable.nom}" data-id="${values.id}" data-open_fiche="${openFiche}" class="btn open-form text-primary d-inline-flex p-0" title="Fiche détaillée de l'objet">
					&lt;i class="icon icon-chevron ico-h2">&lt;/i>
				&lt;/button>`;

				// Gestion des eventListener
				$jq(document)
					.off('touchmove', `.open-form, #inforap_${deftable.nom}_${values.id}`)
					.on('touchmove', `.open-form, #inforap_${deftable.nom}_${values.id}`, function (e) {
						window.touchmoved = true;
					});
				$jq(document)
					.off('touchstart', `.open-form, #inforap_${deftable.nom}_${values.id}`)
					.on('touchstart', `.open-form, #inforap_${deftable.nom}_${values.id}`, function () {
						window.touchmoved = false;
					});
				$jq(document)
					.off(eventApply, `.open-form, #inforap_${deftable.nom}_${values.id}`)
					.on(eventApply, `.open-form, #inforap_${deftable.nom}_${values.id}`, { callbackModify: callbackModify }, function (e) {
						e.stopImmediatePropagation();
						e.stopPropagation();

						const openFiche = $jq(this).data('open_fiche') || $jq(this).prev().find('.open-form').data('open_fiche');
						if (window.touchmoved != true) {
							if (openFiche === 'other') {
								let opts = {};
								try {
									opts = $jq(this).data('options') || $jq(this).prev().find('.open-form').data('options');
								} catch (err) {
									layoutManager.manageCatchError(err, 'open-form');
								}
								if (typeof e.data.callbackModify != 'undefined' &amp;&amp; e.data.callbackModify != null) {
									opts.callbackSave = e.data.callbackModify;
								}
								const values = $jq(this).data('values') || $jq(this).prev().find('.open-form').data('values');
								isigeoGUI.openOtherForm(values, opts);
								layoutManager.hideSidebarMobile();
							} else {
								let opts = {};
								try {
									opts = $jq(this).data('options') || $jq(this).prev().find('.open-form').data('options');
								} catch (err) {
									layoutManager.manageCatchError(err, 'open-form');
								}
								if (typeof e.data.callbackModify != 'undefined' &amp;&amp; e.data.callbackModify != null) {
									opts.callbackSave = e.data.callbackModify;
								}
								const table = $jq(this).data('name') || $jq(this).prev().find('.open-form').data('name');
								const id = $jq(this).data('id') || $jq(this).prev().find('.open-form').data('id');

								isigeoGUI.openForm(table, id, opts);
								layoutManager.hideSidebarMobile();
							}
						}
					});
			}
			ret += '&lt;/span>';
			return ret;
		},

		/**
		 *
		 * @param {ValuesInforap} data Objet contenant les données
		 * @param {String} tableName Nom de la table
		 * @param {Boolean} isSelection Si c'est une selection
		 * @param {Boolean} highlighted Si c'est en surbrillance
		 * @param {Boolean} draggable Cas element draggable dans l'agenda
		 * @param {Function} callbackModify callback appelé à la modif du formulaire
		 * @param {Number} i Numéro d'itération
		 * @param {Number} nbResultat Nombre total de résultats
		 * @returns {String} HTML
		 *
		 * @ignore
		 */
		getInforapContentLine: function (data, tableName, isSelection, highlighted, draggable, callbackModify, i, nbResultat) {
			/** @type {Deftable} */
			const deftable = isigeoSession.defTables[tableName];
			let eventApply = 'click';

			if (typeof highlighted == 'undefined') {
				highlighted = false;
			}

			if (typeof deftable.val != 'undefined' &amp;&amp; deftable.val != '') {
				var search_regexp = new RegExp(data[keys[i]].val, 'gi');
				libelle = libelle.replace(search_regexp, "&lt;span class='bg-warning'>" + isigeoSession.data[tableName].val + '&lt;/span>');
			}

			if (isigeoGUI.isApps || this.tactil) {
				eventApply = 'touchend';
			}

			var titleDialog = deftable.libelle;
			var modifiedLibelle = data.libelle ? titleDialog + ' : ' + data.libelle : titleDialog + ' : ' + data.inforap;
			modifiedLibelle = modifiedLibelle.replace(/&lt;\/?[^>]+(>|$)/g, '');
			modifiedLibelle = modifiedLibelle.replace(/"/g, '&amp;quot;');
			modifiedLibelle = modifiedLibelle.replace(/'/g, "\\'");
			var affichage = layoutManager.getAffichage(tableName);
			var fullTitle = modifiedLibelle;
			let dialogPosition = deftable.position;

			if (affichage === 'small' &amp;&amp; !deftable.position) {
				dialogPosition = 'right-bottom';
			}

			let draggableClass = '';
			let draggableEventData = '';
			let script = '';
			if (draggable === true &amp;&amp; typeof FullCalendar !== 'undefined' &amp;&amp; $jq('#calendar').length > 0) {
				draggableClass = 'draggable-el';
				if (i === nbResultat - 1) {
					script = '&lt;script>isigeoGUI.initDragEvents();&lt;/script>';
				}
			}

			if (deftable.affichage === 'INLINE') {
				affichage = 'small';
			} else if (deftable.affichage === 'DIALOG') {
				affichage = 'medium';
			} else {
				affichage = deftable.affichage;
			}
			var options = {
				titleDialog,
				fullTitle,
				dialogPosition,
				affichage,
			};
			options = JSON.stringify(options);
			options = options.replace(/"/g, '&amp;quot;');
			options = options.replace(/'/g, '&amp;apos;');
			var inforap = isigeoSession.data[tableName].values[i][deftable.inforap];
			var libelle = data.libelle || inforap;
			var values = data;
			var stringifyValues = JSON.stringify(values);
			stringifyValues = stringifyValues.replace(/"/g, '&amp;quot;');
			stringifyValues = stringifyValues.replace(/'/g, '&amp;apos;');
			data = isigeoSession.data[tableName];
			var classHighlight = '';

			// On récupère le nombre de champ consultable ou éditable
			const countAvailableFields = deftable.defmod.filter(el => el.modif == 'Y' || (el.modif == 'N' &amp;&amp; el.typechamps !== 'GROUPE')).length;

			// Si aucun champs consultable ni editable on fait comme si on avait aucune données
			if (data.open_fiche != 'other' &amp;&amp; data.open_fiche !== false &amp;&amp; countAvailableFields === 0) data.open_fiche = false;

			if (highlighted) {
				classHighlight = 'highlight';
			}
			if ($jq('#inforap_table #container_inforap_' + tableName + '_' + values.id).length > 0) {
				return;
			}
			// Ici on stock l'objet courant de valeur pour éviter des textes à ralonge..
			// Début container ligne + affichage rapide si il y'a

			var ret = `&lt;div id="container_inforap_${tableName}_${values.id}" class="${classHighlight} line-inforap list-isigeo ${draggableClass} `;
			if (values.affichage_rapide) {
				ret += `cursor-pointer" data-name="${tableName}" data-id='${values.id}' data-toggle="collapse" aria-expanded="false" data-target="#inforap_${deftable.nom}_${values.id}">
				&lt;div title="Informations rapide" class="inforap" data-id="${values.id}" data-name="${tableName}" ${draggableEventData} id='data_${tableName}_${values.id}'>`;

				// Gestion des eventListener
				$jq(document)
					.off('touchmove', '.inforap')
					.on('touchmove', '.inforap', function (e) {
						try {
							if (isJSON($jq(this).attr('data-options'))) {
								opts = JSON.parse($jq(this).attr('data-options'));
							} else {
								opts = $jq(this).attr('data-options');
							}
						} catch (err) {
							console.error(err);
						}
						window.touchmoved = true;
					});

				$jq(document)
					.off('touchstart', '.inforap')
					.on('touchstart', '.inforap', function () {
						window.touchmoved = false;
					});

				$jq(document)
					.off(eventApply, '.inforap')
					.on(eventApply, '.inforap', function (e) {
						if (window.touchmoved != true) {
							inforapGUI.displayInforapFields(this, e);
						}
					});
			} else if (data.open_fiche) {
				let dialogPosition = deftable.position ? deftable.position : affichage === 'small' ? 'right-bottom' : 'center';
				let options = {
					titleDialog,
					fullTitle,
					dialogPosition,
					affichage,
				};
				options = JSON.stringify(options);
				options = options.replace(/"/g, '&amp;quot;');
				options = options.replace(/'/g, '&amp;apos;');

				let stringifyValues = JSON.stringify(values);
				stringifyValues = stringifyValues.replace(/"/g, '&amp;quot;');
				stringifyValues = stringifyValues.replace(/'/g, '&amp;apos;');
				ret += `open-form cursor-pointer" data-values='${stringifyValues}' data-name='${deftable.nom}' data-id='${values.id}' data-options='${options}' data-open_fiche='${data.open_fiche}'>
					&lt;div title="Fiche détaillée de l'objet" ${draggableEventData} id='data_${tableName}_${values.id}'>`;
			} else {
				ret += '">&lt;div class="not-open">';
			}
			var id = values.id + '_' + tableName;
			ret += `
				&lt;div id="${id}" class="d-flex align-items-center justify-content-start p-1">
					&lt;p class="m-0 mr-auto col pl-0 pr-1">${libelle}&lt;/p>
					${isigeoGUI.getBtnInforapLine(deftable, eventApply, values, isSelection, data.open_fiche, callbackModify)}
				&lt;/div>
			&lt;/div>`;
			if (typeof values.affichage_rapide != 'undefined' &amp;&amp; values.affichage_rapide) {
				const nbLine = isigeoSession.defTables[tableName].defmod.filter(el => el.inforap === 'Y').length;

				ret += `
				&lt;div id="inforap_${deftable.nom}_${values.id}" class="collapse border-top border-bottom container">
					${layoutManager.skeletonLoader({
						format: 'inforap',
						nbLine,
					})}
				&lt;/div>`;
			}

			ret += '&lt;/div>';
			ret += script;

			return ret;
		},

		/**
		 * @param {Deftable} deftable
		 * @param {String} eventApply
		 * @param {object} values
		 * @return {String|Boolean}
		 * 
		 * @ignore
		 */
		getBtnSpeedAdd(defTable, eventApply, values) {
			const { level, nom } = defTable;
			const { id, libelle } = values;

			if (level === '1') {
				// On récupéère les enfants
				const childs = isigeoSession.getDeftableWhere('pere', nom);

				if (childs.length > 0) {
					// On récupère maintenant les enfants avec speed_add à 'Y' + droit en ajout
					const speedAdd = childs.filter(child => child.speed_add === 'Y' &amp;&amp; isigeoSession.haveRight(child.nom, isigeoSession.CREATE));
					
					if (speedAdd.length > 0) {
						const tablesNames = childs.map(child => child.nom);
						const tablesLibelle = childs.map(child => child.libelle);
						const title = `Ajouter une fiche liée à ${nom} ${libelle}`;

						return `&lt;button type="button" class="btn text-primary p-0 d-inline-flex" on${eventApply}="event.stopPropagation();Query.speedAdd(${id}, '${tablesNames.join(';')}', '${tablesLibelle.join(';')}')" title="${title}">
						&lt;i class="icon icon-actions-page-new ico-h2">&lt;/i>
						&lt;/button>`;
					}
				}
			}

			return false;
		},

		/**
		 *
		 * @param {ValuesInforap} data
		 * @param {String} tableName Nom de la table
		 * @param {Boolean} isSelection
		 * @param {Boolean} draggable
		 *
		 * @ignore
		 */
		addInforapContentLine: function (data, tableName, isSelection, draggable) {
			var html = isigeoGUI.getInforapContentLine(data, tableName, isSelection, true, true, draggable, 0, null);
			if (html != '' &amp;&amp; html != null) {
				var nbObjLayer = parseInt($jq('#nb_result_' + tableName).text());
				if ($jq('#' + data.id + '_' + tableName).length > 0) {
					$jq('#' + data.id + '_' + tableName).remove();
					if (nbObjLayer &lt;= 0) {
						$jq('#' + tableName).remove();
						$jq('#tooltip_' + tableName).remove();
						$jq('#container_result_' + tableName).remove();
					} else {
						$jq('#nb_result_' + tableName).text(nbObjLayer - 1);
					}
				} else {
					$jq('#tooltip_' + tableName).prepend(html);
					$jq('#nb_result_' + tableName).text(nbObjLayer + 1);
				}
			}
			if (typeof Viewer != 'undefined' &amp;&amp; typeof Viewer.locateOnAddSelection[tableName] != 'undefined' &amp;&amp; Viewer.locateOnAddSelection[tableName]) {
				Viewer.locateSelectionTable(tableName, {
					centerOnLocate: false,
				});
			}
		},

		/**
		 *
		 * @param {ObjDataInforap} data
		 * @param {String} tableName
		 * @param {Boolean} isSelection
		 *
		 * @ignore
		 */
		addInforapContentTable: function (data, tableName, isSelection) {
			isigeoSession.data = data;
			var html = isigeoGUI.getInforapContentTable(data, tableName, false, isSelection, true);
			$jq('#inforap_container').prepend(html);
		},

		/**
		 *
		 * @param {String} tableName
		 * @param {ObjDataInforap} data
		 *
		 * @ignore
		 */
		addOtherToDeftables: function (tableName, data) {
			if (typeof isigeoSession.defTables == 'undefined') {
				isigeoSession.defTables = {};
			}
			var keys = Object.keys(isigeoSession.defTables);
			if (!keys.includes(tableName) || typeof isigeoSession.defTables[tableName].nature == 'undefined') {
				var obj = data[tableName];
				isigeoSession.defTables[tableName] = obj;
				isigeoSession.defTables[tableName].inforap = 'inforap';
				if (typeof isigeoSession.defTables[tableName].defmod == 'undefined') {
					isigeoSession.defTables[tableName].defmod = Object.keys(data[tableName].values[0]);
				}
			}
		},

		/**
		 * Initialise les events "draggable" vers le planning
		 * @ignore
		 */
		initDragEvents: function () {
			if (isigeoGUI.draggableEvent != null) {
				isigeoGUI.draggableEvent.destroy();
			}
			
			const targetNode = document.querySelector('#agenda_events');

			if (targetNode) {
				isigeoGUI.draggableEvent = new FullCalendar.Draggable(targetNode, {
					itemSelector: '.draggable-el',
					eventData: function (eventEl) {
						return {
							title: eventEl.innerText
						};
					}
				});
			}
		},

		/**
		 *
		 * @param {String} resDefault
		 * @param {Number} nbObj
		 * @param {String} selector
		 * @param {Boolean} toggleOnly
		 *
		 * @ignore
		 */
		initPopoverDefault: function (resDefault, nbObj, selector, toggleOnly,callbackFunction) {
			var contentEmpty = '';
			if (typeof selector == 'undefined') {
				selector = '#restoredefault';
			}
			if (typeof toggleOnly == 'undefined') {
				toggleOnly = false;
			}
			if (typeof $jq(selector).data('bs.popover') == 'undefined') {
				if (typeof resDefault == 'undefined') {
					contentEmpty = '&lt;div class="alert alert-warning m-0">Aucun objet sélectionné&lt;/div>';
				}
			} else {
				$jq(selector).popover('toggle');
				if (typeof resDefault == 'undefined' || toggleOnly) {
					return;
				} else {
					$jq(selector).popover('dispose');
				}
			}
			var content = '&lt;div id="tipdefault" class="m-0" role="alert">';
			content += 'Objets dans la s&amp;eacute;lection : &lt;span class="badge badge-light">' + nbObj + '&lt;/span>';
			content += resDefault;
			content += '&lt;/div>';

			if (contentEmpty != '') {
				content = contentEmpty;
			}

			if ($jq('#tipdefault').length > 0) {
				$jq(selector).popover('dispose');
			}

			//if ($jq('#tipdefault').length == 0) {

			$jq(
				$jq(selector)
					.popover({
						content: content,
						delay: {
							show: 100,
							hide: 100,
						},
						html: true,
						placement: 'right',
						template: `&lt;div class="popover border popover-default" data-btnorigin="${selector}" role="tooltip">&lt;div class="arrow">&lt;/div>&lt;div class="popover-body text-center shadow">&lt;/div>&lt;/div>`,
						trigger: 'manual',
						sanitize: false,
						boundary: 'window',
					})
					.popover('show')
			);

			if(typeof callbackFunction == "function"){
				callbackFunction();
			}
		},

		/**
		 *
		 * @param {String} tableName Nom de la table
		 * @param {ObjDataInforap} data
		 *
		 * @ignore
		 */
		getPopoverDefaultFromSelection: function (tableName, data = {}) {
			if (typeof data != 'undefined' &amp;&amp; typeof data[tableName] != 'undefined' &amp;&amp; data[tableName].values.length > 0) {
				var valuesObj = data[tableName].values;
				var idTable = isigeoSession.defTables[tableName].id;
				var objects = [];
				for (var i = 0; i &lt; valuesObj.length; i++) {
					objects.push(valuesObj[i].id);
				}

				var param = 'cmd=tipAuto&amp;objects=' + JSON.stringify(objects) + '&amp;layer=' + idTable;

				DataGUI.ar_selectOne = $jq.ajax({
					type: 'POST',
					dataType: 'html',
					url: 'lib/xhr_data.php',
					data: param,
					success: function (r) {
						var part = checkAjaxStatus('~', r, this);

						if (!part) {
							return false;
						}

						var result = r.split('~');

						// WindowManager.hideMessage();

						if (result[0] !== '') {
							if (result[0] == '2') {
								isigeoGUI.getError('2');

								return;
							} else {
								console.error(result[0]);
							}
						} else {
							isigeoGUI.initPopoverDefault(result[1], objects.length, '#exec-func-' + tableName, !isigeoGUI.selectionHasNewValues);
							isigeoGUI.selectionHasNewValues = false;
						}
					},
				});
			}
		},

		/**
		 * Affiche la sélection dans l'onglet Données
		 *
		 * @param {String} tableName Nom de la table
		 * @param {ObjDataInforap} objSelection Objet contenant la sélection (isigeoGUI.objSelection)
		 *
		 * @ignore
		 */
		openDataSelectionTable: function (tableName, objSelection) {
			if (layoutManager.fullScreenEnabled &amp;&amp; document.fullscreenElement) {
				layoutManager.toggleFullscreen(document.fullscreenElement);
			}

			const valuesObj = objSelection[tableName].values;
			const idUniqueTable = isigeoSession.defTables[tableName].idunique;
			let whereSQL = '"' + tableName + '".' + '"' + idUniqueTable + '" IN (';
			// Boucle sur les id
			for (let i = 0; i &lt; valuesObj.length; i++) {
				if (typeof valuesObj[i].id === 'undefined') {
					whereSQL += valuesObj[i][idUniqueTable] + ',';
				} else {
					whereSQL += valuesObj[i].id + ',';
				}
			}
			whereSQL = whereSQL.slice(0, -1);
			whereSQL += ')';

			isigeoGUI.search(tableName, {
				where: whereSQL,
				target: 'DATA',
			});
		},

		/**
		 * Export au format CSV la sélection
		 *
		 * @param {String} tableName Nom de la table
		 * @param {ObjDataInforap} objSelection Objet contenant la selection (isigeoGUI.objSelection)
		 *
		 * @ignore
		 */
		exportCSVselectionTable: function (tableName, objSelection, exportPublipostage = false) {
			const valuesObj = objSelection[tableName].values;
			const idUniqueTable = isigeoSession.defTables[tableName].idunique;
			let whereSQL = '"' + tableName + '".' + '"' + idUniqueTable + '" IN (';
			// Boucle sur les id
			for (let i = 0; i &lt; valuesObj.length; i++) {
				if (typeof valuesObj[i].id === 'undefined') {
					whereSQL += valuesObj[i][idUniqueTable] + ',';
				} else {
					whereSQL += valuesObj[i].id + ',';
				}
			}
			whereSQL = whereSQL.slice(0, -1);
			whereSQL += ')';

			isigeoGUI.search(tableName, {
				where: whereSQL,
				exportCSV: true,
				exportPublipostage: exportPublipostage,
			});
		},

		/**
		 * Ajout de thematiques à la carte en mode API
		 *
		 * @param {Array&lt;Number|String>} ids Tableau contenant les identifiants de la carte
		 * @param {Object} options objet d'options
		 * @param {Array&lt;Object>} options.layers Tableau d'objet
		 * @param {String} options.layers.name Nom du layer
		 * @param {String} options.layers.status Statut 'ON' ou 'OFF'
		 * @ignore
		 * @example
		 * isigeoGUI.addthema([26,76], {
		 * 	layers : [
		 *		{ name : 'ec_poste', status :'OFF'},
		 *		{ name : 'support', status :'OFF'}
		 *	]
		 * })
		 */
		addthema: function (ids, options) {
			// On désactive la sauvegarde du html de l'onglet layer control pour qu'il se mette a jour quand on active une thema
			if (typeof ToolsGUI.myAccordion.layercontrol_div.savedHTML != 'undefined') {
				ToolsGUI.myAccordion.layercontrol_div.savedHTML = null;
			}
			// Si on a des options de layers on les appliquent :
			// if (typeof options != 'undefined' &amp;&amp; typeof options.layers != 'undefined') {
			// 	Viewer.activeLayer(options.layers, false);
			// }

			if (typeof options != 'undefined' &amp;&amp; typeof options.clear != 'undefined' &amp;&amp; options.clear == true) {
				for (let i = 0; i &lt; Thematic.FieldObs.length; i++) {
					let current_ind = $jq.parseJSON(Thematic.FieldObs[i]);
					// clear que s'il n'est pas demandé dans la liste des ids a afficher
					if (ids.indexOf(parseInt(current_ind.id_ind)) &lt; 0) {
						if ($jq('#hide_' + current_ind.id_ind).length > 0 &amp;&amp; current_ind.status == 'on') {
							$jq('#hide_' + current_ind.id_ind).trigger('click');
						}
					}
				}
			}
			// Boucle sur les id des thematics
			for (let i = 0; i &lt; ids.length; i++) {
				// Commenté car oblige la théma à rester ON et empeche le retrait des objet de la carte à la fermeture de la dialog thématique
				if (typeof Viewer !== 'undefined' &amp;&amp; Viewer.layers &amp;&amp; options &amp;&amp; options.layers[0]) {
					const name = options.layers[i].name;
					const match = Viewer.layers.match(name);

					// on récupère l'etat de la thématique pour gérer l'affichage dans le layer tree
					if (match &amp;&amp; name === match[i]) {
						Thematic.lastStatus[name] = 'ON';
					} else {
						Thematic.lastStatus[name] = 'OFF';
					}
				}

				const status = options &amp;&amp; options.layers ? options.layers[i].status : 'ON';
				// dernier tour de boucle : on refresh la carte.
				if (i == ids.length - 1) {
					Thematic.addIndFromObs(ids[i], true, status);
				} else {
					// Pour chaque element on active la thema
					Thematic.addIndFromObs(ids[i], false, status);
				}
			}
		},

		/**
		 * Permet de changer l'onglet a partir de son nom
		 *
		 * @param {String} name Nom de l'onglet
		 *
		 * @ignore
		 */
		setTabByName: function (name, arg) {
			if (isigeoGUI.getCurrentTab() == name) {
				return;
			}

			for (var i = 0; i &lt; isigeoGUI.tab.length; i++) {
				if (isigeoGUI.tab[i].name == name) {
					isigeoGUI.setTab(i, arg);
					break;
				}
			}
		},

		/**
		 * Génère le HTML d'un spinner
		 *
		 * @param {boolean} posAbsolute Bool pour pos absolute ou non (true par défaut)
		 * @param {string} id id du spinner ('spinner' par défaut)
		 * @param {boolean} hidden bool pour display:none (false par défaut)
		 * @param {boolean} addPading bool pour ajouter du padding en position relative (true par défaut)
		 *
		 * @return {string} HTML du spinner
		 *
		 * @ignore
		 */
		spinner: function (posAbsolute = true, id = 'spinner', hidden = false, addPading = true, small = false) {
			const padding = addPading ? 'py-5' : '';

			let html = '';
			let sm = '';

			if (small) {
				sm = ' spinner-border-sm';
			}

			if (typeof Query != 'undefined') {
				Query.idSpinner = id;
			}

			hidden = hidden ? 'display:none;' : '';
			if (posAbsolute) {
				html = `
				&lt;div id="${id}" class="spinner-border text-primary position-absolute${sm}" role="status" style="top:0;left:0;bottom:0;right:0;z-index:9;margin:auto;${hidden}">
					&lt;span class="sr-only">Loading...&lt;/span>
				&lt;/div>`;
			} else {
				html = `
				&lt;div id="${id}" class="text-center ${padding}">
					&lt;div class="spinner-border text-primary${sm}" role="status" style="z-index:9;'${hidden}">
						&lt;span class="sr-only">Loading...&lt;/span>
					&lt;/div>
				&lt;/div>`;
			}
			return html;
		},

		/**
		 * Début des méthodes
		 */

		/**
		 * Initialisation de l'interface qu'on soit en mode public ou non
		 *
		 * @param  {String} param  Parametre à envoyer au serveur
		 * @param  {Object} aParam  Objet des parametre
		 *
		 * @ignore
		 */
		initEventLoad: function (param, aParam) {
			//On init le layout
			this.initContent(aParam);

			/* Fix event resize pour la gestion du Layout Bootstrap */
			$jq(document).ready(function () {
				//On dimension au démarrage
				isigeoGUI.dimWindow();

				//Init le plugin pour le slider
				isigeoGUI.accordionSlidebar = new $jq.slidebars({
					siteClose: false,
				});

				//Puis on fix la fonction au resize de la fenetre
				$jq(window).resize(isigeoGUI.dimWindow);

				//Pour les grid ZL => Desactive la grid si on click en dehors de la grid
				$jq('body').on('click', function (e) {
					//only buttons
					if ($jq(e.target).data('togglegridzl') !== 'popover' &amp;&amp; $jq(e.target).parents('.popover.in').length === 0) {
						$jq('.popover-grid-zl').popover('hide');
					}
				});
			});

			//On initialise le contenu
			this.init(param);
		},

		//On défini la hauteur du div principal qui aura le contenu
		dimWindow: function () {
			isigeoGUI.hauteurMain = $jq(window).height() - $jq('header').height() - $jq('footer').height();
			$jq('#wrapper, #toolsbar, #panel-A, #panel-B').css('height', isigeoGUI.hauteurMain + 'px');
			var sidebarContentHeight = $jq('.sb-left').height() - $jq('#tools .card-header').outerHeight();
			$jq('#content-panel-sidebar').css('height', sidebarContentHeight + 'px');
			if (layoutManager.visible.length == 2 &amp;&amp; window.innerWidth &lt; 768) {
				$jq('#panel-A, #panel-B').css('height', isigeoGUI.hauteurMain / 2 + 'px');
			}

			//Fermeture du navbar
			if ($jq('#navbar').attr('aria-expanded') == 'true') {
				$jq('#navbar').collapse('hide');
			}

			if ($jq('.sb-left').length > 0) {
				$jq('.sb-left').css('height', isigeoGUI.hauteurMain);
				$jq('.sb-left').css('top', $jq('header').height());
			}

			if (!$jq('#main-menu').hasClass('navbar-nav') &amp;&amp; $jq(window).width() &lt;= 767) {
				$jq('#main-menu').addClass('navbar-nav');
				//$jq('#main-menu , .btn-main-menu').css('float','none');
			} else if ($jq('#main-menu').hasClass('navbar-nav') &amp;&amp; $jq(window).width() > 767) {
				$jq('#main-menu').removeClass('navbar-nav');
				//$jq('#main-menu , .btn-main-menu').css('float','left');
			}
		},

		/**
		 * Initialise le layout selon le profil de l'utilisateur
		 *
		 * @param  {Array} request Tableau des arguments à passer dans nos INPUT du main
		 * @ignore
		 */
		initContent: function (request) {
			var navbar = '';

			/*$jq.keepalive.configure({
				url : 'services/lib/keepalive.php',
				interval : 900000, // 15min
				successCallback : function(){
					console.log('success keepalive');
				},
				errorCallback : function(){
					console.log('error keepalive');
				}

			});
			$jq.keepalive.stop();*/

			//Si on est pas en mode MIGP, on met le bandeau
			//if(this.nature != "WEB"){
			//$jq('#navbar').show();

			var bandeau =
				'&lt;div id="bandeau" class="row d-none d-lg-block bandeau">&lt;div class="col">&lt;div class="img-fluid logo_domain" alt="Logo Geomatika">&lt;/div>&lt;table id="info_chargement">&lt;tbody>&lt;tr>&lt;td id="mapfile_info">&lt;/td>&lt;td id="time">&lt;/td>&lt;/tr>&lt;/tbody>&lt;/table>&lt;/div>&lt;/div>';

			$jq('#menu').parent().prepend(bandeau);

			var btnPAMGIS = '';
			var btnUser = '';
			var btnDeco = '';

			var btnAbout =
				'&lt;button class="btn btn-info btn-isigeo-nav" role="button" onclick="isigeoGUI.about();" title="A propos">&lt;span class="icon icon-info" aria-hidden="true">&lt;/span>&lt;/button>';

			// On affiche le bouton PAMGIS pour le mcd pamgis seulement
			if (this.domain == 'pam') {
				btnPAMGIS = '&lt;li class="dropdown btn-main-menu">&lt;button role="button" onclick="btnPAMGIS();">PAMGIS&lt;/button>&lt;/li>';
			}
			//Sinon on est en MIGP
			if (this.nature == 'WEB') {
				$jq.keepalive.start();
				$jq('.btn-selection-migp').show();

				$jq('#right-panel-main').html(
					'&lt;div class="alert alert-info" role="alert" style="text-align:center;width:100%;">&lt;span class="icon icon-info">&lt;/span> &lt;p> Cliquez sur la carte pour obtenir des informations concernant les éléments sélectionnés &lt;/p>&lt;/div>'
				);
			} else {
				btnDeco =
					'&lt;button class="btn btn-danger btn-isigeo-nav" role="button" onclick="isigeoGUI.exit();" title="Déconnexion">&lt;span class="icon icon-power-off">&lt;/span>&lt;/button>';
				//var btnUser = '&lt;button class="btn btn-primary btn-isigeo-nav" role="button" onclick="isigeoGUI.userProfil();" title="Profil utilisateur">&lt;span class="icon icon-user">&lt;/span>&lt;/button>';
			}

			navbar =
				'&lt;ul class="nav nav-pills" id="main-menu" style="float:left;margin-top:4px;">' +
				btnPAMGIS +
				'&lt;/ul>&lt;div class="nav justify-content-end w-100">' +
				btnUser +
				btnAbout +
				btnDeco +
				'&lt;/div>';
			//	}

			//On ajoute le navbar
			$jq('#isigeo_navbar').append(navbar);
			$jq('.btn-accordion-migp').show();

			//On prépare nos infos de formulaire invisible
			var invForm = '';

			var currentstate = '';
			var ROSA_CMD = '';
			var layerref = '';
			if (request.currentstate &amp;&amp; request.currentstate !== '') {
				currentstate = request.currentstate;
			}
			if (request.ROSA_CMD &amp;&amp; request.ROSA_CMD !== '') {
				ROSA_CMD = request.ROSA_CMD;
			}
			if (request.layerref &amp;&amp; request.layerref !== '') {
				layerref = request.layerref;
			}

			invForm += '&lt;input type="hidden" name="PrevStateKey" value="' + currentstate + '" />';
			invForm += '&lt;input type="hidden" name="INPUT_COORD" value="" />';
			invForm += '&lt;input type="hidden" name="ROSA_CMD" value="' + ROSA_CMD + '" />';
			invForm += '&lt;input type="hidden" name="situ_x" value="" />';
			invForm += '&lt;input type="hidden" name="situ_y" value="" />';
			//Variable pour la gestion par page pour la recherche dans Query pour la duplication de fiche
			invForm += '&lt;input type="hidden" name="deb" value="0" />';
			//Elements de formulaires de la fiche
			invForm += '&lt;input type="hidden" name="layerref" value="' + layerref + '" />';
			invForm += '&lt;input type="hidden" name="modif" value="" />';
			invForm += '&lt;input type="hidden" name="idunique" value="" />';
			invForm += '&lt;input type="hidden" name="idpere" value="" />';

			$jq('#main').append(invForm);

			$jq(document).on('click', '.btn-main-menu > a', function () {
				var heightLimit = $jq(window).height() - $jq('header').height() + 1;
				if ($jq(this).parent().hasClass('open') &amp;&amp; $jq('#isigeo_navbar').height() > heightLimit) {
					$jq('#isigeo_navbar').css('height', heightLimit);
				} else {
					$jq('#isigeo_navbar').css('height', '');
				}
			});

			//Fermeture du menu responsive lors de la sélection d'un élément
			$jq(document).on('click', '#isigeo_navbar li', function () {
				if (!$jq(this).hasClass('btn-main-menu')) {
					if ($jq('#isigeo_navbar').hasClass('collapse in')) {
						$jq('#isigeo_navbar').collapse('hide');
					}
				}
			});
		},

		/**
		 * Initialise l'interface du MIGP, ATTENTION : Sera override si on n'est pas en mode MIGP
		 * @param  {string} param
		 * @param  {function} callbackInit fonction callback de l'init d'isigéo
		 *
		 * @ignore
		 */
		init(param, callbackInit) {
			// Ici on est obligé d'utiliser performance.navigation (déprécié) pour firefox
			this.pageWasRefreshed =
				typeof performance.getEntriesByType('navigation')[0] === 'undefined'
					? performance.navigation.type === 1
					: performance.getEntriesByType('navigation')[0].type === 'reload';

			if (this.xhr_init &amp;&amp; this.xhr_init !== null) {
				this.xhr_init.abort();
			}
			// Detection du mode tactile
			try {
				this.tactil = 'ontouchstart' in window || navigator.msMaxTouchPoints > 0;
			} catch (e) {}
			//On va recupere la resolution de l'ecran
			var w = $jq(window).width();
			var h = $jq(window).height();

			param = 'cmd=init&amp;' + param + '&amp;w=' + w + '&amp;h=' + h;
			this.paramInit = param;

			var _this = this;
			// Changement de carte : on pete le viewer pour eviter que des
			//requete ( getMap) surcouche le parametrage en cours ..
			if (typeof Viewer != 'undefined' &amp;&amp; typeof Viewer.map != 'undefined') {
				Viewer.map = null;
			}
			this.xhr_init = $jq.ajax({
				url: _isigeoGUI.file,
				type: 'POST',
				async: true,
				data: param,
				success: function (responseText) {
					var part = checkAjaxStatus('~', responseText, _this.xhr_init, true);
					if (part == 'session_out') {
						return;
					}

					var myInitJson = $jq.parseJSON(responseText);
					layoutManager.resIsigeoInit = myInitJson;

					//Si on a une erreur, on l'affiche en continu
					if ((myInitJson.error &amp;&amp; myInitJson.error.length > 0) || myInitJson.message) {
						const errors = myInitJson.error ? myInitJson.error.join('&lt;br/>') : myInitJson;

						layoutManager.modalAlert("Erreur lors de l'initialisation", null, errors);
						//On stop l'utilisateur ici, s'il y a un probleme
						return;
					}

					// Affectation du resultat
					_this.hardwareFormat = myInitJson.hardwareFormat;
					_this.isIPhone = myInitJson.isIPhone;
					_this.domain = myInitJson.domain;
					_this.domainUrl = myInitJson.domainUrl;
					_this.mcd = myInitJson.mcd;
					_this.nature = myInitJson.nature;
					_this.statut = myInitJson.statut;
					_this.layers = myInitJson.layers;
					_this.ign_key = myInitJson.ign_key;
					_this.idMap = myInitJson.idMap;
					_this.session = myInitJson.session;
					_this.routingEnabled = myInitJson.routingEnabled;
					_this.localiseSubtitle = myInitJson.localiseSubtitle;
					_this.code_postal = myInitJson.code_postal;
					_this.js_files = myInitJson.js_files;
					_this.html = myInitJson.html;
					_this.tab = myInitJson.tab;
					_this.isApps = myInitJson.isApps;
					_this.themesAvailable = myInitJson.themesAvailable;
					_this.theme = myInitJson.theme ? myInitJson.theme : 'extras/bootstrap/css/bootstrap.min.css';
					_this.i18nZL = myInitJson.i18nZL;
					_this.legend = isJSON(myInitJson.legend) ? JSON.parse(myInitJson.legend) : myInitJson.legend;
					_this.lang = myInitJson.lang;
					_this.nbpp = myInitJson.nbpp;
					_this.defaultNbpp = myInitJson.nbpp;
					_this.applicationsMCD = myInitJson.applicationsMCD;
					// Init variables session isigeo
					isigeoSession.defTables = myInitJson.defTables;
					isigeoSession.allowDraw = myInitJson.allowDraw;
					isigeoSession.allowAddLayerUTIL = myInitJson.allowAddLayerUTIL;
					isigeoSession.domain = myInitJson.domain;
					// Pour requeteur si onglet Data jamais ouvert depuis le debut de la session
					_this.dataList = myInitJson.dataList;
					if (typeof myInitJson.maintenance != 'undefined' &amp;&amp; myInitJson.maintenance != '') {
						_this.maintenance = myInitJson.maintenance;
					}
					_this.matcadURL = myInitJson.matcadURL;

					//Si on a le formulaire
					/*			if(_this.options.menu.search){
									var form = '&lt;input type="text" class="form-control" placeholder="Rechercher..."  aria-describedby="basic-addon1">&lt;span class="input-group-addon" id="basic-addon1">&lt;i class="icon icon-search" aria-hidden="true">&lt;/i>&lt;/span>';
									$jq('#formDiv').append(form);
								}
			
								//Si on a la legende
								var btn = '';
								if(myInitJson.window.legende){
									btn += '&lt;a type="button" class="btn btn-default add-margin" id="'+myInitJson.window.legende.name+'" onclick="'+myInitJson.window.legende.onClick+'">&lt;span class="glyphicon glyphicon-' + myInitJson.window.legende.glyphicon + '">&lt;/span>&amp;nbsp;&amp;nbsp;'+myInitJson.window.legende.libelle+'&lt;/a>';
								}
			
								//Si on a l'export KML
								if(_this.options.menu.exportdata){
									btn += '&lt;a type="button" class="btn btn-default add-margin" id="exportData" onclick="isigeoGUI.exportKML();">&lt;span class="glyphicon glyphicon-cloud-download">&lt;/span>&lt;/a>';
								}
								
								//Et pour finir, le about
								if(myInitJson.window.about){
									btn += '&lt;a type="button" class="btn btn-default add-margin" id="'+myInitJson.window.about.name+'" onclick="'+myInitJson.window.about.onClick+'">&lt;span class="glyphicon glyphicon-' + myInitJson.window.about.glyphicon + '">&lt;/span>&lt;/a>';
								}
			
								$jq('#formDiv').parent().append(btn);
								*/
					// Si on veut se localiser directement sur un objet via les params de l'inline
					if (myInitJson.inlineLocate) {
						_this.inlineLocate = myInitJson.inlineLocate;
					}

					//Menu Cartes
					if ($jq('#dropdown-cartes').length &lt;= 0 &amp;&amp; typeof myInitJson.html.menuCartes != 'undefined') {
						$jq('#menu .justify-content-end').prepend(myInitJson.html.menuCartes);
					}

					//menu de synchro
					if ($jq('#menu-synchro').length &lt;= 0 &amp;&amp; typeof myInitJson.html.synchro != 'undefined') {
						$jq('#menu .justify-content-end').prepend(myInitJson.html.synchro);
					}

					//Bouton administration
					if (typeof myInitJson.html.administration != 'undefined' &amp;&amp; $jq('#btn-menu-admin').length &lt;= 0) {
						$jq('#menu .justify-content-end').prepend(myInitJson.html.administration);
					}

					//Bouton matcad
					if (typeof myInitJson.html.matcad != 'undefined' &amp;&amp; $jq('#btn-menu-matcad').length &lt;= 0) {
						$jq('#menu .navbar-right').prepend(myInitJson.html.matcad);
					} else if (myInitJson.html.matcad == '' &amp;&amp; $jq('#btn-menu-matcad').length > 0) {
						$jq('#btn-menu-matcad').remove();
					}

					if (myInitJson.layoutOptions) {
						_this.layoutOptions = myInitJson.layoutOptions;
						//_this.manageLayout();
					}

					// Gestion du filtre Strate par défault
					if (typeof myInitJson.jsonStrate != 'undefined' &amp;&amp; myInitJson.jsonStrate.length > 0) {
						//Si la classe Strate n'est pas chargé on va faire un pont depuis la classe isigeoGUI qui sera recup par le chargement de la classe Strate
						if (typeof Strate == 'undefined') {
							isigeoGUI.defaultStrate = myInitJson.jsonStrate;
						} else {
							//Sinon on va reinitiliser la var de classe Strate avec les bonnes valeurs
							Strate.defaultStrate = $jq.parseJSON(myInitJson.jsonStrate);
							//On lance le filtrage généralisé par la même ocaz vu qu'on a accès à la fonction
							Strate.executer(true);
						}
					} else {
						//Si on a aucune strate par défault on va supprimer ce qu'on avait en mémoire au cas ou sur le dernier MCD
						if (typeof Strate != 'undefined') {
							delete Strate.defaultStrate;
						}
					}

					//Ouvert par default (seulement sur desktop et tablette) (Voir pour utiliser "isigeoGUI.hardwareFormat" pour detecter le mobile
					//mais il faudrait passer dans l'init avant du coup)
					/*  if ( ( (screen.width  > 480) &amp;&amp; (screen.height > 800) ) &amp;&amp; (typeof _this.layoutOptions.open_sidebar_startup == "undefined" || _this.layoutOptions.open_sidebar_startup != "N" ) ) {
							  isigeoGUI.accordionSlidebar.slidebars.toggle('left');
					  }*/

					//Quand nos librairies additionelle sont chargé
					//Ici, dans la fonction on ne fait plus appel a "_this" mais a isigeoGUI car il n'a plus la porté dans la fonction
					const onComplete = function (callbackInit) {
						//On efface le contenu de notre ancienne onglet avant d'afficher le nouveau
						/*if(isigeoGUI.currentTabName){
							isigeoGUI.tab[isigeoGUI.currentTab].className.clear();
						}*/
						isigeoGUI.currentTabName = null;
						isigeoGUI.currentTab = 0;

						//Si on a passer le mode en param, on va le recuperer
						if (param &amp;&amp; param != '' &amp;&amp; param.indexOf('mode') >= 0) {
							var parametre = param.split('&amp;');

							//On boucle sur nos params pour voir
							for (var i = 0; i &lt; parametre.length; i++) {
								//On separer la cle de la valeur
								var data = parametre[i].split('=');

								//si on a notre mode
								if (data[0] == 'mode') {
									isigeoGUI.currentTabName = data[1];
								}
							}
						}

						try {
							//Nos onglets actuels
							var tab = myInitJson.tab;

							$jq('[name="PrevStateKey"]').val(myInitJson.szCurrentState);

							//On supprime les anciens onglets
							/*if(isigeoGUI.tab.length>0){
						
								for(i = 0; i &lt; isigeoGUI.tab.length; i++)
								{
									//Supprime du DOM
									if(typeof isigeoGUI.tab[i] != "undefined" &amp;&amp; typeof isigeoGUI.tab[i].name != "undefined" ){
										isigeoGUI.removeTab(isigeoGUI.tab[i].name);

										//Mais egalement du tableau
										delete isigeoGUI.tab[i];
									}
									
								}
						
							}*/

							let enable = false;

							const callback = function () {
								isigeoGUI.onComplete(callbackInit);
							};

							//On va parcourir les onglets isigéo à mettre en place
							for (let i = 0; i &lt; tab.length; i++) {
								//La en fait, on va recuperer la referrence de la classe JS GUI qui correspond à l'onglet traité dans cette itteration
								//de cette façon, plus tard on pourra appeller les méthodes de ces classes via "tab[i].className.foo();"
								//Ce qui equivaudrait "DataGUI.foo();" si on traite l'onglet Data
								tab[i].className = window[tab[i].className];

								//Mise en mémoire de cet onglet dans isigeoGUI.tab
								isigeoGUI.tab[i] = tab[i];

								if (i == isigeoGUI.currentTab || (isigeoGUI.currentTabName !== null &amp;&amp; isigeoGUI.currentTabName === isigeoGUI.tab[i].name)) {
									//Notre onglet active
									isigeoGUI.addTab(i, tab[i], true);
									isigeoGUI.currentTab = i;
									isigeoGUI.currentTabName = isigeoGUI.tab[i].name;

									enable = true;

									if (isigeoGUI.currentTabName === 'data') {
										// En cas d'appli alpha on merge tous les tools
										let allTools = tab.filter(t => t.tools.length > 0);
										let tools = [];

										if (allTools.length > 0) {
											tools = [...new Set([].concat(...tab.filter(t => t.tools.length > 0).map(el => el.tools)))];
										}

										tab[i].tools = tools;

										if (tab[i].tools &amp;&amp; tab[i].tools.length > 0) {
											const partURLExt = tab[i].tools[0]['url'].split('.');
											let name = '';
											//Si l'url est dans un sous doss
											if (partURLExt.indexOf('/')) {
												var partURL = partURLExt[0].split('/');
												name = partURL[partURL.length - 1];
											} else {
												name = partURLExt[0];
											}

											var index = null;
											if (typeof tab[i].tools[0]['index'] !== 'undefined') {
												index = tab[i].tools[0]['index'];
											}
											//Maintenant on peut init les accordions
											ToolsGUI.init(tab[i].tools, name, index, callback);
										} else {
											callback();
										}
									} else {
										isigeoGUI.tab[i].className.init('panel', {
											url: param,
											options: tab[i],
											onComplete: callback,
										});
									}
								} else {
									isigeoGUI.addTab(i, tab[i], false);
								}
							}

							if (typeof isigeoGUI.bindPostMessage == 'function') {
								isigeoGUI.bindPostMessage();
							}

							//Pour savoir si isigeo est activé
							if (!enable) {
								isigeoGUI.enabled = true;
							}
						} catch (e) {
							alertifyCatchError("Erreur d'initialisation de l'onglet - " + e.message, 'error', 0, e);
						}
					};

					//On va d'abord charger les nouveaux fichier JS dont nous avons besoin
					/*	if(myInitJson.newFile &amp;&amp; myInitJson.newFile.length > 0)
						{
							//On va tenter de charge nos fichiers qui depende des foncitonnalités besoin
							try{
								IsigeoLoad.loadJSScripts(myInitJson.newFile, onComplete);
							}
							catch(e){
								alertifyCatchError('Erreur de chargement des fichiers additionnels.','error',10000,e);
							}
						}
						// Si on est en IsiGéo ADMIN et qu'on aboutit sur l'onglet MAP on charge les groupes isigeo_map ,isigeo_proj, isisgeo_dessin
						else if(myInitJson.activeTab == "MAP" &amp;&amp; isigeoGUI.nature != "WEB"){
							// var percProgress = Math.round(35/tabJSGroupeLengthMap.length);
							// IsigeoLoad.loadJSScripts(tabMap, onComplete,percProgress);
						}
						// Si on est en IsiGéo ADMIN et qu'on aboutit sur un autre onglet que l'onglet MAP, on fini l'animation de la progressbar
						else if(myInitJson.activeTab != "MAP" &amp;&amp; isigeoGUI.nature != "WEB"){
							// Definir des endroits où alimenter la progressbar dans le cas où on aboutit ailleurs que sur l'onglet MAP
							IsigeoLoad.indicePGBar += 65;
							
						}
						//Sinon on peut directement lancer notre fonction
						else {*/
					isigeoGUI.initCKEDITOR();

					if (myInitJson.activeTab === 'DATA' &amp;&amp; typeof layoutManager.isJSFileLoaded.data === 'undefined') {
						layoutManager.loadJSFile('data', () => {
							onComplete(callbackInit);
						});
					} else {
						onComplete(callbackInit);
					}
					//	}
				},
			});
		},

		onComplete: function (callbackInit) {
			isigeoGUI.enabled = true;
			if (typeof callbackInit == 'function') {
				callbackInit();
			}
		},

		/**
		 * Permet de changer l'onglet
		 * @param {Integer} tab Indice de l'onglet dans le tableau
		 * @ignore
		 */
		setTab(tab, arg) {
			try {
				//Que isigeo, soit bien activé (chargement terminé)
				if (!this.enabled) {
					return;
				}
				//Que l'indice soit valable
				if (isNaN(parseInt(tab))) {
					return;
				}

				//On annul toute les requetes
				this.abortAllRequest();

				if (this.checkSession()) {
					if (layoutManager.modalWaiting != null) {
						layoutManager.modalWaiting.setTitle('Chargement de l\'onglet "' + this.tab[tab].libelle + '"');
						layoutManager.modalWaiting.show();
					}
					/*this.modalWaiting = new IsiModal({
						id : 'Waiting',
						title : 'Chargement de l\'onglet \"' + this.tab[tab].libelle + '\"',
						content : '&lt;div class="progress">&lt;div class="progress-bar progress-bar-info progress-bar-striped active" role="progressbar" style="width: 100%;">&lt;/div>&lt;/div>',
						footer : false,
						notClose : true
					});*/

					//IsiGéo indisponible
					this.enabled = false;

					//On clear l'onglet
					this.tab[this.currentTab].className.clear();

					//On prevoi un callback
					var callback = null;

					//On boucle sur tous les onglet dispo
					for (var i = 0; i &lt; this.tab.length; i++) {
						//Si on est sur le bon
						if (i == tab) {
							this.currentTab = i;
							this.currentTabName = this.tab[i].name;

							if (this.tab[i].name == 'DATA' &amp;&amp; typeof this.onComplete == 'function') {
								callback = this.onComplete;
							}

							//On a pas de menu en mode MIGP donc cette parti est utile dans le cas normale
							if (this.nature != 'WEB') {
								var partIsi = this.initMenu(this.tab[i].name);

								if (this.currentTabName == 'viewer') {
									var tabsplit = partIsi[2].split('|');

									Viewer.opacity = tabsplit[0].split(',');
									Viewer.layersRecup = tabsplit[1];

									if (Imajing &amp;&amp; Imajing.actif) {
										Imajing.actif = false;
									}
								}
							}

							//On passera option a la méthode init
							var option = {};

							// le lancement de la fonction isigeoGUI.oncomplete n'a de sens que si onglet DATA
							if (this.tab[i].name == 'DATA') {
								//Si on a des arguments, on les ajoutes a nos otpions
								if (typeof arg == 'object') {
									$jq.extend(option, arg);
								}

								//Et si on a une fonction a la fin du chargement de DATA
								if (typeof this.onComplete == 'function') {
									callback = this.onComplete;
								}
							}

							$jq.extend(option, {
								options: this.tab[i],
								onComplete: callback,
							});

							this.tab[i].className.init('panel', option);

							$jq('#' + this.tab[i].name + '_tab').addClass('active');
							$jq('#' + this.tab[i].name + '_tab')
								.children(':first')
								.prop('href', '#');
						} else {
							$jq('#' + this.tab[i].name + '_tab').removeClass();
							$jq('#' + this.tab[i].name + '_tab')
								.children(':first')
								.prop('href', 'javascript:isigeoGUI.setTab(' + i + ');');
						}
					}

					if (!callback) {
						isigeoGUI.enabled = true;
					}

					//On peut maintenant enlever le message d'attente
					waiting.hide();
				}
				//Pas de session, mais normalement on aura une demande de re-authentification avant d'arrivé ici
				else {
					return;
				}
			} catch (e) {
				alertifyCatchError("Erreur au changement d'onglet.", 'error', 0, e);
			}
		},

		/**
		 * Ajoute un onglet
		 * @param {Integer} id     Index de l'onglet dans le tableau
		 * @param {Object} tab     Onglet
		 * @param {Boolean} active  Indique si l'onglet est sélectionné
		 *
		 * @ignore
		 */
		addTab: function (id, tab, active) {
			try {
				//Si l'onglet n'existe pas
				if ($jq('#' + tab.name + '_tab').length === 0) {
					var html =
						'&lt;li id="' +
						tab.name +
						'_tab">&lt;a href="javascript:isigeoGUI.setTab(' +
						id +
						')">' +
						tab.libelle +
						'&lt;span class="sr-only">(current)&lt;/span>&lt;/a>&lt;/li>';

					$jq('#nav').append(html);

					//Si c'est l'onglet courant
					if (active) {
						//On ajoute la class "active"
						$jq('#' + tab.name + '_tab').addClass('active');
						$jq('#' + tab.name + '_tab')
							.children(':first')
							.prop('href', '#');
					}
				}
			} catch (e) {
				alertifyCatchError("Impossible d'ajouter l'onglet : " + tab.name, 'error', 0, e);
			}
		},

		/**
		 * Supprime un onglet ciblé par son nom
		 * @param  {String} name Nom de l'onglet
		 * @ignore
		 */
		removeTab: function (name) {
			var o = $jq('#' + name + '_tab');

			if (o.length > 0) {
				o.remove();
			}
		},

		/**
		 * Retourne le nom de l'onglet courant
		 *
		 * @return {string} Nom de l'onglet
		 *
		 * @ignore
		 *
		 */
		getCurrentTab: function () {
			return this.currentTabName;
		},

		setInfo: function () {
			if ($jq('#info').length > 0 &amp;&amp; $jq('#viewer').length > 0) {
				$jq('#info').css('top', $jq('#viewer').offset().top + 10 + 'px');
				$jq('#info').css('left', $jq('#viewer').offset().left + 10 + 'px');
			}
		},

		/**
		 * Fonction pour check si la session est encore active
		 *
		 * @param {Function} callback Fonction à appeler après la requête
		 *
		 * @ignore
		 */
		checkSession: function (callback) {
			var parametre = 'cmd=checkSession';

			if (this.domainUrl !== '') {
				parametre += '&amp;domainUrl=' + this.domainUrl;
			}

			var ajaxRequest = $jq.ajax({
				type: 'POST',
				url: _isigeoGUI.file,
				data: parametre,
				async: true,
				success: function (res) {
					var part = checkAjaxStatus('~', res, this);

					if (!part) {
						return false;
					}

					// session perdue
					if (typeof res != 'undefined' &amp;&amp; res !== '') {
						alertify.log('Session expirée, veuillez vous reconnecter.');
						isigeoGUI.exit();
						return false;
					} else {
						if (typeof callback == 'function') {
							callback();
						}
					}
				},
			});
		},

		/**
		 * Stopper toutes les requêtes Ajax contenus dans isigeoGUI.activeRequest
		 * @ignore
		 */
		abortAllRequest: function () {
			//On boucle sur chaque requete
			for (var i = 0; i &lt; this.activeRequest.length; i++) {
				try {
					if (typeof this.activeRequest[i] == 'object') {
						this.activeRequest[i].abort();
					}
				} catch (e) {
					alertifyCatchError("Erreur lors de l'arrêt des requêtes", 'error', 0, e);
				}
			}
		},

		/**
		 * Déconnecte l'utlisateur de IsiGéo, puis le redirige vers son URL
		 * @param  {String} val Type de chemin de sorti a prendre (ex : bureau ou session)
		 *
		 * @ignore
		 */
		exit: function (val) {
			this.abortAllRequest();

			if (!val) {
				val = '';
			}
			var paramsUrl = document.location.search.split('&amp;');
			var stringUrl = '';
			for (var i = 0; i &lt; paramsUrl.length; i++) {
				var splitParam = paramsUrl[i].split('=');
				if (typeof splitParam[0] != 'undefined') {
					splitParam[0] = splitParam[0].replace('?', '');
					if (typeof splitParam[1] != 'undefined' &amp;&amp; (splitParam[0] == 'domain' || splitParam[0] == 'theme_login' || splitParam[0] == 'logo_login')) {
						stringUrl += '&amp;' + splitParam[0] + '=' + splitParam[1];
					}
				}
			}
			document.location.href = 'exit.php?val=' + val + stringUrl;
		},

		/**
		 * Ouvre le sidebar d'impression et ajout le cardre d'impression sur la carte
		 *
		 * @param {PrintMapOpts=} options objet d'options
		 *
		 * @example
		 *
		 * isigeoGUI.printMap({
		 *   launch: "downloadFile",
		 *   optionImp: {
		 *     scale: "1000",
		 *     angle: 60,
		 *     format: "A4",
		 *     orientation: "paysage",
		 *     title: "Titre pré conf",
		 *     comment: "Observation pré conf",
		 *     legendeimp: true,
		 *     legendeimppage: true
		 *   },
		 *   form: {
		 *     tableId: "ec_poste",
		 *     id: "65",
		 *     pdfName: "monPDF",
		 *     fieldFile: "pdf_plan"
		 *   }
		 * })
		 *
		 */
		printMap: function (options) {
			var launch;
			if (typeof options.launch !== 'undefined') launch = options.launch;

			var optionImp;
			if (typeof options.optionImp !== 'undefined') optionImp = options.optionImp;

			var form;
			if (typeof options.form !== 'undefined') form = options.form;

			var accordion_fiche = '';
			if (layoutManager.activeSidebar != null) {
				accordion_fiche = layoutManager.activeSidebar.target.replace(new RegExp('_div$'), '');
			}

			var param = '';

			// traitement des options d'impression de la propriété optionImp
			if (typeof optionImp !== 'undefined') {
				// options de l'impression
				if (typeof optionImp.scale !== 'undefined') param += '&amp;scale=' + optionImp.scale;
				if (typeof optionImp.angle !== 'undefined') param += '&amp;angle=' + optionImp.angle;
				if (typeof optionImp.title !== 'undefined') param += '&amp;title=' + optionImp.title;
				if (typeof optionImp.comment !== 'undefined') param += '&amp;comment=' + optionImp.comment;
				if (typeof optionImp.orientation !== 'undefined') param += '&amp;orientation=' + optionImp.orientation;
				if (typeof optionImp.format !== 'undefined') param += '&amp;format=' + optionImp.format;
				if (typeof optionImp.legendeimp !== 'undefined' &amp;&amp; optionImp.legendeimp == true) param += '&amp;legendeimp=ok';
				if (typeof optionImp.legendeimppage !== 'undefined' &amp;&amp; optionImp.legendeimppage == true) param += '&amp;legendeimppage=ok';
			}

			// pour déclenchement de l'impression si launch = downloadFile
			if (typeof launch !== 'undefined' &amp;&amp; launch == 'downloadFile') param += '&amp;accordion_fiche=' + accordion_fiche + '&amp;launch=downloadFile';

			// ouverture de l'accordion d'impression "impconf"
			if (layoutManager.activeSidebar == null || layoutManager.activeSidebar.target != 'impconf_div') {
				$jq('[data-panel="impconf_div"]')[0].click();
			}

			// pour impression dans fiche
			if (
				typeof form !== 'undefined' &amp;&amp;
				typeof form.tableId !== 'undefined' &amp;&amp;
				form.tableId != '' &amp;&amp;
				typeof form.id !== 'undefined' &amp;&amp;
				form.id != '' &amp;&amp;
				typeof form.fieldFile !== 'undefined' &amp;&amp;
				form.fieldFile != ''
			) {
				if (typeof form.pdfName === 'undefined') form.pdfName = '';
				alertify.log('Plans pdf enregistrés dans une fiche.', 'standard', 5000);
				var fiche_a_reouvrir = 0;
				if (typeof layoutManager.dialog !== 'undefined') {
					if (layoutManager.dialog.id == form.tableId + '_' + form.id) {
						layoutManager.dialog.minimize();
						fiche_a_reouvrir = 1;
					}
				}
				param =
					'cmd=printInFile&amp;accordion_fiche=' +
					accordion_fiche +
					'&amp;fiche_a_reouvrir=' +
					fiche_a_reouvrir +
					'&amp;nom_table=' +
					form.tableId +
					'&amp;id_unique=' +
					form.id +
					'&amp;nom_champ=' +
					form.fieldFile +
					'&amp;nom_fic=' +
					form.pdfName +
					param;
				var ajaxRequest = $jq.ajax({
					url: 'lib/xhr_impconf.php',
					type: 'POST',
					data: param,
					async: false,
					dataType: 'html',
				});
				if (layoutManager.activeSidebar != null &amp;&amp; layoutManager.activeSidebar.target == 'impconf_div') {
					// rafraichissement de l'impression
					ajaxRequest = $jq.ajax({
						url: 'impconf.php',
						type: 'GET',
						success: function (r) {
							var part = checkAjaxStatus('~', r, this);

							if (!part) {
								return false;
							}
							$jq('#content-panel-sidebar').html(r);
						},
						dataType: 'html',
					});
					return;
				}
			} else if (param != '') {
				param = 'cmd=printOptions' + param;
				$jq.ajax({
					url: 'lib/xhr_impconf.php',
					type: 'POST',
					data: param,
					async: false,
					dataType: 'html',
				});
				if (layoutManager.activeSidebar != null &amp;&amp; layoutManager.activeSidebar.target == 'impconf_div') {
					// rafraichissement de l'impression
					$jq.ajax({
						url: 'impconf.php',
						type: 'GET',
						success: function (r) {
							var part = checkAjaxStatus('~', r, this);

							if (!part) {
								return false;
							}
							$jq('#content-panel-sidebar').html(r);
						},
						dataType: 'html',
					});
					return;
				}
			}
		},

		/**
		 * Permet d'ouvrir un sidebar
		 *
		 * @param {String!} divName Identifiant du sidebar
		 *
		 * @example
		 * // Liste des sidebar disponible
		 * const sidebars =  ['shortcut1', 'layercontrol', 'localise', 'agenda', 'inforap', 'selection', 'impconf', 'cartes']
		 * // ouvre le sidebar 'shortcut1'
		 * isigeoGUI.openPanel('shortcut1');
		 * // ouvre le sidebar 'layercontrol'
		 * isigeoGUI.openPanel('layercontrol');
		 * // etc...
		 */
		openPanel(divName) {
			//GERER LE CHANGEMENT D'ONGLET ICI DES QUE L'ON AURA PLUSIEURS ONGLETS

			if (!$jq('html').hasClass('sb-active-left')) {
				isigeoGUI.accordionSlidebar.slidebars.toggle('left');
			}
			$jq('.sb-toggle-left').prop('disabled', true);

			//Si on n'a pas de nom
			if (typeof divName == 'undefined' || divName == '') {
				alertify.log('Veuillez choisir un panel', 'standard', 10000);
				$jq('.sb-toggle-left').prop('disabled', false);
				return;
			}

			if (divName.endsWith('_div')) {
				divName = divName.substr(0, 4);
			}
			if ($jq('#' + divName).length > 0) {
				layoutManager.showSidebarElement(divName + '_div', function () {
					$jq('.sb-toggle-left').prop('disabled', false);
				});
			} else {
				$jq('.sb-toggle-left').prop('disabled', false);
				alertify.log("L'accordéon n'existe pas sur cet onglet", 'error', 10000);
			}
		},

		/**
		 * Fonction pour ouvrir un tableau de bord spécifique ou l'accueil si aucun tableau de bord n'est spécifié
		 *
		 * @param {(string|number)=} id id du tableau de bord (ouvre l'acceuil du TB si non renseigné)
		 * @param {OpenTBOpts} options options
		 *
		 * @example isigeoGUI.openTB(1, { type: 'graphSeul', defaultValsFilter: {'id_type_tb': 1, 'id_type_tb_sous_type': 1 }});
		 */
		openTB(id, options = {}) {
			// Si on a pas d'id on ouvre le TB sur l'accueil
			if (typeof id == 'undefined') {
				// layoutManager.modalAlert('&lt;p class="mb-0 text-danger font-weight-bold">Veuillez renseigner l\'identifiant du tableau de bord.&lt;/p>');
				layoutManager.openPanel('tableau_bord');
				return;
			}

			const afterPanelOpen = function () {
				if (typeof layoutManager.isJSGroupLoaded.tableau_bord != 'undefined' &amp;&amp; layoutManager.isJSGroupLoaded.tableau_bord) {
					const type = options.type ? options.type : 'tabGraph';
					
					tableau_bordGUI.change(id, type, 'TABLEAU_BORD', options);
				}
			};

			if (!layoutManager.isModuleVisible('tableau_bord')) {
				layoutManager.openPanel('tableau_bord', function () {
					afterPanelOpen();
				});
			} else {
				afterPanelOpen();
			}
		},
		/**
		 * Fonction générique pour rechercher un/des résultat(s) sur une table
		 * @externe Appelable depuis Isigeo_API
		 *
		 * @param {string!} table Nom de la table
		 * @param {SearchOpts=} [options={}] Objet d'options
		 *
		 * @example
		 *
		 * isigeoGUI.search('diag_bati_risque', {
		 *    where: 'nom_dem ilike \'%isiValue%\'',
		 *    orderBy: 'nom_dem',
		 *    limit: 5,
		 *    locate: true,
		 *    centerOnLocate: true,
		 *    exportCSV: false,
		 *    target: "window",
		 *    showModal: true,
		 *    notif: "Hello",
		 *    titleModal: 'Nom du demandeur ?'
		 * });
		 */
		search(table, options) {
			isigeoGUI.pageWasRefreshed = false;

			const _this = this;

			const callbackData = function (r, target) {
				var afterRefreshList = function () {
					if (
						$jq('#data-table table').length > 0 &amp;&amp;
						typeof $jq('#data-table table').data('idselection') != 'undefined' &amp;&amp;
						$jq('#data-table table').data('idselection') != ''
					) {
						$jq('#data-table table').data('idselection', '');
					}
					//Si on a bien l'id de la table
					var layer = '';
					if (typeof res.id != 'undefined' &amp;&amp; res.id != null &amp;&amp; res.id != '') {
						layer = res.id + '_sel';
					} else {
						return alertify.log('Résultat dans la table "Sélection"', 'success', 10000);
					}

					//On affiche la selection
					DataGUI.layerChange(layer, '', target, function () {
						// Dans le cas ou data n'etait pas ouvert et qu'on passe direct sur les resultats sans passer par l'accueil
						layoutManager.isPanelReady.data = true;
					});
				};
				var res = $jq.parseJSON(r);
				try {
					if (typeof res.dataList != 'undefined') {
						DataGUI.list = res.dataList;
					}
				} catch (e) {
					console.error(e);
					afterRefreshList();
				}
				afterRefreshList();
			};

			let whereSQL = '';
			let orderBy = null;
			let limit = null;
			let target = null;
			let locate = false;
			let exportCSV = null;
			let exportPublipostage = null;
			let centerOnLocate = null;
			let layoutConfiguration = null;

			if (!options || typeof options !== 'object') {
				options = {};
			}
			if (options.where) {
				whereSQL = options.where;
			}
			if (options.orderBy) {
				orderBy = options.orderBy;
			}
			if (options.limit &amp;&amp; !isNaN(Number(options.limit))) {
				limit = options.limit;
				isigeoGUI.nbpp = limit;
				document.forms.main.nbpp.value = limit;
			} else {
				isigeoGUI.nbpp = isigeoGUI.defaultNbpp;
				document.forms.main.nbpp.value = isigeoGUI.defaultNbpp;
			}
			if (options.layoutConfiguration) {
				layoutConfiguration = options.layoutConfiguration;
			}
			if (typeof options.locate != 'undefined') {
				locate = options.locate;
			}
			if (typeof options.centerOnLocate != 'undefined') {
				centerOnLocate = options.centerOnLocate;
			}
			if (options.exportCSV) {
				exportCSV = options.exportCSV;
			}
			if (options.exportPublipostage) {
				exportPublipostage = options.exportPublipostage;
			}
			if (options.target) {
				target = options.target.toLowerCase();
			} else if (locate === false) {
				target = 'data';
			} else {
				target = 'map';
			}
			//Si une notif est passé en param
			if (typeof options.notif != 'undefined' &amp;&amp; options.notif != '') {
				alertify.log(options.notif, 'success', 8000);
			}

			if (exportCSV) {
				layoutManager.log('Génération du CSV en cours...', {
					type: 'info',
					id: '_exportCSV_' + table,
				});
			}

			function sendAjax() {
				$jq(document).off('agendasInit');
				if (target === 'agenda_div' &amp;&amp; typeof Agenda != 'undefined') {
					Agenda.isInit = true;
				}
				var param = 'cmd=search&amp;table=' + table + '&amp;options=' + encodeURIComponent(JSON.stringify(options));
				_this.ar_search = $jq.ajax({
					type: 'POST',
					url: _isigeoGUI.file,
					data: param,
					success: function (r) {
						var part = checkAjaxStatus('~', r, this, true);
						if (!part) {
							return false;
						}

						try {
							var obj = JSON.parse(r);
							if (typeof obj.status !== "undefined" &amp;&amp; obj.status == false) {
								layoutManager.modalAlert(obj.message);
								return;
							}
							if (exportCSV &amp;&amp; exportCSV != null) {
								return isigeoGUI.exportCSVSelection(table, whereSQL, limit, exportPublipostage);
							}
							if (obj.nature == 'GEO' &amp;&amp; (locate || target.toLowerCase() === 'map')) {
								if ($jq('#viewer').is(':visible') /*&amp;&amp; table geo*/) {
									return Viewer.SQLlocate(table, whereSQL, limit, centerOnLocate);
								}
							}
							callbackData(r, target);
						} catch (e) {
							console.error(e);
						}
					},
				});
			}

			function trigger() {
				if (typeof target != 'undefined' &amp;&amp; target != null) {
					if (target === 'window') {
						layoutManager.initWindow({
							dialogPosition: 'right-bottom',
							affichage: 'small',
							id: table,
						});
						sendAjax();
					} else if (target.toLowerCase() === 'data') {
						if (!exportCSV) {
							if (!$jq('#container-data').is(':visible')) {
								// On force le callback pour bypass le passage par l'accueil de data
								layoutManager.openPanel('data', sendAjax, true);
							} else {
								sendAjax();
							}
						} else {
							sendAjax();
						}
						return;
					} else if (target.toLowerCase() === 'map') {
						if (!$jq('#viewer').is(':visible')) {
							layoutManager.openPanel('viewer', sendAjax);
						} else {
							sendAjax();
						}
						return;
					} else if (target.toLowerCase() !== 'data') {
						if (target.match('_div') === null) {
							target += '_div';
						}
						const accordion = Object.keys(ToolsGUI.myAccordion);
						if (accordion.includes(target)) {
							if (target === 'agenda_div') {
								if (layoutManager.getPanel('agenda') == null || $jq('#planning').length &lt;= 0 || !$jq('#planning').is(':visible')) {
									const fullscreenAgenda = () => layoutManager.toggleFullScreenPanel('agenda', true);
									layoutManager.openPanel('agenda', fullscreenAgenda);
									if (typeof Agenda == 'undefined' || (typeof Agenda != 'undefined' &amp;&amp; !Agenda.isInit)) {
										$jq(document).on('agendasInit', sendAjax);
									} else {
										layoutManager.showSidebarElement(target, sendAjax);
									}
								} else {
									layoutManager.showSidebarElement(target, sendAjax);
								}
							} else {
								layoutManager.showSidebarElement(target, sendAjax);
							}
							return;
						} else {
							layoutManager.modalAlert(`La cible ${target} ne peux pas être traitée.`);
						}
					}
				}
			}

			if (options.showModal) {
				if (!options.titleModal) {
					layoutManager.modalAlert("Un titre est recommandé pour l'utilisation de la modal...");
				}

				layoutManager.dialogConfirm('&lt;input type="text" class="form-control" id="search-text">', {
					libelleForm: options.titleModal,
					labelAccept: 'Valider',
					onShow: () => $jq('#search-text').focus(),
					onAccept: () => {
						const value = $jq('#search-text').val();

						if (value === '') return;

						whereSQL = whereSQL.replace(/isiValue/g, value);
						options.where = options.where.replace(/isiValue/g, value);
						trigger();
					},
				});

				$jq('#IsiModal-confirm-dialog').on('keypress', event => {
					if (event.key === 'Enter') {
						layoutManager.confirmDialog.destroy();

						const value = $jq('#search-text').val();

						if (value === '') return;

						whereSQL = whereSQL.replace(/isiValue/g, value);
						options.where = options.where.replace(/isiValue/g, value);
						trigger();
					}
				});
			} else {
				trigger();
			}
		},

		/**
		 * Permet de changer de carte
		 *
		 * @param {Number!} id Identifiant de la carte
		 * @param {String=} mcd Mcd de la carte
		 * @param {String=} domain Domaine de la carte
		 *
		 * @example
		 * isigeoGUI.changeMap(42, 'demo_ep_64102', 'demo');
		 */
		changeMap: function (id, mcd, domain) {
			try {
				if (!mcd &amp;&amp; location.search.match('mcd')) {
					const alteredURL = removeParamURL('mcd', location.href);
					window.history.pushState('', document.title, alteredURL);
				}

				if (typeof clearTestedFiles === 'function') clearTestedFiles();

				if (!domain &amp;&amp; location.search.match('domain')) {
					const alteredURL = removeParamURL('domain', location.href);
					window.history.pushState('', document.title, alteredURL);
				}
				// Todo : ajouter un check si la carte existe avant de faire tout le traitement.
				if (layoutManager.advancedFooterMoved) {
					layoutManager.HTMLAdvancedFooter = layoutManager.selectors.advancedFooter.prop('outerHTML');
				}
				if (typeof Dessin !== 'undefined') {
					// remise à 0 du tableau Dessin.lastSelectedLayer pour éviter de chercher un layer inexistant
					Dessin.lastSelectedLayer = [];
				}

				if (['xs', 'sm', 'md'].includes(layoutManager.format) &amp;&amp; typeof layoutManager.accordionSlidebar != 'undefined') {
					layoutManager.accordionSlidebar.slidebars.close();
				}

				if (layoutManager.modalWaiting != null) {
					layoutManager.modalWaiting.setTitle('Chargement de la carte en cours...');
					layoutManager.modalWaiting.show();
				} else {
					layoutManager.modalWaiting = new IsiModal({
						id: 'Waiting',
						title: 'Chargement de la carte en cours...',
						content:
							'&lt;div class="progress">&lt;div class="progress-bar progress-bar-info progress-bar-striped progress-bar-animated active" role="progressbar" style="width: 100%;">&lt;/div>&lt;/div>',
						footer: false,
						notClose: true,
						verticalCenter: true,
						showOnInit: true,
						blur: true,
						callback: () => delete isigeoGUI.modalWaiting,
					});
				}

				isigeoGUI.checkSession(function () {
					// On reset le(s) filtre(s) strate + on la close
					if (Strate.aFiltres.length > 0) {
						Strate.annuler(true);
					}
					if (typeof Strate != 'undefined') {
						Strate.dialog = null;
						Strate.bodyContent = null;
						Strate.footerContent = null;
					}
					if (typeof MouseQuery != 'undefined') {
						MouseQuery.layerSelectionMarker = null;
						MouseQuery.lastMarkerAdded = null;
						MouseQuery.markersMap = [];
					}

					if (typeof DataGUI != 'undefined') {
						DataGUI.list = null;
						DataGUI.currentLayer = null;
						DataGUI.lastLayerChanged = null;
					}

					if (typeof filterGUI != 'undefined') {
						filterGUI.nbFilters = 1;
						filterGUI.requeteurMem = {};
						filterGUI.target = null;
						filterGUI.dialog = null;
					}
					if (typeof Thematic != 'undefined') {
						Thematic.FieldObs = []; 
						Thematic.nbClassesMax = null;
						Thematic.cpt = 0;
						Thematic.cpton = 0;
						Thematic.idActif = null;
						Thematic.lastStatus = {};
						Thematic.activeLayer = [];
						Thematic.bsTableRef = {};
					}

					if (typeof LayerTree != 'undefined') {
						LayerTree.imageBase = '.';
						LayerTree.state = null;
						LayerTree.cpt = 0;
						LayerTree.LIMIT = 5;
						LayerTree.group = {};
						LayerTree.colorPicker = [];
						LayerTree.options = {};
						LayerTree.layer = {};
						LayerTree.classLayer = {};
						LayerTree.classVisibility = {};
						LayerTree.classesDefaultStateAdded = {};
						LayerTree.updateLayer_view = '';
						LayerTree.footer = '';
						LayerTree.updateLayerDialogs = {};
						LayerTree.fullyLoaded = false;
						LayerTree.getRequest = null;
						LayerTree.layerState = {};
					}

					if (typeof Query != 'undefined') {
						Query.enterEvent = false;
					}

					if (typeof isigeoGUI.refreshInterval != 'undefined' &amp;&amp; isigeoGUI.refreshInterval != null) {
						clearInterval(isigeoGUI.refreshInterval);
						isigeoGUI.refreshInterval = null;
					}
					// On ferme toutes les dialogs ouvertes
					layoutManager.closeAllWindows();

					if (typeof Shortcut != 'undefined') {
						Shortcut.buffer = [];
					}
					layoutManager.activeSidebar = null;
					layoutManager.lastActiveSidebar = null;
					isigeoGUI.inlineLocate = null;

					//On vide la sélection
					//Viewer.clearSelection();

					//On reinitialise toutes les variables clés de l'interface d'isigeoGUI
					//isigeoGUI.resetFootPrints();

					//Si l'onglet courant est pas la carte
					//on se remet dessus
					//MapTab.load = false;
					//
					if ($jq('#form').length > 0) {
						layoutManager.closePanel('form');
					}

					for (let panel in layoutManager.panels) {
						layoutManager.manageButtonState(layoutManager.panels[panel], 1);
					}
					layoutManager.setConfigSession(true, function () {
						$jq('#spinner').show();
						layoutManager.manageSpinnerPosition();
						layoutManager.selectors.panelA.data('isVisibleOnStart', false);
						layoutManager.selectors.panelB.data('isVisibleOnStart', false);
						layoutManager.selectors.panelA.html('').hide();
						layoutManager.selectors.panelB.html('').hide();
						layoutManager.resetAllVariables();
						layoutManager.panelsVisibles();
						//layoutManager.panels = JSON.parse(layoutManager.layoutOptions.config_panel);

						// layoutManager.accordionSlidebar.slidebars.close();
						// $jq('.sb-toggle-left').removeClass('active text-primary');

						var afterCheckJSLoaded = function (id) {
							if (typeof Viewer != 'undefined') {
								Viewer.layersRecup = null;
								Viewer.affProj = null;
								Viewer.opacity = Viewer.baseLayer = [];
							}

							var paramsUrl = location.search.split('?');

							for (var i = 0; i &lt; paramsUrl.length; i++) {
								if (paramsUrl[i].indexOf('envc=') > -1 || paramsUrl[i] == '') {
									delete paramsUrl[i];
									continue;
								}
								if (typeof mcd != 'undefined' &amp;&amp; typeof domain != 'undefined') {
									if (paramsUrl[i].indexOf('domain=') > -1 || paramsUrl[i].indexOf('mcd=') > -1 || paramsUrl[i] == '') {
										delete paramsUrl[i];
									}
								}
							}
							var charParams = paramsUrl.join('&amp;');
							if (charParams.charAt(0) != '&amp;') {
								charParams = '&amp;' + charParams;
							}
							if (id != null) {
								history.pushState(
									{
										map: id,
									},
									'envc' + id,
									'?envc=' + id + charParams
								);
							}
							if (typeof mcd != 'undefined' &amp;&amp; typeof domain != 'undefined') {
								history.pushState(
									{
										mcd: mcd,
										domain: domain,
									},
									'mcd' + mcd,
									'?mcd=' + mcd + '&amp;domain=' + domain + charParams
								);
							}
							// 1er dimensionnement pour le background
							layoutManager.initSelectors();
							//layoutManager.initEvents();
							layoutManager.dimWindow();
							//Initialisation du layout
							layoutManager.initialize({
								mode: layoutManager.mode,
								isMapChanging: true,
							});
						};

						if (typeof layoutManager.isJSGroupLoaded.viewer == 'undefined' || !layoutManager.isJSGroupLoaded.viewer) {
							layoutManager.loadJSFile('viewer',function () {
								afterCheckJSLoaded(id);
							});
						} else {
							afterCheckJSLoaded(id);
						}
					});
				});
			} catch (e) {
				alertifyCatchError('isigeoGUI - changeMap() - ' + e.message, 'error', 0, e);
			}
		},

		/**
		 * Permet d'ouvrir un IFrame dans une dialogue
		 *
		 * @param {String!} url Url à ouvrir
		 * @param {String=} id id de la dialog
		 * @param {String=} [title="iFrame"] Titre de la dialog
		 * @param {Object=} [options={}] Objet d'options
		 * @param {string=} options.position position de la dialogue
		 * @param {string=} options.affichage affichage de la dialogue (small, medium, large, fullscreen)
		 *
		 * @example
		 * isigeoGUI.openIframeDialog('http://www.google.fr', 'dialogId', 'Mon titre', {
		 *   position: 'left-bottom',
		 * 	 affichage: 'small'
		 * });
		 */
		openIframeDialog: function (url, id, title, options = {}) {
			this.openIframe(id, url, title, options);
		},

		/**
		 * Permet d'ouvrir un IFrame dans une dialogue
		 *
		 * @param {string=} id id de la dialogue
		 * @param {string!} url url de l'iframe
		 * @param {string=} title titre de la dialog
		 * @param {Object=} options Objet d'options
		 * @param {string=} options.position position de la dialogue
		 * @param {string=} options.affichage affichage de la dialogue (small, medium, large, fullscreen)
		 *
		 * @ignore
		 */
		openIframe: function (id, url, title = 'iFrame', options = {}) {
			// Gestion particulière car impossible d'ouvrir un iframe depuis un iframe
			if (isigeoGUI.isApps) {
				if (url.endsWith('pdf')) {
					window.top.postMessage('openPDF~' + url, '*');
				} else {
					window.top.postMessage('openWindow~' + url, '*');
				}
				return;
			}

			const objOpt = {
				titleDialog: title,
				content: '&lt;iframe id="iframe" src="' + url + '" frameborder="0" border="0" cellspacing="0" style="width:100%;min-height:440px;height:100%;">&lt;/iframe>',
			};

			if (typeof options.position != 'undefined') {
				objOpt.dialogPosition = options.position;
			}

			if (typeof options.affichage != 'undefined') {
				objOpt.affichage = options.affichage;
			}

			if (typeof id != 'undefined') {
				objOpt.id = id;
			}
			if (typeof objOpt.affichage != 'undefined' &amp;&amp; objOpt.affichage == 'panel') {
				isigeoGUI.iframeURLPanel = url;
				layoutManager.openPanel('iframe');
			} else {
				layoutManager.initWindow(objOpt);
				Query.onResizeWindow(layoutManager.dialog);
			}
		},

		/**
		 * Fonction qui va permettre de fermer une dialog iframe
		 * @param {String!} id id de la dialog
		 * @ignore
		 */
		destroyIframeDialog: function (id) {
			var win = layoutManager.windowManager.checkIDExist(id);
			if (typeof win != 'undefined' &amp;&amp; win) {
				win.close();
			}
		},

		/**
		 * Fonction qui permet d'ouvrir les log dans une dialog
		 * @ignore
		 */
		openLogsDialog: function () {
			isigeoGUI.openIframe('logsDialog', this.adminURL + '?page=check', 'Fenêtre des logs', { position: 'bottom-left' });
			var inter = setInterval(function () {
				if (typeof window.frames[0].frameElement.contentWindow.checkGUI != 'undefined') {
					window.frames[0].frameElement.contentWindow.checkGUI.checkLogs();
					if (window.frames[0].frameElement.contentWindow.document.getElementById('resultContent') != null) {
						window.frames[0].frameElement.contentWindow.document.getElementById('resultContent').style =
							'position:absolute;width:100%;height:100%;top:0;left:0;overflow:auto;background:#FFF;';
						clearInterval(inter);
					}
				}
			}, 100);
		},

		onKeyPressSearchInput: function (e) {
			/* Act on the event */
			var code;
			if (!e) {
				e = window.event;
			}
			if (e.keyCode) {
				code = e.keyCode;
			} else if (e.which) {
				code = e.which;
			}
			if (code == 13) {
				// Pour ne pas bloquer les retours a la ligne des textarea
				if (
					typeof e.target == 'undefined' ||
					typeof e.target.tagName == 'undefined' ||
					(typeof e.target != 'undefined' &amp;&amp; typeof e.target.tagName != 'undefined' &amp;&amp; e.target.tagName != 'TEXTAREA')
				) {
					e.preventDefault();
				}
				if (typeof Viewer != 'undefined' &amp;&amp; $jq('#coords-input').is(':focus')) {
					var srid = Viewer.map.getView().getProjection().getCode();
					if (Viewer.affProj) {
						srid = 'EPSG:' + Viewer.affProj.split('_')[0];
					}
					Viewer.locateCoords($jq('#coords-input').val(), srid);
				} else if ($jq('#localise-query').is(':focus') || $jq('#localise-query-mobile').is(':focus')) {
					$jq('#navbar-header').height('');
					Localise.getResultats(null, true, 'metier');
				} else if ($jq('.filter_field_values').is(':focus') || (typeof e.target != "undefined" &amp;&amp; typeof $jq(e.target).data('id') != "undefined" &amp;&amp; $jq(e.target).data('id').includes('filter_field'))) {
					Query.initValidForm();
					let formValid = $jq('#form-requeteur').validate();

					if (formValid.form()) {
						filterGUI.onChangeFieldValue();
					}
				}
			}
		},

		/**
		 * Fonction permettant d'afficher un message d'erreur + un details dans une dialogue
		 *
		 * @param {String!} msg message à afficher
		 * @param {Function=} callback callback à la fermeture de la dialog
		 * @param {string=} detailsMsg message de detail sur l'erreur (permet d'afficher le btn 'Afficher plus de détails')
		 *
		 * @return {IsiModal} Retourne l'objet de la dialog d'erreur
		 *
		 * @example
		 * isigeoGUI.modalAlert('Erreur', () => alert('modal fermé'), 'Erreur de connexion');
		 */
		modalAlert(msg, callback, detailsMsg) {
			const dialog = layoutManager.modalAlert(msg, callback, detailsMsg);

			return dialog;
		},


		initPictureGeoref(urlImage) {
			if (typeof urlImage == 'undefined') {
				var html =
					'&lt;div id="georef-loader" class="text-left p-2">&lt;h5 class="text-center mb-4">Veuillez sélectionner une image &lt;/h5>&lt;li class="mb-3">Depuis votre ordinateur: &lt;input type="file" class="form-control-file" name="files[]">&lt;li>Depuis une URL : &lt;div class="form-group form-inline">&lt;input type="text" class="form-control col-9" value="https://upload.wikimedia.org/wikipedia/commons/4/4f/Achin,_Plan_de_la_ville_de_Paris_repr%C3%A9sentant_les_nouvelles_voitures_publiques,_1828.jpg">&lt;button title="Valider" type="button" class="btn btn-light border-success text-success col-3">&lt;i class="icon ico-h3 icon-save mr-2">&lt;/i>Valider&lt;/button>&lt;/div>&lt;/div>';
				var htmlFooter =
					'&lt;button title="Annuler" type="button" class="btn btn-light text-dark mr-2 border-dark col-4">&lt;i class="icon ico-h3 icon-circle-slash mr-2">&lt;/i>Annuler&lt;/button>';
				layoutManager.initWindow({
					content: html,
					titleDialog: 'Géoréferencer une image',
					fullTitle: 'Géoréferencer une image',
					footerContent: htmlFooter,
					affichage: 'small',
				});
				ImageGeoref.initialize();
			} else {
				ImageGeoref.initialize(urlImage);
			}
		},

		isigeoFromCartads(listParcelle, tableDossier, idDossier) {
			var where;

			where = "nom in(select unnest(('{'||'";

			//Concat du where sur la liste des parcelles à renvoyer
			where += listParcelle;

			where += "'||'}')::varchar[]))";

			Viewer.SQLlocate('parcelles', where);

			if (layoutManager.dialog != null &amp;&amp; typeof layoutManager.dialog.minimize != 'undefined') {
				layoutManager.dialog.minimize();
			}
			alertify.log('Localisation des parcelles...', 'default', 8000);
		},

		/**
		 * Fonction pour appliqué un état sur la carte
		 *
		 * @param {String!} state Etat à appliqué ('QUERY', 'QUERYSHAPE', 'QUERYCIRCLE', 'QUERY_SEL', 'DRAW_POINT', 'DRAW_LINESTRING', 'DRAW_POLYGON', MODIFY', MEASURE_DISTANCE', 'MEASURE_SURFACE', 'MEASURE_OBJECT')
		 * @param {Function=} cb Callback une fois l'état appliqué
		 *
		 * @example isigeoGUI.setToolBar('MODIFY', () => layoutManager.log('Vous pouvez modifier un objet sur la carte'));
		 */
		setToolBar(state, cb) {
			MapCMD.setState(state, cb);
		},

		/**
		 * Fonction pour insérer les log en base
		 *
		 * @param {Error} err Erreur capturée
		 * @param {String} fnName Nom de la fonction dans laquelle l'erreur s'est produite
		 * @ignore
		 */
		insertLog(err, fnName) {
			if (err instanceof Error === false) {
				const msg = err.message ? err.message : err;
				err = new Error(msg);
			}

			const { filepath, line } = this.getInfosError(err);
			const src = `${filepath}:${line}:${fnName}`;
			const level = this.ERROR;

			/**
			 * Envoi de l'erreur en base
			 */
			const insertLog = $jq.ajax({
				type: 'POST',
				url: 'lib/xhr_isigeo.php',
				async: false,
				data: {
					cmd: 'insertLog',
					error: err.message,
					src,
					level,
				},
			});

			const { responseText } = insertLog;
			const res = JSON.parse(responseText);

			if (typeof res.success !== 'undefined' &amp;&amp; res.success === true) {
				console.log('Log enregistré');
			} else {
				console.error("Erreur lors de l'enregistrement du log : " + res.message);
			}
		},

		/**
		 * Fonction qui va récupérer les infos utiles dans une erreur
		 *
		 * @param {Error} error Erreur capturé
		 * @returns {InfoError}
		 *
		 * @ignore
		 */
		getInfosError(error) {
			const regex = /\((.*):(\d+):(\d+)\)$/;
			const match = regex.exec(error.stack.split('\n')[2]);

			return {
				filepath: match[1],
				line: match[2],
			};
		},

		/**
		 * Fonction qui va afficher une notification furtive
		 * @tutorial tutoIsigeoLog
		 *
		 * @param {String!} [message='Message'] Message d'erreur
		 * @param {LogOpts=} options Objet d'options
		 *
		 * @returns {Object} retourne l'objet jQuery de l'élément
		 */
		log(message, options) {
			const log = layoutManager.log(message, options);

			return log;
		},

		/**
		 * Permet d'ouvrir la dialogue contenant les filtre strate
		 */
		getStrate() {
			if (typeof Strate !== 'undefined') {
				Strate.getStrate();
			} else {
				layoutManager.modalAlert("Le module Strate n'est pas disponible, veuillez contacter votre administrateur.");
			}
		},

		/**
		 * Permet d'activer ou désactiver un layer sur la carte
		 *
		 * @param {Array&lt;Object>} options tableau d'objet
		 * @param {String} options.name Nom du layer
		 * @param {String} options.status Status du layer (ON/OFF)
		 * @param {Boolean} [refresh=false] Si true, recharge la carte
		 * 
		 * @example
		 * isigeoGUI.activeLayer([{
		 *     name: 'support',
		 *     status: 'ON',
		 * }]);
		 */
		activeLayer(options, refresh) {
			if (typeof Viewer !== 'undefined') {
				Viewer.activeLayer(options, refresh);
			} else {
				layoutManager.modalAlert("Le module Viewer n'est pas disponible, veuillez contacter votre administrateur.");
			}
		},

		/**
		 * Permet d'ouvrir la boite à outils pour l'import DXF avec les champs déjà renseigné
		 *
		 * @param {Object} options Objet d'option
		 * @param {String} [options.path=''] Chemin du fichier dxf (à partir de mapserver_data\demo\data)
		 * @param {Number=} [options.type=0] Type d'intégration (0: importer l'ensemble dans 3 tables, 1: importer chaque couche séparément)
		 * @param {String} [options.base=''] Base de données
		 * @param {String} [options.table_point=''] Table de destination pour les points
		 * @param {String} [options.table_line=''] Table de destination pour les lignes
		 * @param {String} [options.table_polygon=''] Table de destination pour les polygones
		 * @param {String} [options.projection=''] Projection du fichier dxf (valeur ou identifiant)
		 * @param {Boolean=} [options.clear_tables=false] Si true, supprime les tables de destination avant l'import
		 * @param {Array&lt;String>} [layers=[]] Liste des layers à importer
		 * @param {String=} [idunique=''] Identifiant unique à ajouter (ex: "idunique_dxf=8")
		 */
		integrateDXF(options = {}) {
			const defaultOptions = {
				path: '',
				type: 0,
				base: '',
				table_point: '',
				table_line: '',
				table_polygon: '',
				projection: '',
				clear_tables: false,
				layers: [],
				idunique: '',
			};

			options = Object.assign(defaultOptions, options);

			if (options.path === '') {
				layoutManager.modalAlert('Veuillez spécifier le chemin vers un fichier DXF');
				return;
			} else if (options.base === '') {
				layoutManager.modalAlert('Veuillez spécifier la base de données');
				return;
			} else if (options.table_point === '') {
				layoutManager.modalAlert('Veuillez spécifier la table de points');
				return;
			} else if (options.table_line === '') {
				layoutManager.modalAlert('Veuillez spécifier la table de lignes');
				return;
			} else if (options.table_polygon === '') {
				layoutManager.modalAlert('Veuillez spécifier la table de polygones');
				return;
			} else if (options.projection === '') {
				layoutManager.modalAlert('Veuillez spécifier la projection');
				return;
			} else if (options.layers.length === 0) {
				layoutManager.modalAlert('Veuillez spécifier les couches à importer');
				return;
			} else if (options.idunique !== '' &amp;&amp; options.idunique.match('=') === null) {
				layoutManager.modalAlert("Le format de l'idunique est incorrect, ex : 'idexport_dxf=8'");
				return;
			}

			for (let key in options) {
				options[key] = encodeURIComponent(options[key]);
			}

			const data = `path=${options.path}&amp;type=${options.type}&amp;base=${options.base}&amp;table_point=${options.table_point}&amp;table_line=${options.table_line}&amp;table_polygon=${options.table_polygon}&amp;projection=${options.projection}&amp;clear_tables=${options.clear_tables}&amp;layers=${options.layers}&amp;idunique=${options.idunique}`;

			const backOfficePath = document.querySelector('#btn-console-admin').onclick.toString().split("'")[1].split('admin')[0];
			const url = `${backOfficePath}plugins/translate/template.phtml?page=importdxf&amp;${data}`;

			window.open(url, '_blank');
		},

		/**
		 * Permet d'ouvrir la dialog de légende
		 * @externe Appelable depuis Isigeo_API
		 *
		 * @example isigeoGUI.openLegend();
		 */
		openLegend() {
			if (typeof Legend !== 'undefined') {
				if (typeof Legend.dialogLegend === 'undefined') {
					Legend.toggle();
				}
			} else {
				layoutManager.modalAlert("Le module Legend n'est pas disponible, veuillez contacter votre administrateur.");
			}
		},

		/**
		 * Fonction pour changer d'application
		 *
		 * @param {String} mcd Nom de l'application
		 * @param {String=} [domain=Récupère le domaine courant] Nom du domaine
		 *
		 * @example isigeoGUI.changeApp('planning', 'demo');
		 */
		changeApp(mcd, domain) {
			if (!mcd) {
				this.modalAlert('Un mcd est requis');
			}
			if (!domain) {
				if (this.domain &amp;&amp; this.domain !== '') {
					domain = this.domain;
				} else {
					this.modalAlert('Un domaine est requis');
				}
			}

			if (location.search.match('mcd')) {
				const alteredURL = removeParamURL('mcd', location.href);
				window.history.pushState('', document.title, alteredURL);
			}

			if (location.search.match('domain')) {
				const alteredURL = removeParamURL('domain', location.href);
				window.history.pushState('', document.title, alteredURL);
			}

			if (location.hash) {
				const alteredURL = location.href.replace(location.hash, '');
				window.history.pushState('', document.title, alteredURL);
			}
			if (location.search.match('envc')) {
				const alteredURL = removeParamURL('envc', location.href);
				window.history.pushState('', document.title, alteredURL);
			}

			// Todo : ajouter un check si la carte existe avant de faire tout le traitement.
			if (layoutManager.advancedFooterMoved) {
				layoutManager.HTMLAdvancedFooter = layoutManager.selectors.advancedFooter.prop('outerHTML');
			}
			if (typeof Dessin !== 'undefined') {
				// remise à 0 du tableau Dessin.lastSelectedLayer pour éviter de chercher un layer inexistant
				Dessin.lastSelectedLayer = [];
			}

			if (['xs', 'sm', 'md'].includes(layoutManager.format) &amp;&amp; typeof layoutManager.accordionSlidebar != 'undefined') {
				layoutManager.accordionSlidebar.slidebars.close();
			}

			if (layoutManager.modalWaiting != null) {
				layoutManager.modalWaiting.setTitle('Chargement de la carte en cours...');
				layoutManager.modalWaiting.show();
			} else {
				layoutManager.modalWaiting = new IsiModal({
					id: 'Waiting',
					title: "Chargement de l'application en cours...",
					content:
						'&lt;div class="progress">&lt;div class="progress-bar progress-bar-info progress-bar-striped progress-bar-animated active" role="progressbar" style="width: 100%;">&lt;/div>&lt;/div>',
					footer: false,
					notClose: true,
					verticalCenter: true,
					showOnInit: true,
					blur: true,
					callback: () => delete isigeoGUI.modalWaiting,
				});
			}

			isigeoGUI.checkSession(function () {
				// On reset le(s) filtre(s) strate + on la close
				if (Strate.aFiltres.length > 0) {
					Strate.annuler(true);
				}
				if (typeof Strate != 'undefined') {
					Strate.dialog = null;
					Strate.bodyContent = null;
					Strate.footerContent = null;
				}
				if (typeof MouseQuery != 'undefined') {
					MouseQuery.layerSelectionMarker = null;
					MouseQuery.lastMarkerAdded = null;
					MouseQuery.markersMap = [];
				}

				if (typeof DataGUI != 'undefined') {
					DataGUI.list = null;
					DataGUI.currentLayer = null;
					DataGUI.lastLayerChanged = null;
				}

				if (typeof filterGUI != 'undefined') {
					filterGUI.nbFilters = 1;
					filterGUI.requeteurMem = {};
					filterGUI.target = null;
					filterGUI.dialog = null;
				}

				if (typeof isigeoGUI.refreshInterval != 'undefined' &amp;&amp; isigeoGUI.refreshInterval != null) {
					clearInterval(isigeoGUI.refreshInterval);
					isigeoGUI.refreshInterval = null;
				}
				// Si une autre dialog on la close aussi
				if (layoutManager.dialog) {
					layoutManager.dialog.close();
				}

				if (typeof Shortcut != 'undefined') {
					Shortcut.buffer = [];
				}
				layoutManager.activeSidebar = null;
				layoutManager.lastActiveSidebar = null;

				//On vide la sélection
				//Viewer.clearSelection();

				//On reinitialise toutes les variables clés de l'interface d'isigeoGUI
				//isigeoGUI.resetFootPrints();

				//Si l'onglet courant est pas la carte
				//on se remet dessus
				//MapTab.load = false;
				//
				if ($jq('#form').length > 0) {
					layoutManager.closePanel('form');
				}

				for (let panel in layoutManager.panels) {
					layoutManager.manageButtonState(layoutManager.panels[panel], 1);
				}
				layoutManager.setConfigSession(true, function () {
					layoutManager.selectors.panelA.data('isVisibleOnStart', false);
					layoutManager.selectors.panelB.data('isVisibleOnStart', false);
					layoutManager.selectors.panelA.html('').hide();
					layoutManager.selectors.panelB.html('').hide();
					layoutManager.resetAllVariables();
					layoutManager.panelsVisibles();

					window.history.pushState('', document.title, `?mcd=${mcd}&amp;domain=${domain}`);
					// 1er dimensionnement pour le background
					layoutManager.initSelectors();
					//layoutManager.initEvents();
					layoutManager.dimWindow();
					//Initialisation du layout
					layoutManager.initialize({ params: `mcd=${mcd}&amp;domain=${domain}`, isAppChanging: true });
				});
			});
		},

		/**
		 * Permet d'ouvrir un panel avec un sidebar spécifique
		 * @param {String} divId Identifiant de la div de l'accordion à ouvrir ('shortcut1', 'layercontrol', 'localise', 'agenda', 'inforap', 'selection', 'impconf', 'cartes' )
		 * @param {String=} [onglet=Récupère l'onglet correspondant] Nom de l'onglet à ouvrir ('viewer','data', 'tableau_bord', 'alert', 'agenda')
		 * 
		 * @example isigeoGUI.openAccordion('layercontrol', 'viewer');
		 */
		openAccordion(divId, onglet) {
			const tabExist = isigeoGUI.tab.find(el => el.name === onglet);

			if (typeof divId === 'undefined' || divId === '') {
				layoutManager.log('Veuillez choisir une sidebar à ouvrir', { closeOnClick: true, delay: 10000, useColorScheme: true, type: 'danger', useTitle: false, useCloseButton: false });
				return;
			}

			if (!tabExist) {
				layoutManager.log(`L'onglet "${onglet}" n'existe pas ou n'est pas accessible`, { closeOnClick: true, delay: 10000, useColorScheme: true, type: 'warning', useTitle: false, useCloseButton: false });
				return;
			}

			if (typeof onglet === 'undefined' || onglet === '') {

				//Défini l'onglet sur le quel se trouve l'accordion
				if(divId === 'localise' || divId === 'layercontrol' || divId === 'dessin' || divId === 'impconf' || divId === 'inforap') {
					onglet = 'viewer';
				}
				else if (divId === 'fieldManager' || divId === 'etats') {
					onglet = 'data';
				} else{
					//Sinon, on reste sur l'onglet courant
					onglet = '';
				}
			}

			// Va ouvrir un sidebar
			const openSidebar = () => {
				if (onglet === 'agenda' &amp;&amp; divId === 'agenda') {
					// on coupe car le sidebar agenda s'ouvre déjà automatiquement
					return;
				}

				const completeDivId = `${divId}_div`;

				if (ToolsGUI.myAccordion[completeDivId]) {
					layoutManager.showSidebarElement(completeDivId);
				} else {
					layoutManager.log(`Le sidebar avec l'identifiant "${divId}" n'existe pas`, { closeOnClick: true, delay: 10000, useColorScheme: true, type: 'warning', useTitle: false, useCloseButton: false });
					return;
				}
			};

			// Si on est pas sur l'onglet carte
			if (onglet !== '' &amp;&amp; layoutManager.getPanel(onglet) !== null) {
				openSidebar();
			} else {
				layoutManager.openPanel(onglet, openSidebar);
			}
		},

		/**
		 * Exporte la carte au format PNG
		 */
		saveMapAsImg() {
			this.logSaveMap = layoutManager.log('Export de la carte en cours...', {
				type: 'info',
				useColorScheme: true,
			});

			if (layoutManager.getPanel('viewer') === null) {
				// Dans le cas ou est doit ouvrir l'onglet cartes on doit attendrela fin de l'init de open layer
				const next = () => {
					Viewer.cbInitOL.push(Viewer.exportPng);
				};

				layoutManager.openPanel('viewer', next);
			} else {
				Viewer.exportPng();
			}
		},

		/**
		 * Permet l'export KML
		 * 
		 * @param {Array&lt;{table: string, filtre: string}>!} layers Tableau contenant les tables à exporter
		 * @param {String} fileName Nom du fichier
		 * 
		 * @example
		 * isigeoGUI.exportKml(
		 *   [
		 *     { table: "dispositif_last", filtre: "id_unique > 5" },
		 *     { table: "incident", filtre: "id_incident > 10" },
		 *   ],
		 *   'test',
		 * )
		 */
		exportKml(layers, fileName) {
			this.modalExportKML = layoutManager.dialogConfirm("Attention, ce traitement peut prendre plusieurs minutes.", {
				libelleForm: 'Export KML',
				labelAccept: 'Continuer',
				onAccept: () => {
					const log = layoutManager.log('Export KML en cours...', {
						useColorScheme: true,
						type: 'info',
						useTitle: false,
						useCloseButton: false,
					});

					if (isigeoGUI.ar_exportKml &amp;&amp; isigeoGUI.ar_exportKml !== null) {
						isigeoGUI.ar_exportKml.abort();
					}
				
					let param = "cmd=exportKml";
					if (typeof fileName != 'undefined') {
						param += "&amp;output=" + fileName;
					}
				
					if (typeof layers != 'undefined') {
						param += "&amp;layers=" + JSON.stringify(layers);
					}
					
					isigeoGUI.ar_exportKml = $jq.ajax({
						url: "plugins/translate/lib/xhr_exportKml.php",
						method: 'GET',
						data: param,
						success: (result) => {
							log.toast('hide');
							const part = checkAjaxStatus("~", result, this);
							
							if (!part) {
								return false;
							}
							
							if (part[0]!=="") {
								alert(part[0]);
							} else if (!part[1]) {
								alert("Erreur lors de l'export du fichier KML. Assurez-vous d'avoir des objets.");
							} else {
								self.location.href = part[2];
							}
						},
					});
				}
			});
		},
		 /* 
		 * Function exportDoc
		 * 
		 * Export un un ou des documents IsiGéo
		 * le champ destination permet de stocker le resultat dans une fiche isigéo
		 * 
		 * @param {Object} options 
		 * 
		 * options
		 * {
		 * 		layer : 'layername'
		 * 		field : 'document',
		 * 		id : ,
		 * 		destination : 
		 * 			{
		 * 				layer
		 * 				field
		 * 				id			
		 * 				filename
		 * 				sendmail
		 * 			}
		 * 		
		 * }
		 * 
		 */
		exportDoc(options){
			
			let param='cmd=exportDoc&amp;options=' + JSON.stringify(options);
			$jq.ajax({
				url: 'lib/xhr_isigeo.php',
				type: 'POST',
				data: param,
				success: function (r) {
					try{
						var result = JSON.parse(r);
					}catch(e){
						alertify.log('Erreur lors de l\'export de document.', 'error', 10000);
						return false;
					}

					let message = '';

					// Erreur lors de l'export :
					if(typeof result.status =='undefined' || result.status ==false){
						message = 'Erreur lors de l\'export de document. ';
						if(typeof result.message != 'undefined') message += result.message;
						alertify.log(message, 'error', 10000);
						return false;
					}

					// En cas de succès.
					message = 'Export en cours.. ';
					if(typeof result.message != 'undefined' &amp;&amp; result.message !=''){
						message = result.message; 
					}
					alertify.log(message);
				},
				error: function(){
					
				}
			});
		},

		/**
		 * 
		 * Function mergeFic
		 * 
		 * Concatene plusieurs champs de type fic dans une archive ZIP 
		 * Le champ destionation permet de socker le resultat dans un champ fic
		 * 
		 * @param {object} options 
		 * 
		 * options
		 * {
		 * 		layer : 'layername'
		 * 		field : 'fic',
		 * 		filter : "code_insee = '64100'",
		 * 		destination : 
		 * 			{
		 * 				layer
		 * 				field
		 * 				id			
		 * 				filename
		 * 			}
		 * 		
		 * }
		 * 
		 */

		mergeFic(options){
			
			var opt = null; 
			try{
				opt = JSON.stringify(options)
			}catch(e){
				alertify.log("Concatenation des fichiers : erreur lors de la lecture des options", 'error', 10000);
				return false;
			}

			let param = 'cmd=mergeFic&amp;options='+opt;
			
			$jq.ajax({
				url: 'lib/xhr_isigeo.php',
				type: 'POST',
				data: param,
				success: function (r) {
					try{
						var result = JSON.parse(r);
					}catch(e){
						alertify.log('Erreur lors de la concaténation des fichiers.', 'error', 10000);
						return false;
					}

					let message = '';

					// Erreur lors de l'export :
					if(typeof result.status =='undefined' || result.status ==false){
						message = 'Erreur lors de la concaténation des fichiers. ';
						if(typeof result.message != 'undefined') message += result.message;
						alertify.log(message, 'error', 10000);
						return false;
					}

					// En cas de succès.

					message = '';
					if(typeof result.message != 'undefined' &amp;&amp; result.message !=''){
						message = result.message; 
					}
					if(message !=''){
						alertify.log(message,'success');
					}
				},
				error: function(){
					
				}
			})
		}
	};
})();

//Puis on fusion nos deux objets isigeoGUI pour en avoir qu'un seul en mode DESKTOP
//$jq.extend(isigeoGUI, isigeoGUI_app);

//Fonction permettant l'impression et la sauvegarde d'une image de la carte courante en PNG
function printCarteCourante() {
	Viewer.map.once('postcompose', function (event) {
		var canvas = event.context.canvas;
		canvas.toBlob(function (blob) {
			saveAs(blob, 'map.png');
		});
	});
	Viewer.map.renderSync();
}

// Bouton PAMGIS dans le menu comportant une grid avec des shortcuts
function btnPAMGIS() {
	var btnAddPylone =
		'&lt;a style="width:86px;height:87px;" href="javascript:DataGUI.add(\'pam_pylone\');" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/releves/pam/template/shortcut/powerlinepole.png" style="width:30px;">&lt;/div>&lt;p style="white-space: pre-wrap;margin-top:7px;">Pylône&lt;/p> &lt;/a>';

	var btnOuvrage =
		'&lt;a style="width:86px;height:87px;" href="javascript:DataGUI.add(\'ouvrage\');" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/graphics/png/DRAW_POINT.png" style="width:30px;">&lt;/div>&lt;p style="white-space: pre-wrap;margin-top:7px;">Ouvrage&lt;/p> &lt;/a>';

	var btnPointElec =
		'&lt;a style="width:131px;height:86px;" href="javascript:DataGUI.add(\'resistivite_pt_mesure\');" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/releves/pam/template/shortcut/bolt.png" style="width:30px;">&lt;/div>&lt;p style="white-space: pre-wrap;margin-top:7px;">Point de mesure: Résistivité&lt;/p> &lt;/a>';

	var btnAide =
		'&lt;a style="width:86px;height:87px;" href="javascript:DataGUI.add(\'pam_pylone\');" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/images/viewmag.png" style="width:30px;">&lt;/div>&lt;p style="white-space: pre-wrap;margin-top:7px;">Aide&lt;/p> &lt;/a>';

	var btnLocaliser =
		'&lt;a style="width:86px;height:87px;" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/images/help_doc.png" style="width:30px;">&lt;/div>&lt;p style="white-space: pre-wrap;margin-top:7px;">Localiser&lt;/p> &lt;/a>';

	var btnAddPointParticulier =
		'&lt;a style="width:86px;height:87px;" href="javascript:DataGUI.add(\'point_particulier\');" class="btn btn-sq-lg btn-secondary add-margin">&lt;div class="width:30px;height:40px;margin:0 auto;">&lt;img src="https://pamgis.geomatika.fr/etc/icone/information.png" style="width:32px;">&lt;/div>&lt;p style="white-space: pre-wrap;">Point particulier&lt;/p>&lt;/a>';

	var content =
		'&lt;div class="row">&lt;div class="col-lg-12 col-md-12 text-center" style="background:#f1f1f1;">' +
		btnAddPylone +
		btnAddPointParticulier +
		btnOuvrage +
		btnPointElec +
		btnLocaliser +
		btnAide +
		'&lt;/div>&lt;/div>';

	layoutManager.initWindow({
		dialogTitle: 'PAMGIS',
		content: content,
	});
}

function addGPSObject() {
	var param = {
		cmd: 'addGPSObject',
	};

	$jq.ajax({
		url: 'lib/xhr_isigeo.php', // adresse à laquelle la requete est envoyée
		type: 'POST', // type de requete pour récuperer ma donnée
		data: param, // les données dont nous souhaitons renvoyer
		dataType: 'html', // type html
		success: function (res, textStatus, jqXHR) {
			var part = checkAjaxStatus('~', res, this);
			if (!part) {
				return false;
			}

			res = $jq.parseJSON(res);

			var zl = '&lt;select style="margin-left:7px;" id ="layer-gps-add">';

			$jq.each(res, function (i) {
				zl += '&lt;option>' + res[i] + '&lt;/option>';
			});

			zl += '&lt;/select>';
			layoutManager.initWindow({
				dialogTitle: 'Ajout objet GPS',
				content:
					'&lt;div class="col-xs-12 col-sm-12 col-md-12 text-center" style="padding:15px;">Table : ' +
					zl +
					'&lt;/div>&lt;div class="col-xs-12 col-sm-12 col-md-12 text-center" style="padding:15px;"> &lt;button class="btn btn-primary" type="button" style="margin-left:15px;" onclick="isigeoGUI.addObject($jq(\'#layer-gps-add\').val(),true,null,true)">Ajouter objet&lt;/button>&lt;/div>',
			});
		},
	});
}
</code></pre></article></section><footer class="footer" id="PeOAagUepe"><div class="wrapper"><div style="margin-bottom:.5rem">clean-jsdoc-theme</div>Fork: <a href="https://github.com/ankitskvmdam/clean-jsdoc-theme">https://github.com/ankitskvmdam/clean-jsdoc-theme</a></div></footer></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><a href="/" class="sidebar-title sidebar-title-anchor">clean-jsdoc-theme</a><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="9OcM_8dCDCqRPRKceeuUD"><div>Tutorials</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="tutorial-tutoIsigeoLog.html">Utilisation de la fonction isigeoGUI.log</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="lgGw9PfTWgCPVIBbhW-RU"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#activeLayer">activeLayer</a></div><div class="sidebar-section-children"><a href="global.html#addForm">addForm</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#addLayer">addLayer</a></div><div class="sidebar-section-children"><a href="global.html#addLinked">addLinked</a></div><div class="sidebar-section-children"><a href="global.html#changeApp">changeApp</a></div><div class="sidebar-section-children"><a href="global.html#changeMap">changeMap</a></div><div class="sidebar-section-children"><a href="global.html#exportCSVSelection">exportCSVSelection</a></div><div class="sidebar-section-children"><a href="global.html#exportKml">exportKml</a></div><div class="sidebar-section-children"><a href="global.html#exportPng">exportPng</a></div><div class="sidebar-section-children"><a href="global.html#getStrate">getStrate</a></div><div class="sidebar-section-children"><a href="global.html#integrateDXF">integrateDXF</a></div><div class="sidebar-section-children"><a href="global.html#isigeoGUI">isigeoGUI</a></div><div class="sidebar-section-children"><a href="global.html#launchExportSIG">launchExportSIG</a></div><div class="sidebar-section-children"><a href="global.html#launchPHP">launchPHP</a></div><div class="sidebar-section-children"><a href="global.html#launchSQL">launchSQL</a></div><div class="sidebar-section-children"><a href="global.html#log">log</a></div><div class="sidebar-section-children"><a href="global.html#mergeFic">mergeFic</a></div><div class="sidebar-section-children"><a href="global.html#modalAlert">modalAlert</a></div><div class="sidebar-section-children"><a href="global.html#openAccordion">openAccordion</a></div><div class="sidebar-section-children"><a href="global.html#openForm">openForm</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#openIframeDialog">openIframeDialog</a></div><div class="sidebar-section-children"><a href="global.html#openLegend">openLegend</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#openPanel">openPanel</a></div><div class="sidebar-section-children"><a href="global.html#openTB">openTB</a></div><div class="sidebar-section-children"><a href="global.html#printMap">printMap</a></div><div class="sidebar-section-children"><a href="global.html#removeLayer">removeLayer</a></div><div class="sidebar-section-children"><a href="global.html#saveMapAsImg">saveMapAsImg</a></div><div class="sidebar-section-children"><a href="global.html#search">search</a> <code class="sidebar-section-children-tag">externe</code></div><div class="sidebar-section-children"><a href="global.html#setToolBar">setToolBar</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#dark-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>